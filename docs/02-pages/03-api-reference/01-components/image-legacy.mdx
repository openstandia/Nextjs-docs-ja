---
title: '<Image>（レガシー）'
description: 'レガシーなImageコンポーネントによる後方互換性のある画像最適化'
---

<details>
  <summary>例</summary>

- [レガシーなImageコンポーネント](https://github.com/vercel/next.js/tree/canary/examples/image-legacy-component)

</details>

Next.js 13から、`next/image`コンポーネントはパフォーマンスと開発者体験を向上させるために書き換えられました。後方互換性のあるアップグレードソリューションを提供するため、旧`next/image`は`next/legacy/image`に名前が変更されました。

**新しい** [`next/image` APIリファレンス](https://nextjs.org/docs/canary/pages/api-reference/components/image)をご覧ください

## 比較 {#comparison}

`next/legacy/image`と比較して、新しい`next/image`コンポーネントには次の変更があります：

- `<img>`の周りにある`<span>`ラッパーを削除し、[ネイティブの計算されたアスペクト比](https://caniuse.com/mdn-html_elements_img_aspect_ratio_computed_from_attributes)を優先しました
- 標準の`style`プロパティをサポートします
  - `layout`プロパティを削除し、`style`または`className`を優先します
  - `objectFit`プロパティを削除し、`style`または`className`を優先します
  - `objectPosition`プロパティを削除し、`style`または`className`を優先します
- `IntersectionObserver`実装を削除し、[ネイティブの遅延読み込み](https://caniuse.com/loading-lazy-attr)を優先します
  - ネイティブなものがないため、`lazyBoundary`プロパティを削除します
  - ネイティブなものがないため, `lazyRoot`プロパティを削除します
- `loader`構成を削除し、[`loader`](#loader)プロパティを優先します
- `alt`プロパティをオプションから必須に変更しました
- `onLoadingComplete`コールバックを変更して`<img>`要素への参照を受け取るようにしました

## 必須プロパティ {#required-props}

`<Image />` コンポーネントは次のプロパティが必要です。

### src {#src}

次のいずれかでなければなりません：

- [スタティックにインポートされた](https://nextjs.org/docs/canary/pages/building-your-application/optimizing/images#local-images)画像ファイル
- パス文字列。この文字列は、[`loader`](#loader)プロパティや[loader構成](#loader-configuration)に応じて、絶対の外部URLか内部パスのいずれかになります。

デフォルトの[loader](#loader)を使用する場合、ソース画像について次の点も考慮してください：

- srcが外部URLの場合、[remotePatterns](#remote-patterns)を構成する必要があります
- srcが[アニメーションされている](#animated-images)か、既知の形式（JPEG、PNG、WebP、AVIF、GIF、TIFF）でない場合、その画像はそのまま配信されます
- srcがSVG形式である場合、`unoptimized`または`dangerouslyAllowSVG`が有効でない限りブロックされます

### width {#width}

`width`プロパティは、[`layout`](#layout) および [`sizes`](#sizes) プロパティに依存して、描画された幅または元のピクセル幅を表すことができます。

`layout="intrinsic"` または `layout="fixed"` を使用している場合、 `width` プロパティは描画されたピクセルの幅を表し、画像の見え方に影響を与えます。

`layout="responsive"`、`layout="fill"`を使用している場合、`width`プロパティは元のピクセル幅を表し、アスペクト比のみに影響を与えます。

`width` プロパティは必須です。ただし、[スタティックにインポートされた画像](https://nextjs.org/docs/canary/pages/building-your-application/optimizing/images#local-images)か、`layout="fill"`を持つ画像は除きます。

### height {#height}

`height`プロパティは、[`layout`](#layout)および[`sizes`](#sizes)プロパティに依存して、描画された高さまたは元のピクセル高さを表すことができます。

`layout="intrinsic"`または`layout="fixed"`を使用している場合、`height`プロパティは描画されたピクセルの高さを表し、画像の見え方に影響を与えます。

`layout="responsive"`、`layout="fill"`を使用している場合、`height`プロパティは元のピクセル高さを表し、アスペクト比のみに影響を与えます。

`height`プロパティは必須です。ただし、[スタティックにインポートされた画像](https://nextjs.org/docs/canary/pages/building-your-application/optimizing/images#local-images)か、`layout="fill"`を持つ画像は除きます。

## オプションのプロパティ {#optional-props}

`<Image />` コンポーネントは、必須のプロパティ以外にも多くの追加プロパティを受け入れます。このセクションでは、Imageコンポーネントの最も一般的に使用されるプロパティを説明します。あまり使用されないプロパティについては、[高度なプロパティ](#advanced-props)セクションで詳細を確認できます。

### layout {#layout}

ビューポートのサイズが変更されたときの画像のレイアウト動作

| `layout`                 | 動作                                     | `srcSet`                                                                                                    | `sizes` | ラッパーとサイズ調整あり |
| ------------------------ | ---------------------------------------- | ----------------------------------------------------------------------------------------------------------- | ------- | ------------------------ |
| `intrinsic` (デフォルト) | コンテナ幅にフィットするよう縮小         | `1x`, `2x` ([imageSizes](#image-sizes)に基づく)                                                             | N/A     | あり                     |
| `fixed`                  | 正確に `width` と `height` に合わせる    | `1x`, `2x` ([imageSizes](#image-sizes)に基づく)                                                             | N/A     | あり                     |
| `responsive`             | コンテナ幅にフィットするように拡大・縮小 | `640w`, `750w`, ... `2048w`, `3840w` ([imageSizes](#image-sizes)および[deviceSizes](#device-sizes)に基づく) | `100vw` | あり                     |
| `fill`                   | X軸・Y軸の両方でコンテナ全体に成長       | `640w`, `750w`, ... `2048w`, `3840w` ([imageSizes](#image-sizes)および[deviceSizes](#device-sizes)に基づく) | `100vw` | あり                     |

- [`intrinsic`レイアウト（デフォルト）](https://image-legacy-component.nextjs.gallery/layout-intrinsic) をデモ
  - `intrinsic` では、小さいビューポートの場合に画像が縮小されますが、大きいビューポートの場合は元のサイズが維持されます。
- [`fixed`レイアウト](https://image-legacy-component.nextjs.gallery/layout-fixed)をデモ
  - `fixed` の場合、ビューポートが変わっても画像サイズは変更されません（非レスポンシブ）。ネイティブな `img` 要素と同様です。
- [`responsive`レイアウト](https://image-legacy-component.nextjs.gallery/layout-responsive)をデモ
  - `responsive`では、小さいビューポートでは画像が縮小され、大きいビューポートでは拡大されます。
  - 親要素に `display: block` をスタイルシートで指定してください。
- [`fill`レイアウト](https://image-legacy-component.nextjs.gallery/layout-fill)をデモ
  - `fill` の場合、画像は親要素の相対的な設定により、幅と高さが伸縮します。
  - これは通常[`objectFit`](#objectfit)プロパティと一緒に使用されます。
  - 親要素がスタイルシートで `position: relative` を持っていることを確認してください。
- [背景画像のデモ](https://image-legacy-component.nextjs.gallery/background)

### loader {#loader}

URLを解決するために使用されるカスタム関数。Imageコンポーネントにプロパティとしてloaderを設定すると、[`next.config.js`の`images`セクションに定義されたデフォルトのloader](#loader-configuration)が上書きされます。

`loader`は、次のパラメータを与えて画像のURL文字列を返す関数です。

- [`src`](#src)
- [`width`](#width)
- [`quality`](#quality)

以下はカスタムloaderを使用する例です：

```js
import Image from 'next/legacy/image'

const myLoader = ({ src, width, quality }) => {
  return `https://example.com/${src}?w=${width}&q=${quality || 75}`
}

const MyImage = (props) => {
  return (
    <Image
      loader={myLoader}
      src="me.png"
      alt="Picture of the author"
      width={500}
      height={500}
    />
  )
}
```

### sizes {#sizes}

異なるブレークポイントで画像がどのくらいの幅になるのかに関する情報を提供する文字列。`sizes`の値は、`layout="responsive"`または`layout="fill"`を使用する画像のパフォーマンスに大きく影響します。`layout="intrinsic"`または`layout="fixed"`を使用する画像には無視されます。

`sizes`プロパティは画像のパフォーマンスに関連する2つの重要な目的を担っています：

第一に、ブラウザが`next/legacy/image`の自動生成されたソースセットからどのサイズの画像をダウンロードするかを決定するために`sizes`の値が使われます。ブラウザが選択するときには、ページ上の画像のサイズをまだ知りませんので、ビューポートと同じか、それ以上のサイズの画像を選択します。`sizes`プロパティを使うことで、ブラウザに画像が実際には全画面よりも小さいと伝えることができます。`sizes`値を指定しない場合、デフォルト値として`100vw`（全画面幅）が使用されます。

第二に、`sizes`の値は解析され、自動作成されるソースセットの値をトリムするために使用されます。もし`sizes`プロパティがビューポート幅の割合を表す`50vw`のようなサイズを含む場合、ソースセットは必要以上に小さすぎる値を含まないようにトリムされます。

たとえば、スタイリングが画像をモバイルデバイスで全幅、タブレットで2カラムレイアウト、デスクトップディスプレイで3カラムレイアウトにすることがわかっている場合、次のようなsizesプロパティを含めるべきです：

```js
import Image from 'next/legacy/image'
const Example = () => (
  <div className="grid-element">
    <Image
      src="/example.png"
      layout="fill"
      sizes="(max-width: 768px) 100vw,
              (max-width: 1200px) 50vw,
              33vw"
    />
  </div>
)
```

この例の`sizes`は、パフォーマンスメトリクスに劇的な影響を与える可能性があります。`33vw`のサイズなしでは、サーバーから選択される画像は必要なサイズの3倍の幅になり、それによりファイルサイズが幅の2乗に比例するため、ユーザーは必要以上に9倍大きい画像をダウンロードすることになります。

`srcset`と`sizes`についてさらに学ぶ：

- [web.dev](https://web.dev/learn/design/responsive-images/#sizes)
- [mdn](https://developer.mozilla.org/docs/Web/HTML/Element/img#attr-sizes)

### quality {#quality}

最適化された画像の品質。`1`から`100`の間の整数で、`100`が最良の品質です。デフォルトでは`75`です。

### priority {#priority}

`true`の場合、画像は高優先度と見なされ[プリロード](https://web.dev/preload-responsive-images/)されます。`priority`を使用する画像では遅延読み込みが自動的に無効になります。

[Largest Contentful Paint（LCP）](https://nextjs.org/learn/seo/web-performance/lcp)要素として検出されるすべての画像に`priority`プロパティを使用する必要があります。ビューポートサイズが異なるとLCP要素が異なる画像の可能性があるため、複数の優先画像を持つのが適切な場合があります。

画像がファーストビューで表示される場合にのみ使用してください。デフォルトは`false`です。

### placeholder {#placeholder}

画像の読み込み中に使用するプレースホルダー。可能な値は `blur` または `empty` です。デフォルトは `empty` です。

`blur` を選択した場合、[`blurDataURL`](#blurdataurl)プロパティがプレースホルダーとして使用されます。`src` が[スタティックインポート](https://nextjs.org/docs/canary/pages/building-your-application/optimizing/images#local-images)からのオブジェクトで、インポートされた画像が`.jpg`, `.png`, `.webp`, または`.avif`の場合、`blurDataURL`は自動的に生成されます。

動的な画像の場合、[`blurDataURL`](#blurdataurl)プロパティを提供する必要があります。[Plaiceholder](https://github.com/joe-bell/plaiceholder) などのソリューションが`base64`の生成を助けてくれます。

`empty`の場合、画像の読み込み中にはプレースホルダーは存在せず、空のスペースだけが表示されます。

試してみてください：

- [`blur`プレースホルダーをデモ](https://image-legacy-component.nextjs.gallery/placeholder)
- [`blurDataURL`プロパティでのシマー効果をデモ](https://image-legacy-component.nextjs.gallery/shimmer)
- [`blurDataURL`プロパティでのカラー効果をデモ](https://image-legacy-component.nextjs.gallery/color)

## 高度なプロパティ {#advanced-props}

場合によっては、より高度な使い方が必要になります。`<Image />` コンポーネントは、以下の高度なプロパティをオプションで受け入れます。

### style {#style}

基礎となる画像要素に[CSSスタイルを渡す](https://developer.mozilla.org/docs/Web/HTML/Element/style)ことを許可します。

全ての`layout`モードが画像要素に独自のスタイルを適用し、これらの自動スタイルは`style`プロパティよりも優先されることに注意してください。

また、必要な`width`と`height`プロパティはスタイリングと相互作用する可能性があることを念頭に置いてください。スタイリングを使用して画像の`width`を変更する場合は、`height="auto"`スタイルを設定する必要があり、さもなくば画像が歪みます。

### objectFit {#objectfit}

`layout="fill"`を使用する場合に、親コンテナ内に画像がどのようにフィットするかを定義します。

この値は、`src`画像の[object-fit CSSプロパティ](https://developer.mozilla.org/docs/Web/CSS/object-fit)に渡されます。

### objectPosition {#objectposition}

`layout="fill"`を使用する場合に、画像が親要素内でどのように配置されるかを定義します。

この値は、画像に適用される[object-position CSSプロパティ](https://developer.mozilla.org/docs/Web/CSS/object-position)に渡されます。

### onLoadingComplete {#onloadingcomplete}

画像が完全に読み込まれ、[プレースホルダー](#placeholder)が削除された後に呼び出されるコールバック関数。

`onLoadingComplete`関数は、次のプロパティを持つオブジェクトとして受け取る1つのパラメータを許容します：

- [`naturalWidth`](https://developer.mozilla.org/docs/Web/API/HTMLImageElement/naturalWidth)
- [`naturalHeight`](https://developer.mozilla.org/docs/Web/API/HTMLImageElement/naturalHeight)

### loading {#loading}

画像の読み込み動作。デフォルトは`lazy`です。

`lazy`の場合、ビューポートからの計算された距離まで画像の読み込みを遅延させます。

`eager`の場合、すぐに画像を読み込みます。

[詳細はこちらをご覧ください](https://developer.mozilla.org/docs/Web/HTML/Element/img#attr-loading)

### blurDataURL {#blurdataurl}

`src` 画像が正常に読み込まれる前にプレースホルダー画像として使用される[データURL](https://developer.mozilla.org/docs/Web/HTTP/Basics_of_HTTP/Data_URIs)。[`placeholder="blur"`](#placeholder)と組み合わせた場合にのみ効果を発揮します。

base64でエンコードされた画像でなければなりません。それは拡大されてぼやけるので、非常に小さい画像（10px以下）が推奨されます。大きな画像をプレースホルダーとして含めると、アプリケーションのパフォーマンスに悪影響を及ぼす可能性があります。

試してみてください：

- デフォルトの`blurDataURL`プロパティをデモ](https://image-legacy-component.nextjs.gallery/placeholder)
- `blurDataURL`プロパティでのシマー効果をデモ](https://image-legacy-component.nextjs.gallery/shimmer)
- `blurDataURL`プロパティでのカラー効果をデモ](https://image-legacy-component.nextjs.gallery/color)

画像に一致する[単色データURLを生成する](https://png-pixel.com)こともできます。

### lazyBoundary {#lazyboundary}

マージンプロパティと同様の構文を持つ文字列で、画像とビューポートの交差を検出して遅延[読み込み](#loading)をトリガーするために使用される境界ボックスの役割を果たします。デフォルトは`"200px"`です。

画像がルートドキュメント以外のスクロール可能な親要素にネストされている場合、[lazyRoot](#lazyroot)プロパティも割り当てる必要があります。

[詳細はこちらをご覧ください](https://developer.mozilla.org/docs/Web/API/IntersectionObserver/rootMargin)

### lazyRoot {#lazyroot}

スクロール可能な親要素を指すReact [Ref](https://react.dev/learn/referencing-values-with-refs)。 デフォルトは`null`（ドキュメントビューポート）です。

Refは、DOM要素または基になるDOM要素にRefを[転送する](https://react.dev/reference/react/forwardRef)Reactコンポーネントを指している必要があります。

**DOM要素を指す例**

```jsx
import Image from 'next/legacy/image'
import React from 'react'

const Example = () => {
  const lazyRoot = React.useRef(null)

  return (
    <div ref={lazyRoot} style={{ overflowX: 'scroll', width: '500px' }}>
      <Image lazyRoot={lazyRoot} src="/one.jpg" width="500" height="500" />
      <Image lazyRoot={lazyRoot} src="/two.jpg" width="500" height="500" />
    </div>
  )
}
```

**Reactコンポーネントを指す例**

```jsx
import Image from 'next/legacy/image'
import React from 'react'

const Container = React.forwardRef((props, ref) => {
  return (
    <div ref={ref} style={{ overflowX: 'scroll', width: '500px' }}>
      {props.children}
    </div>
  )
})

const Example = () => {
  const lazyRoot = React.useRef(null)

  return (
    <Container ref={lazyRoot}>
      <Image lazyRoot={lazyRoot} src="/one.jpg" width="500" height="500" />
      <Image lazyRoot={lazyRoot} src="/two.jpg" width="500" height="500" />
    </Container>
  )
}
```

[詳細はこちらをご覧ください](https://developer.mozilla.org/docs/Web/API/IntersectionObserver/root)

### unoptimized {#unoptimized}

`true`の場合、ソース画像がそのまま配信され、品質、サイズ、形式の変更は行われません。デフォルトは`false`です。

```js
import Image from 'next/image'

const UnoptimizedImage = (props) => {
  return <Image {...props} unoptimized />
}
```

Next.js 12.3.0以降、このプロパティは次の構成を`next.config.js`で更新することで、すべての画像に割り当てることができます：

```js title="next.config.js"
module.exports = {
  images: {
    unoptimized: true,
  },
}
```

## その他のプロパティ {#other-props}

`<Image />` コンポーネント上の他のプロパティは、次の除外を除外して、基礎となる `img` 要素に渡されます：

- `srcSet`。[デバイスサイズ](#device-sizes)を使用してください
- `ref`。[`onLoadingComplete`](#onloadingcomplete)を使用してください
- `decoding`。常に `"async"` です

## 構成オプション {#configuration-options}

### Remote Patterns {#remote-patterns}

悪意のあるユーザーからアプリケーションを保護するために、外部画像を使用するには構成が必要です。これにより、アカウントからの外部画像のみをNext.js画像最適化APIから配信できるようになります。これらの外部画像は、以下のように、`next.config.js`ファイルの`remotePatterns`プロパティで構成できます：

```js title="next.config.js"
module.exports = {
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: 'example.com',
        port: '',
        pathname: '/account123/**',
        search: '',
      },
    ],
  },
}
```

> **知っておくべきこと**: 上記の例は、`next/legacy/image` の `src` プロパティが `https://example.com/account123/` で始まり、クエリ文字列を含まない必要があることを保証します。他のプロトコル、ホスト名、ポート、または未一致のパスは、400 Bad Requestと応答されます。

以下は、`next.config.js`ファイルの`remotePatterns`プロパティでホスト名にワイルドカードパターンを使用した例です：

```js title="next.config.js"
module.exports = {
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: '**.example.com',
        port: '',
        search: '',
      },
    ],
  },
}
```

> **知っておくべきこと**: 上記の例では、`next/legacy/image` の `src` プロパティが `https://img1.example.com`または`https://me.avatar.example.com`、または任意の数のサブドメインで始まることを保証します。ポートやクエリ文字列を持つことはできません。他のプロトコルや一致しないホスト名は 400 Bad Request として応答します。

ワイルドカードパターンは `pathname` や `hostname` の両方に使用でき、以下の構文を持ちます：

- `*` で単一のパス セグメントまたはサブドメインをマッチ
- `**` で終わりの複数のパス セグメントまたは開始のサブドメインをマッチ

`**` 構文は、パターンの途中で動作しません。

> **知っておくべきこと**: `protocol`、`port`、`pathname`、または `search` を省略する場合、ワイルドカード `**` が暗黙的に含まれます。意図しないURLを悪意のあるアクターが最適化できる可能性があるため、これは推奨されません。

以下は、検索を使用して`next.config.js`ファイルの`remotePatterns`プロパティで作成された例です：

```js title="next.config.js"
module.exports = {
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: 'assets.example.com',
        search: '?v=1727111025337',
      },
    ],
  },
}
```

> **知っておくべきこと**: 上記の例は、`next/legacy/image`の`src`プロパティが`https://assets.example.com`で始まり、正確なクエリ文字列`?v=1727111025337`を持たなければならないことを保証します。他のプロトコルやクエリ文字列は、400 Bad Requestとして応答されます。

### Domains {#domains}

> **警告**: Next.js 14以降では、悪意のあるユーザーからアプリケーションを保護するために、厳密な[`remotePatterns`](#remote-patterns)を推奨します。すべてのコンテンツを提供するドメインを所有する場合にのみ`domains`を使用してください。

[`remotePatterns`](#remote-patterns)と同様に、`domains`構成は外部画像の許可されたホスト名のリストを提供するために使用できます。

ただし、`domains`構成はワイルドカードのパターンマッチングをサポートしておらず、プロトコル、ポート、またはパス名を制限することはできません。

以下は、`next.config.js`ファイルでの`domains`プロパティの例です：

```js title="next.config.js"
module.exports = {
  images: {
    domains: ['assets.acme.com'],
  },
}
```

### Loader Configuration {#loader-configuration}

Next.js組み込みの画像最適化APIを使用せず、クラウドプロバイダを使用して画像を最適化したい場合、`next.config.js`ファイル内で`loader`と`path`プレフィックスを構成できます。これにより、画像の[`src`](#src)に対する相対URLを使用し、プロバイダに対して適切な絶対URLを自動生成することができます。

```js title="next.config.js"
module.exports = {
  images: {
    loader: 'imgix',
    path: 'https://example.com/myaccount/',
  },
}
```

### Built-in Loaders {#built-in-loaders}

次の画像最適化クラウドプロバイダーが含まれています：

- デフォルト: `next dev`、`next start`、またはカスタムサーバーで自動的に動作します
- [Vercel](https://vercel.com): Vercelにデプロイした際に自動的に動作し、設定は不要です。 [詳しくはこちら](https://vercel.com/docs/concepts/image-optimization?utm_source=next-site&utm_medium=docs&utm_campaign=next-website)
- [Imgix](https://www.imgix.com): `loader: 'imgix'`
- [Cloudinary](https://cloudinary.com): `loader: 'cloudinary'`
- [Akamai](https://www.akamai.com): `loader: 'akamai'`
- カスタム: `loader: 'custom'` でカスタムクラウドプロバイダーを実装し、`next/legacy/image`コンポーネントで[`loader`](#loader)プロパティを使用します

別のプロバイダが必要な場合は、`next/legacy/image` の [`loader`](#loader) プロパティを使用できます。

> 画像はビルド時に[`output: 'export'`](https://nextjs.org/docs/canary/pages/building-your-application/deploying/static-exports)を使用して最適化することはできず、オンデマンドでのみ可能です。`next/legacy/image`を`output: 'export'`で使用するには、デフォルト以外のloaderを使用する必要があります。[詳しくは議論をご覧ください](https://github.com/vercel/next.js/discussions/19065)

## 高度な設定 {#advanced}

以下の構成は高度なユースケースに対応し、通常は必要ありません。以下のプロパティを設定することを選択した場合は、今後の更新でNext.jsデフォルトへの変更を上書きすることになります。

### Device Sizes {#device-sizes}

ユーザーの期待されるデバイス幅を知っている場合、`next.config.js`でdeviceWidthsプロパティを使用してデバイス幅のブレークポイントリストを指定できます。これらの幅は、`next/legacy/image`コンポーネントが`layout="responsive"`または`layout="fill"`を使用するときに、ユーザーのデバイスに適した画像が提供されるように使用されます。

構成が提供されていない場合、以下のデフォルトが使用されます。

```js title="next.config.js"
module.exports = {
  images: {
    deviceSizes: [640, 750, 828, 1080, 1200, 1920, 2048, 3840],
  },
}
```

### Image Sizes {#image-sizes}

`next.config.js`ファイルで`images.imageSizes`プロパティを使用して画像の幅リストを指定できます。これらの幅は、[device sizes](#device-sizes)の配列と連結され、画像の[srcset](https://developer.mozilla.org/docs/Web/API/HTMLImageElement/srcset)sを生成するために使用されるサイズの完全な配列を形成します。

2つのリストが別々にある理由は、imageSizes は[`sizes`](#sizes)プロパティを提供する画像にのみ使用されるためで、このプロパティは画像が画面のフル幅以下であることを示しています。**したがって、imageSizesのサイズはdeviceSizes内の最小サイズよりも小さいサイズであるべきです。**

構成が提供されていない場合、以下のデフォルトが使用されます。

```js title="next.config.js"
module.exports = {
  images: {
    imageSizes: [16, 32, 48, 64, 96, 128, 256, 384],
  },
}
```

### Acceptable Formats {#acceptable-formats}

デフォルトの[画像最適化API](#loader-configuration)は、リクエストの`Accept`ヘッダーを介してブラウザがサポートする画像形式を自動的に検出し、最適な出力形式を決定します。

`Accept`ヘッダーが構成された形式の複数と一致する場合、配列内の最初の一致が使用されます。したがって、配列の順序は重要です。一致がない場合（またはソース画像が[アニメーションされている](#animated-images)場合）、画像最適化APIはオリジナル画像の形式にフォールバックします。

構成が提供されていない場合、以下のデフォルトが使用されます。

```js title="next.config.js"
module.exports = {
  images: {
    formats: ['image/webp'],
  },
}
```

以下の構成でAVIFサポートを有効にし、WebPへのフォールバックを維持しました。

```js title="next.config.js"
module.exports = {
  images: {
    formats: ['image/avif', 'image/webp'],
  },
}
```

> **知っておくべきこと**: AVIF は通常、エンコードに50%長い時間がかかりますが、WebPに比べて20%少ないサイズに圧縮されます。これは、画像を初めてリクエストするときに通常は遅くなりますが、その後キャッシュされるリクエストは速くなります。

## キャッシュ動作 {#caching-behavior}

デフォルトの[loader](#loader)のキャッシュアルゴリズムについて以下に説明します。他のすべてのloaderについては、クラウドプロバイダのドキュメントを参照してください。

画像はリクエストごとに動的に最適化され、`<distDir>/cache/images`ディレクトリに保存されます。最適化された画像ファイルは、期限切れになるまでの後続のリクエストへの配信に使用されます。期限切れでもキャッシュに一致するリクエストの場合、期限切れの画像が即座に提供され、バックグラウンドで画像が再度最適化（リバリデーションとも呼ばれます）され、キャッシュに新しい有効期限が保存されます。

画像のキャッシュステータスは、`x-nextjs-cache`（Vercel上でデプロイされた場合は `x-vercel-cache`）応答ヘッダーの値を読み取ることで確認できます。可能な値は次のとおりです：

- `MISS` - パスがキャッシュされていません（最大で一度だけ表示され、最初の訪問で発生します）
- `STALE` - パスがキャッシュに存在するが、再検証の期間を超過したのでバックグラウンドで更新されます
- `HIT` - パスがキャッシュに存在し、再検証の期間を超過していません

有効期限（または実際の最大年齢）は、[`minimumCacheTTL`](#minimum-cache-ttl)構成またはアップストリーム画像の`Cache-Control`ヘッダーのいずれか大きい方によって定義されます。具体的には、`Cache-Control`ヘッダーの`max-age`値が使用されます。`s-maxage`と`max-age`の両方が見つかった場合は、`s-maxage`が優先されます。`max-age`は、CDNやブラウザを含む下流のクライアントにも渡されます。

- アップストリーム画像に`Cache-Control`ヘッダーが含まれていない、または値が非常に低い場合は、[`minimumCacheTTL`](#minimum-cache-ttl)を設定してキャッシュ期間を延ばすことができます
- [`deviceSizes`](#device-sizes)と[`imageSizes`](#image-sizes)を設定して、生成される可能性のある画像の総数を減らすことができます
- 多くの形式ではなく、単一の画像形式を好むように[formats](#acceptable-formats)を設定することができます

### Minimum Cache TTL {#minimum-cache-ttl}

キャッシュされた最適化された画像の存続時間（TTL）を秒単位で設定できます。多くの場合、[スタティック画像のインポート](https://nextjs.org/docs/canary/pages/building-your-application/optimizing/images#local-images)を使用する方が良い結果が得られます。この方法では、ファイルの内容を自動的にハッシュし、`immutable`という`Cache-Control`ヘッダーで画像を永遠にキャッシュします。

```js title="next.config.js"
module.exports = {
  images: {
    minimumCacheTTL: 60,
  },
}
```

最適化された画像の有効期限（または実際の最大有効期間）は、`minimumCacheTTL`またはアップストリーム画像の`Cache-Control`ヘッダーのいずれか大きい方によって定義されます。

画像ごとにキャッシュ動作を変更する必要がある場合、[`headers`](https://nextjs.org/docs/canary/pages/api-reference/config/next-config-js/headers)を構成して、アップストリーム画像上の`Cache-Control`ヘッダー（例：`/some-asset.jpg`、`/_next/image`自体ではありません）を設定できます。

現時点ではキャッシュを無効化するメカニズムは存在しないため、`minimumCacheTTL`を低く保つことが最善です。それ以外の場合は、[`src`](#src)プロパティを手動で変更するか、`<distDir>/cache/images`を削除する必要があるかもしれません。

### Disable Static Imports {#disable-static-imports}

デフォルトの動作では、`import icon from './icon.png'`のようにスタティックファイルをインポートし、それを`src`プロパティに渡すことができます。

場合によっては、インポートが他のプラグインと異なる動作をすることを期待している場合、この機能を無効にすることが考慮されます。

`next.config.js`の内部でスタティック画像インポートを無効にすることができます：

```js title="next.config.js"
module.exports = {
  images: {
    disableStaticImages: true,
  },
}
```

### Dangerously Allow SVG {#dangerously-allow-svg}

さまざまな理由で、デフォルト[loader](#loader)はSVG画像を最適化しません。第一に、SVGはベクター形式であり、損失なくサイズ変更が可能です。第二に、SVGはHTML/CSSと同じ特徴を持ち、適切な[コンテンツセキュリティポリシー（CSP）ヘッダー](https://nextjs.org/docs/app/api-reference/config/next-config-js/headers#content-security-policy)がないと脆弱性を引き起こす可能性があります。

したがって、[`src`](#src)プロパティがSVGであることがわかっている場合は、[`unoptimized`](#unoptimized)プロパティを使用することをお勧めします。`src`が`".svg"`で終わるときは自動で発生します。

ただし、デフォルトの画像最適化APIでSVG画像を提供する必要がある場合、次のように`next.config.js`で`dangerouslyAllowSVG`を設定できます：

```js title="next.config.js"
module.exports = {
  images: {
    dangerouslyAllowSVG: true,
    contentDispositionType: 'attachment',
    contentSecurityPolicy: "default-src 'self'; script-src 'none'; sandbox;",
  },
}
```

さらに、`contentDispositionType`を設定してブラウザが画像を直接表示せずにダウンロードするようにし、画像内のスクリプトが実行されないように`contentSecurityPolicy`を設定することも強く推奨されます。

### `contentDispositionType` {#contentdispositiontype}

デフォルトの[loader](#loader)は、任意のリモート画像を提供できるAPIであるため、保護のために[`Content-Disposition`](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Disposition#as_a_response_header_for_the_main_body)アクセス ヘッダーを`attachment`に設定します。

デフォルト値は`attachment`で、ブラウザが直接訪問したときに画像をダウンロードします。特に[`dangerouslyAllowSVG`](#dangerously-allow-svg)が`true`のときに重要です。

ブラウザが直接訪問したときに画像をレンダリングし、ダウンロードしないようにするために、オプションとして`inline`を設定できます。

```js title="next.config.js"
module.exports = {
  images: {
    contentDispositionType: 'inline',
  },
}
```

### Animated Images {#animated-images}

デフォルトの[loader](#loader)はアニメーション画像を自動的にバイパスし、画像をそのまま配信します。

アニメーションファイルの自動検出はベストエフォートであり、GIF、APNG、そしてWebPをサポートしています。特定のアニメーション画像を明示的に画像最適化からバイパスしたい場合は、[unoptimized](#unoptimized)プロパティを使ってください。

## バージョン履歴 {#version-history}

| バージョン | 変更点                                                |
| ---------- | ----------------------------------------------------- |
| `v13.0.0`  | `next/image`が`next/legacy/image`に名前変更されました |
