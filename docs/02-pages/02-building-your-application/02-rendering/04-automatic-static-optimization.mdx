---
title: '自動静的最適化'
description: 'Next.jsは可能な限りアプリケーションを静的HTMLとして自動的に最適化します。その仕組みをここで学びましょう。'
---

Next.jsは、ページにブロックするデータ要求がない場合、そのページが静的であると自動的に判断します（事前レンダリング可能）。この判断は、そのページに`getServerSideProps`と`getInitialProps`が存在しないことに基づいて行われます。

この機能により、Next.jsは**サーバーレンダリングされたページと静的に生成されたページの両方を含むハイブリッドアプリケーション**を作成できます。

> 静的に生成されたページでもリアクティブです：Next.jsはあなたのアプリケーションをクライアントサイドでハイドレートし、完全なインタラクティビティを提供します。

この機能の主な利点の1つは、最適化されたページにはサーバーサイドでの計算が不要であり、複数のCDNロケーションからエンドユーザーに即座に配信できることです。その結果、ユーザーにとって超高速な読み込み体験が得られます。

## 仕組み {#how-it-works}

ページに`getServerSideProps`または`getInitialProps`が存在する場合、Next.jsはそのページをリクエストごとにオンデマンドでレンダリングします（[サーバーサイドレンダリング](https://nextjs.org/docs/canary/pages/building-your-application/rendering/server-side-rendering)を意味します）。

上記に該当しない場合、Next.jsは自動的にページを静的に最適化し、ページを静的HTMLに事前レンダリングします。

事前レンダリング中、ルーターの`query`オブジェクトは空のままです。このフェーズでは`query`情報を提供することはできません。ハイドレーション後、Next.jsは`query`オブジェクトにルートパラメーターを提供するためにアプリケーションを更新します。

ハイドレーション後にクエリが更新され、もう一度レンダリングがトリガーされるケースは次のとおりです：

- ページが[動的ルート](https://nextjs.org/docs/canary/pages/building-your-application/routing/dynamic-routes)である
- ページにURLにクエリ値がある
- [リライト](https://nextjs.org/docs/canary/pages/api-reference/config/next-config-js/rewrites)が`next.config.js`に設定されている場合。これらはパラメーターを解析して`query`に提供する必要がある可能性があります

クエリが完全に更新されて使用可能であるかどうかを区別するために、[`next/router`](https://nextjs.org/docs/canary/pages/api-reference/functions/use-router#router-object)の`isReady`フィールドを活用できます。

> **Good to know**: [`getStaticProps`](https://nextjs.org/docs/canary/pages/building-your-application/data-fetching/get-static-props)を使用しているページに[動的ルート](https://nextjs.org/docs/canary/pages/building-your-application/routing/dynamic-routes)で追加されたパラメーターは、常に`query`オブジェクト内で利用可能です。

`next build`は静的に最適化されたページのために`.html`ファイルを出力します。たとえば、`pages/about.js`ページの結果は次のようになります：

```bash title="ターミナル"
.next/server/pages/about.html
```

そしてページに`getServerSideProps`を追加すると、次のようにJavaScriptになります：

```bash title="ターミナル"
.next/server/pages/about.js
```

## 注意点 {#caveats}

- `getInitialProps`を持つ[カスタム`App`](https://nextjs.org/docs/canary/pages/building-your-application/routing/custom-app)がある場合、この最適化は[静的生成](https://nextjs.org/docs/canary/pages/building-your-application/data-fetching/get-static-props)のないページでオフになります
- `getInitialProps`を持つ[カスタム`Document`](https://nextjs.org/docs/canary/pages/building-your-application/routing/custom-document)がある場合は、`ctx.req`が定義されているかどうかを確認してからページがサーバーサイドレンダリングされていると想定してください。事前にレンダリングされたページでは `ctx.req` は `undefined` になります。
- ルーターの`isReady`フィールドが`true`になるまで、レンダリングツリーでの[`next/router`](https://nextjs.org/docs/canary/pages/api-reference/functions/use-router#router-object)の`asPath`値の使用を避けてください。静的に最適化されたページはクライアント側でしか`asPath`を知りません。したがって、これをpropとして使用すると不一致エラーが発生する可能性があります。[`active-class-name`の例](https://github.com/vercel/next.js/tree/canary/examples/active-class-name)は、`asPath`をpropとして使用する方法を示しています。
