---
title: 'バージョン12'
description: 'Next.jsアプリケーションをバージョン11からバージョン12にアップグレードします。'
---

バージョン12にアップグレードするには、次のコマンドを実行してください：

```bash title="ターミナル"
npm i next@12 react@17 react-dom@17 eslint-config-next@12
```

```bash title="ターミナル"
yarn add next@12 react@17 react-dom@17 eslint-config-next@12
```

```bash title="ターミナル"
pnpm up next@12 react@17 react-dom@17 eslint-config-next@12
```

```bash title="ターミナル"
bun add next@12 react@17 react-dom@17 eslint-config-next@12
```

> **Good to know:** TypeScriptを使用している場合は、`@types/react`と`@types/react-dom`も対応するバージョンにアップグレードしてください。

### バージョン12.2へのアップグレード {#upgrading-to-12-2}

[Middleware](https://nextjs.org/docs/messages/middleware-upgrade-guide) - `12.2`以前にMiddlewareを使用していた場合、詳細については[アップグレードガイド](https://nextjs.org/docs/messages/middleware-upgrade-guide)を参照してください。

### バージョン12.0へのアップグレード {#upgrading-to-12-0}

[最低限必要なNode.jsバージョン](https://nodejs.org/ja/) - Node.jsの最低バージョンが`12.0.0`から`12.22.0`に引き上げられました。これは、Node.jsの最初のネイティブESモジュールサポートバージョンです。

[最低限必要なReactバージョン](https://react.dev/learn/add-react-to-an-existing-project) - 最低限必要なReactバージョンは`17.0.2`です。アップグレードするには、ターミナルで次のコマンドを実行できます：

```bash title="ターミナル"
npm install react@latest react-dom@latest

yarn add react@latest react-dom@latest

pnpm update react@latest react-dom@latest

bun add react@latest react-dom@latest
```

#### SWCがBabelを置き換える {#swc-replacing-babel}

Next.jsは、JavaScript/TypeScriptをコンパイルするためにRustベースのコンパイラ[SWC](https://swc.rs/)を使用します。この新しいコンパイラは、個別ファイルのコンパイル時にBabelより最大17倍速く、Fast Refreshが最大5倍速くなります。

Next.jsは、[カスタムBabel設定](https://nextjs.org/docs/canary/pages/building-your-application/configuring/babel)を持つアプリケーションとの完全な後方互換性を提供します。Next.jsがデフォルトで扱うすべての変換、styled-jsxや`getStaticProps`/`getStaticPaths`/`getServerSideProps`のtree-shakingのようなものはRustに移植されています。

アプリケーションがカスタムBabel設定を持つ場合、Next.jsは自動的にJavaScript/TypeScriptのコンパイルにSWCの使用をせず、Next.js 11のときに使用されていたBabelに戻ります。

現在カスタムBabel変換を必要とする外部ライブラリとの統合の多くは、近い将来RustベースのSWC変換に移行されます。これには、次のものが含まれますが、これらに限られるわけではありません：

- Styled Components
- Emotion
- Relay

SWCの採用を手助けする変換を優先するために、[このフィードバックスレッド](https://github.com/vercel/next.js/discussions/30174)で`.babelrc`を提供してください。

#### SWCが圧縮のためにTerserを置き換える {#swc-replacing-terser-for-minification}

JavaScriptの圧縮を最大7倍速くするために`next.config.js`にフラグを付けてTerserをSWCに置き換えることができます：

```js title="next.config.js"
module.exports = {
  swcMinify: true,
}
```

SWCを使用した圧縮はオプトインフラグであり、Next.js 12.1でデフォルトになる前に、より多くの実世界のNext.jsアプリケーションでテストされることを保証します。圧縮についてのフィードバックがある場合は、[このフィードバックスレッド](https://github.com/vercel/next.js/discussions/30237)に残してください。

#### styled-jsxのCSS解析の改善 {#improvements-to-styled-jsx-css-parsing}

Rustベースのコンパイラに加えて、新しいCSSパーサーをstyled-jsxのBabel変換で使用しているものに基づいて実装しました。この新しいパーサーはCSSの扱いを改善し、以前は抜けて予期しない動作を引き起こす可能性があった無効なCSSを使用した場合にエラーを返すようになりました。

この変更により、無効なCSSは開発中と`next build`中にエラーをスローします。この変更はstyled-jsxの使用にのみ影響を与えます。

#### `next/image`のラップ要素の変更 {#next-image-changed-wrapping-element}

`next/image`は、`<div>`の代わりに`<span>`内に`<img>`をレンダリングするようになりました。

アプリケーションが`.container span`のようにspanをターゲットにした特定のCSSを持っている場合、Next.js 12へのアップグレードは`<Image>`コンポーネント内のラップ要素に誤ったマッチングを引き起こす可能性があります。これを避けるためには選択子を特定のクラスに制限し、例えば`.container span.item`のようにし、それにそのクラス名を持つように関連コンポーネントを更新することができます<span className="item" />`。

アプリケーションが`<div>`タグで`next/image`を特定のCSSでターゲットにしている場合、例えば`.container div`、それが一致しなくなるかもしれません。選択子を`.container span`に更新することができ、または好ましくは、`<Image>`コンポーネントをラップする新しい`<div className="wrapper">`を追加して、それをターゲットにすることができます `.container .wrapper`。

`className`propは変更されず、基礎となる`<img>`要素に引き渡され続けます。

詳細は[ドキュメント](https://nextjs.org/docs/canary/pages/building-your-application/optimizing/images#styling)をご覧ください。

#### HMR接続が現在WebSocketを使用 {#hmr-connection-now-uses-a-websocket}

以前は、Next.jsは[サーバー送信イベント](https://developer.mozilla.org/ja/docs/Web/API/Server-sent_events)接続を使用してHMRイベントを受信していました。Next.js 12では、現在WebSocket接続を使用しています。

Next.js開発サーバーへのリクエストをプロキシするときのいくつかのケースで、アップグレードリクエストが正しく処理されるようにする必要があります。例えば、`nginx`では、以下の設定を追加する必要があります：

```nginx
location /_next/webpack-hmr {
    proxy_pass http://localhost:3000/_next/webpack-hmr;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}
```

Apache (2.x)を使用している場合、サーバーにWebSocketを有効にするために、以下の設定を追加することができます。ポート、ホスト名、サーバー名を確認してください。

```
<VirtualHost *:443>
 # ServerName yourwebsite.local
 ServerName "${WEBSITE_SERVER_NAME}"
 ProxyPass / http://localhost:3000/
 ProxyPassReverse / http://localhost:3000/
 # Next.js 12 uses websocket
 <Location /_next/webpack-hmr>
    RewriteEngine On
    RewriteCond %{QUERY_STRING} transport=websocket [NC]
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule /(.*) ws://localhost:3000/_next/webpack-hmr/$1 [P,L]
    ProxyPass ws://localhost:3000/_next/webpack-hmr retry=0 timeout=30
    ProxyPassReverse ws://localhost:3000/_next/webpack-hmr
 </Location>
</VirtualHost>
```

`express`のようなカスタムサーバーの場合、例えば次のようにして、リクエストが正しく渡されるように`app.all`を使用する必要があるかもしれません：

```js
app.all('/_next/webpack-hmr', (req, res) => {
  nextjsRequestHandler(req, res)
})
```

#### Webpack 4のサポートが削除されました {#webpack-4-support-has-been-removed}

すでにwebpack 5を使用している場合、このセクションをスキップできます。

Next.jsは、Next.js 11でのコンパイルのデフォルトとしてwebpack 5を採用しました。[Webpack 5への移行ドキュメント](https://nextjs.org/docs/messages/webpack5)でお伝えしているように、Next.js 12ではwebpack 4のサポートが削除されました。

アプリケーションがまだオプトアウトフラグを使用してwebpack 4を使用している場合、[Webpack 5への移行ドキュメント](https://nextjs.org/docs/messages/webpack5)へのリンクを含むエラーが表示されます。

#### `target`オプションの廃止 {#target-option-deprecated}

`next.config.js`に`target`がない場合、このセクションをスキップできます。

`target`オプションは、ページを実行するために必要な依存関係を追跡するための組み込みサポートに取って代わられました。

`next build`中に、Next.jsはページとその依存関係を自動的にトレースし、アプリケーションのプロダクションバージョンをデプロイするために必要なすべてのファイルを決定します。

現在`serverless`に設定されている`target`オプションを使用している場合は、新しい出力の活用方法について[ドキュメント](https://nextjs.org/docs/canary/pages/api-reference/config/next-config-js/output)をお読みください。
