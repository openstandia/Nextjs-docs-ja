---
title: 'Jest設定をNext.jsで行う'
nav_title: 'Jest'
description: 'Next.jsでユニットテストとスナップショットテストのためにJestをセットアップする方法を学びましょう。'
---

{/* このドキュメントの内容は app router と pages router に共通しています。Pages Router 特有の内容を追加するには `<PagesOnly>Content</PagesOnly>` コンポーネントを使用できます。 共通の内容はコンポーネントでラップしてはいけません。 */}

Jest と React Testing Library は、**ユニットテスト**と**スナップショットテスト**でよく一緒に使われます。このガイドでは、Next.jsでJestを設定し、最初のテストを書く方法を示します。

> **Good to know:** `async` Server Components は React エコシステムでは新しいため、Jest は現在これをサポートしていません。同期的な Server および Client Components に対して**ユニットテスト**を実行できますが、`async` コンポーネントには**E2E テスト**を使用することをお勧めします。

## クイックスタート {#quickstart}

Next.js の [with-jest](https://github.com/vercel/next.js/tree/canary/examples/with-jest) 例を使用して、`create-next-app`を使用すると、すぐに開始できます：

```bash title="Terminal"
npx create-next-app@latest --example with-jest with-jest-app
```

## 手動設定 {#manual-setup}

[Next.js 12](https://nextjs.org/blog/next-12) のリリース以降、Next.jsにはJest用の組み込み構成があります。

Jestを設定するには、`jest` と次のパッケージを開発依存関係としてインストールします：

```bash title="Terminal"
npm install -D jest jest-environment-jsdom @testing-library/react @testing-library/dom @testing-library/jest-dom ts-node
# or {#or}
yarn add -D jest jest-environment-jsdom @testing-library/react @testing-library/dom @testing-library/jest-dom ts-node
# or {#or}
pnpm install -D jest jest-environment-jsdom @testing-library/react @testing-library/dom @testing-library/jest-dom ts-node
```

次のコマンドを実行して基本的なJest設定ファイルを生成します：

```bash title="Terminal"
npm init jest@latest
# or {#or}
yarn create jest@latest
# or {#or}
pnpm create jest@latest
```

これにより、プロジェクト用のJestを設定するための一連のプロンプトが表示され、`jest.config.ts|js`ファイルが自動的に作成されます。

構成ファイルを更新して`next/jest`を使用してください。このトランスフォーマーは、JestをNext.jsで動作させるために必要なすべての設定オプションを備えています：

<Tabs>
<TabItem value="ts" label="TypeScript">

```ts title="jest.config.ts" switcher
import type { Config } from 'jest'
import nextJest from 'next/jest.js'

const createJestConfig = nextJest({
  // Next.js アプリへのパスを指定して、next.config.js と .envファイルをテスト環境で読み込みます
  dir: './',
})

// Jest に渡すカスタム構成を追加します
const config: Config = {
  coverageProvider: 'v8',
  testEnvironment: 'jsdom',
  // 各テストが実行される前に設定オプションを追加します
  // setupFilesAfterEnv: ['<rootDir>/jest.setup.ts'],
}

// next/jest が非同期である Next.js 構成をロードできるように、この方法でcreateJestConfigをエクスポートします
export default createJestConfig(config)
```

</TabItem>
<TabItem value="js" label="JavaScript">

```js title="jest.config.js" switcher
const nextJest = require('next/jest')

/** @type {import('jest').Config} */
const createJestConfig = nextJest({
  // Next.js アプリへのパスを指定して、next.config.js と .envファイルをテスト環境で読み込みます
  dir: './',
})

// Jest に渡すカスタム構成を追加します
const config = {
  coverageProvider: 'v8',
  testEnvironment: 'jsdom',
  // 各テストが実行される前に設定オプションを追加します
  // setupFilesAfterEnv: ['<rootDir>/jest.setup.ts'],
}

// next/jest が非同期である Next.js 構成をロードできるように、この方法でcreateJestConfigをエクスポートします
module.exports = createJestConfig(config)
```

</TabItem>
</Tabs>

内部的には、`next/jest` が自動的にJestを設定し、以下のことを行っています：

- [Next.js Compiler](/docs/architecture/nextjs-compiler)を使用して`transform`を設定します
- スタイルシート（`.css`, `.module.css` およびそのscssバリアント）、画像インポート、および[`next/font`](/docs/app/building-your-application/optimizing/fonts)の自動モック。
- `.env`（およびそのバリアントすべて）を`process.env`に読み込む
- テストの解決と変換から`node_modules`を無視する
- テストの解決から `.next` を無視する
- SWC変換を有効にするフラグ用の`next.config.js`をロードする

> **Good to know**: 環境変数を直接テストするには、別のセットアップスクリプトまたは`jest.config.ts`ファイルに手動でロードします。詳細については、[テスト環境変数](/docs/app/building-your-application/configuring/environment-variables#test-environment-variables)を参照してください。

<PagesOnly>

## Jest のセットアップ（Babelを使用） {#setting-up-jest-with-babel}

[Next.js Compiler](/docs/architecture/nextjs-compiler)をオプトアウトしてBabelを使用する場合、上記のパッケージに加え、Jestを手動で設定し、`babel-jest` と `identity-obj-proxy` をインストールする必要があります。

Next.js用のJestを設定するために推奨されるオプションは次のとおりです：

```js title="jest.config.js"
module.exports = {
  collectCoverage: true,
  // Node 14.x の場合、カバレッジプロバイダーの v8 は良い速度と大体良いレポートを提供します
  coverageProvider: 'v8',
  collectCoverageFrom: [
    '**/*.{js,jsx,ts,tsx}',
    '!**/*.d.ts',
    '!**/node_modules/**',
    '!<rootDir>/out/**',
    '!<rootDir>/.next/**',
    '!<rootDir>/*.config.js',
    '!<rootDir>/coverage/**',
  ],
  moduleNameMapper: {
    // CSS のインポートを処理する（CSS モジュールを利用）
    // https://jestjs.io/docs/webpack#mocking-css-modules
    '^.+\\.module\\.(css|sass|scss)$': 'identity-obj-proxy',

    // CSS のインポートを処理する（CSS モジュールを利用しない）
    '^.+\\.(css|sass|scss)$': '<rootDir>/__mocks__/styleMock.js',

    // 画像のインポートを処理する
    // https://jestjs.io/docs/webpack#handling-static-assets
    '^.+\\.(png|jpg|jpeg|gif|webp|avif|ico|bmp|svg)$': `<rootDir>/__mocks__/fileMock.js`,

    // モジュールエイリアスを処理する
    '^@/components/(.*)$': '<rootDir>/components/$1',

    // @next/fontを処理する
    '@next/font/(.*)': `<rootDir>/__mocks__/nextFontMock.js`,
    // next/fontを処理する
    'next/font/(.*)': `<rootDir>/__mocks__/nextFontMock.js`,
    // サーバー専用を無効にする
    'server-only': `<rootDir>/__mocks__/empty.js`,
  },
  // 各テストが実行される前に設定オプションを追加します
  // setupFilesAfterEnv: ['<rootDir>/jest.setup.js'],
  testPathIgnorePatterns: ['<rootDir>/node_modules/', '<rootDir>/.next/'],
  testEnvironment: 'jsdom',
  transform: {
    // next/babel プリセットである babel-jest を使用して、テストをトランスパイルする
    // https://jestjs.io/docs/configuration#transform-objectstring-pathtotransformer--pathtotransformer-object
    '^.+\\.(js|jsx|ts|tsx)$': ['babel-jest', { presets: ['next/babel'] }],
  },
  transformIgnorePatterns: [
    '/node_modules/',
    '^.+\\.module\\.(css|sass|scss)$',
  ],
}
```

各構成オプションに関する詳細情報については、[Jestドキュメント](https://jestjs.io/docs/configuration)を参照してください。また、Next.jsがどのようにJestを設定しているかを確認するために[`next/jest`構成](https://github.com/vercel/next.js/blob/e02fe314dcd0ae614c65b505c6daafbdeebb920e/packages/next/src/build/jest/jest.ts)を確認することもお勧めします。

### スタイルシートと画像のインポートを処理する {#handling-stylesheets-and-image-imports}

スタイルシートと画像はテストで使用されませんが、それをインポートするとエラーが発生する可能性があるため、モックする必要があります。

設定で参照されているモックファイルである `fileMock.js` と `styleMock.js` を `__mocks__` ディレクトリ内に作成します：

```js title="__mocks__/fileMock.js"
module.exports = 'test-file-stub'
```

```js title="__mocks__/styleMock.js"
module.exports = {}
```

静的アセットの処理に関する詳細については、[Jest ドキュメント](https://jestjs.io/docs/webpack#handling-static-assets)を参照してください。

## フォントを処理する {#handling-fonts}

フォントを処理するために、`__mocks__` ディレクトリ内に `nextFontMock.js` ファイルを作成し、次の構成を追加します：

```js title="__mocks__/nextFontMock.js"
module.exports = new Proxy(
  {},
  {
    get: function getter() {
      return () => ({
        className: 'className',
        variable: 'variable',
        style: { fontFamily: 'fontFamily' },
      })
    },
  }
)
```

</PagesOnly>

## 任意：絶対インポートとモジュールパスエイリアスの処理 {#optional-handling-absolute-imports-and-module-path-aliases}

プロジェクトで[モジュールパスエイリアス](/docs/app/building-your-application/configuring/absolute-imports-and-module-aliases)を使用している場合、`jsconfig.json` ファイルのパスオプションと `jest.config.js` ファイルの `moduleNameMapper` オプションを一致させることで、Jestがインポートを解決できるように設定する必要があります。例えば：

```json title="tsconfig.json or jsconfig.json"
{
  "compilerOptions": {
    "module": "esnext",
    "moduleResolution": "bundler",
    "baseUrl": "./",
    "paths": {
      "@/components/*": ["components/*"]
    }
  }
}
```

```js title="jest.config.js"
moduleNameMapper: {
  // ...
  '^@/components/(.*)$': '<rootDir>/components/$1',
}
```

## 任意：カスタムマッチャーでJestを拡張する {#optional-extend-jest-with-custom-matchers}

`@testing-library/jest-dom` には、 `.toBeInTheDocument()` など、テストを簡単にするための便利な[カスタムマッチャー](https://github.com/testing-library/jest-dom#custom-matchers)セットが含まれています。次のオプションをJest設定ファイルに追加することで、すべてのテストにカスタムマッチャーをインポートできます：

<Tabs>
<TabItem value="ts" label="TypeScript">

```ts title="jest.config.ts" switcher
setupFilesAfterEnv: ['<rootDir>/jest.setup.ts']
```

</TabItem>
<TabItem value="js" label="JavaScript">

```js title="jest.config.js" switcher
setupFilesAfterEnv: ['<rootDir>/jest.setup.js']
```

</TabItem>
</Tabs>

その後、`jest.setup`内に次のインポートを追加します：

<Tabs>
<TabItem value="ts" label="TypeScript">

```ts title="jest.setup.ts" switcher
import '@testing-library/jest-dom'
```

</TabItem>
<TabItem value="js" label="JavaScript">

```js title="jest.setup.js" switcher
import '@testing-library/jest-dom'
```

</TabItem>
</Tabs>

> **Good to know:** [`extend-expect` は `v6.0` で削除されました](https://github.com/testing-library/jest-dom/releases/tag/v6.0.0)、そのため、バージョン 6 より前の `@testing-library/jest-dom` を使用している場合は、`@testing-library/jest-dom/extend-expect` をインポートする必要があります。

各テストを開始する前に、さらにセットアップオプションを追加する必要がある場合は、上記の `jest.setup` ファイルに追加できます。

## `package.json` にテストスクリプトを追加する {#add-a-test-script-to-package-json}

最後に、Jestの `test` スクリプトを `package.json` ファイルに追加します：

```json title="package.json" highlight={6-7}
{
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "test": "jest",
    "test:watch": "jest --watch"
  }
}
```

`jest --watch` は、ファイルが変更されたときにテストを再実行します。詳しいJest CLIオプションについては、[Jest ドキュメント](https://jestjs.io/docs/cli#reference)を参照してください。

### 最初のテストを作成する {#creating-your-first-test}

プロジェクトはテストを実行する準備が整いました。プロジェクトのルートディレクトリに `__tests__` というフォルダを作成します。

<PagesOnly>

例えば、`<Home />` コンポーネントが見出しを適切にレンダリングするかどうかを確認するテストを追加できます：

```jsx title="pages/index.js
export default function Home() {
  return <h1>Home</h1>
}
```

```jsx filename="__tests__/index.test.js"
import '@testing-library/jest-dom'
import { render, screen } from '@testing-library/react'
import Home from '../pages/index'

describe('Home', () => {
  it('renders a heading', () => {
    render(<Home />)

    const heading = screen.getByRole('heading', { level: 1 })

    expect(heading).toBeInTheDocument()
  })
})
```

</PagesOnly>

<AppOnly>

例えば、`<Page />` コンポーネントが見出しを適切にレンダリングするかどうかを確認するテストを追加できます：

```jsx title="app/page.js"
import Link from 'next/link'

export default function Page() {
  return (
    <div>
      <h1>Home</h1>
      <Link href="/about">About</Link>
    </div>
  )
}
```

```jsx title="__tests__/page.test.jsx"
import '@testing-library/jest-dom'
import { render, screen } from '@testing-library/react'
import Page from '../app/page'

describe('Page', () => {
  it('renders a heading', () => {
    render(<Page />)

    const heading = screen.getByRole('heading', { level: 1 })

    expect(heading).toBeInTheDocument()
  })
})
```

</AppOnly>

オプションとして、コンポーネントに予期しない変更がないことを確認するために[スナップショットテスト](https://jestjs.io/docs/snapshot-testing)を追加できます：

<PagesOnly>

```jsx title="__tests__/snapshot.js"
import { render } from '@testing-library/react'
import Home from '../pages/index'

it('renders homepage unchanged', () => {
  const { container } = render(<Home />)
  expect(container).toMatchSnapshot()
})
```

> **Good to know**: Test ファイルは Pages Router 内に含めるべきではありません。なぜなら、Pages Router 内のすべてのファイルはルートとして扱われるからです。

</PagesOnly>

<AppOnly>

```jsx title="__tests__/snapshot.js"
import { render } from '@testing-library/react'
import Page from '../app/page'

it('renders homepage unchanged', () => {
  const { container } = render(<Page />)
  expect(container).toMatchSnapshot()
})
```

</AppOnly>

## テストを実行する {#running-your-tests}

その後、次のコマンドを実行してテストを実行します：

```bash title="Terminal"
npm run test
# or {#or}
yarn test
# or {#or}
pnpm test
```

## 追加リソース {#additional-resources}

さらなる情報を得るために、次のリソースが役立ちます：

- [Next.js with Jestの例](https://github.com/vercel/next.js/tree/canary/examples/with-jest)
- [Jest ドキュメント](https://jestjs.io/docs/getting-started)
- [React Testing Library ドキュメント](https://testing-library.com/docs/react-testing-library/intro/)
- [Testing Playground](https://testing-playground.com/) - 良いテストの実践を使用して要素をマッチングします。
