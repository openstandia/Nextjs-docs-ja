---
title: 'マルチゾーン'
description: 'Next.jsのマルチゾーンを使用して、複数のNext.jsアプリを1つのドメインの下にデプロイする方法を学びましょう。'
---

{/* このドキュメントの内容は、app routerとpages routerの間で共有されています。Pages Routerに特定のコンテンツを追加するには、`<PagesOnly>Content</PagesOnly>`コンポーネントを使用できます。共有されるコンテンツはコンポーネントでラップしないでください。 */}

<details open>
  <summary>例</summary>

- [With Zones](https://github.com/vercel/next.js/tree/canary/examples/with-zones)

</details>

マルチゾーンは、大規模なアプリケーションをドメイン上で、パスのセットを提供する小さなNext.jsアプリケーションに分割するマイクロフロントエンドアプローチです。これは、アプリケーション内の他のページと無関係なページ群がある場合に役立ちます。これらのページを別のゾーン（つまり、別のアプリケーション）に移動させることで、各アプリケーションのサイズを減らし、ビルド時間を改善し、特定のゾーンにのみ必要なコードを削除できます。アプリケーションがデカップリングされているので、マルチゾーンはドメイン上の他のアプリケーションが独自のフレームワークを使用することも可能にします。

例えば、次のようなページを分割したいとします：

- 全てのブログ投稿用の`/blog/*`
- ユーザーがダッシュボードにログインしているときの全てのページ用の`/dashboard/*`
- 他のゾーンでカバーされていないウェブサイトの残りの部分用の`/*`

マルチゾーンサポートを使用すると、同じドメインでユーザーに同じように見える3つのアプリケーションを作成し、それぞれを独立して開発・デプロイできます。

<Image
  alt="3つのゾーン：A、B、C。異なるゾーンからのルート間でのハードナビゲーションと、同じゾーン内でのソフトナビゲーションを示しています。"
  srcLight="/docs/light/multi-zones.png"
  srcDark="/docs/dark/multi-zones.png"
  width="1600"
  height="750"
/>

同じゾーン内のページ間をナビゲートする場合、ページを再ロードする必要がないソフトナビゲーションを実行します。例えば、この図では、`/`から`/products`へのナビゲーションはソフトナビゲーションになります。

1つのゾーンから別のゾーンのページに移動する場合、例えば`/`から`/dashboard`などでは、現在のページのリソースをアンロードし、新しいページのリソースをロードするハードナビゲーションが行われます。頻繁に一緒に訪れるページはハードナビゲーションを避けるために同じゾーンに存在するべきです。

## ゾーンを定義する方法

ゾーンは通常のNext.jsアプリケーションであり、他のゾーンのページや静的ファイルとの競合を避けるために、[assetPrefix](/docs/app/api-reference/next-config-js/assetPrefix)を設定する必要があります。

```js title="next.config.js"
/** @type {import('next').NextConfig} */
const nextConfig = {
  assetPrefix: '/blog-static',
}
```

JavaScriptやCSSなどのNext.jsアセットは`assetPrefix`がプレフィックスとして付与され、他のゾーンのアセットと競合しないようにします。これらのアセットはそれぞれのゾーンの`/assetPrefix/_next/...`の下で提供されます。

他の特定のゾーンにルーティングされない全てのパスを処理するデフォルトアプリケーションには、`assetPrefix`は必要ありません。

Next.js 15より古いバージョンでは、静的アセットを処理するための追加のリライトが必要な場合があります。これはNext.js 15では不要です。

```js title="next.config.js"
/** @type {import('next').NextConfig} */
const nextConfig = {
  assetPrefix: '/blog-static',
  async rewrites() {
    return {
      beforeFiles: [
        {
          source: '/blog-static/_next/:path+',
          destination: '/_next/:path+',
        },
      ],
    }
  },
}
```

## リクエストを正しいゾーンにルーティングする方法

マルチゾーンセットアップでは、さまざまなアプリケーションによって提供されるため、パスを正しいゾーンにルーティングする必要があります。これを行うために、任意のHTTPプロキシを使用できますが、Next.jsアプリケーションの1つを使用してドメイン全体のリクエストをルーティングすることもできます。

Next.jsアプリケーションを使用して正しいゾーンにルーティングするには、[`rewrites`](/docs/app/api-reference/next-config-js/rewrites)を使用します。異なるゾーンによって提供される各パスに対して、そのパスを他のゾーンのドメインに送信するリライトルールを追加します。例えば：

```js title="next.config.js"
async rewrites() {
    return [
        {
            source: '/blog',
            destination: `${process.env.BLOG_DOMAIN}/blog`,
        },
        {
            source: '/blog/:path+',
            destination: `${process.env.BLOG_DOMAIN}/blog/:path+`,
        }
    ];
}
```

`destination`は、スキームとドメインを含むゾーンによって提供されるURLである必要があります。これは、ゾーンの本番ドメインを指す必要がありますが、ローカル開発で`localhost`へのリクエストをルーティングするために使用することもできます。

> **Good to know**: URLパスはゾーンに固有であるべきです。例えば、2つのゾーンが`/blog`を提供しようとすると、ルーティングの競合が発生します。

### ミドルウェアを使ったリクエストのルーティング

リクエストの[`rewrites`](/docs/app/api-reference/next-config-js/rewrites)を通じてルーティングすることは、リクエストのレイテンシオーバーヘッドを最小限に抑えるために推奨されますが、ルーティング時に動的な決定が必要な場合にはミドルウェアも使用できます。例えば、マイグレーション中にパスをどこにルーティングするかを決定するための機能フラグを使用している場合には、ミドルウェアを使用することができます。

```js title="middleware.js"
export async function middleware(request) {
  const { pathname, search } = req.nextUrl;
  if (pathname === '/your-path' && myFeaturFlag.isEnabled()) {
    return NextResponse.rewrite(`${rewriteDomain}${pathname}${search});
  }
}
```

## ゾーン間のリンク

異なるゾーンのパスへのリンクは、Next.jsの[`<Link>`](/docs/pages/api-reference/components/link)コンポーネントではなく、`a`タグを使用する必要があります。これは、Next.jsが`<Link>`コンポーネント内の任意の相対パスをプリフェッチしてソフトナビゲーションしようとするためであり、これがゾーンを跨ぐと機能しないためです。

## コードの共有

異なるゾーンを構成するNext.jsアプリケーションは、任意のリポジトリに配置できます。ただし、これらのゾーンを[monorepo](https://en.wikipedia.org/wiki/Monorepo)に配置すると、コードの共有がより容易になります。異なるリポジトリで生活しているゾーンの場合、パブリックまたはプライベートNPMパッケージを通じてコードを共有することもできます。

異なるゾーンで異なるタイミングでリリースされる可能性があるため、機能フラグは異なるゾーン間で一貫して機能を有効または無効にするために有用です。

[Next.js on Vercel](https://vercel.com?utm_source=next-site&utm_medium=docs&utm_campaign=next-website)アプリケーションについては、すべての影響を受けるゾーンを単一の`git push`でデプロイするために[monorepo](https://vercel.com/blog/monorepos-are-changing-how-teams-build-software?utm_source=next-site&utm_medium=docs&utm_campaign=next-website)を使用できます。

<AppOnly>

## Server Actions

マルチゾーンで[Server Actions](/docs/app/building-your-application/data-fetching/server-actions-and-mutations)を使用する場合、ユーザー向けのドメインが複数のアプリケーションを提供する可能性があるため、ユーザー向けのオリジンを明示的に許可する必要があります。`next.config.js`ファイルに以下の行を追加してください。

```js title="next.config.js"
const nextConfig = {
  experimental: {
    serverActions: {
      allowedOrigins: ['your-production-domain.com'],
    },
  },
}
```

詳細は、[`serverActions.allowedOrigins`](/docs/app/api-reference/next-config-js/serverActions#allowedorigins)を参照してください。

</AppOnly>