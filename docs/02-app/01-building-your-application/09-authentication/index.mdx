---
title: 'Authentication'
description: 'Next.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§èªè¨¼ã‚’å®Ÿè£…ã™ã‚‹æ–¹æ³•ã‚’å­¦ã³ã¾ã—ã‚‡ã†ã€‚'
---

èªè¨¼ã‚’ç†è§£ã™ã‚‹ã“ã¨ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿è­·ã™ã‚‹ãŸã‚ã«é‡è¦ã§ã™ã€‚ã“ã®ãƒšãƒ¼ã‚¸ã§ã¯ã€èªè¨¼ã‚’å®Ÿè£…ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã™ã‚‹Reactã¨Next.jsã®æ©Ÿèƒ½ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚

å§‹ã‚ã‚‹å‰ã«ã€ãƒ—ãƒ­ã‚»ã‚¹ã‚’3ã¤ã®æ¦‚å¿µã«åˆ†è§£ã—ã¦ç†è§£ã™ã‚‹ã¨å½¹ç«‹ã¡ã¾ã™ï¼š

1. **[èªè¨¼](#authentication)**ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä¸»å¼µã™ã‚‹é€šã‚Šã®äººç‰©ã§ã‚ã‚‹ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãªã©ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªåˆ†ã®èº«å…ƒã‚’è¨¼æ˜ã™ã‚‹ã“ã¨ã‚’è¦æ±‚ã—ã¾ã™ã€‚
2. **[ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†](#session-management)**ï¼šè¦æ±‚ã”ã¨ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èªè¨¼çŠ¶æ…‹ã‚’è¿½è·¡ã—ã¾ã™ã€‚
3. **[æ‰¿èª](#authorization)**ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã©ã®ãƒ«ãƒ¼ãƒˆã‚„ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‹ã‚’æ±ºå®šã—ã¾ã™ã€‚

ã“ã®å›³ã¯ã€Reactã¨Next.jsã®æ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ãŸèªè¨¼ãƒ•ãƒ­ãƒ¼ã‚’ç¤ºã—ã¦ã„ã¾ã™ï¼š

<Image
  alt="Reactã¨Next.jsã®æ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ãŸèªè¨¼ãƒ•ãƒ­ãƒ¼ã‚’ç¤ºã™å›³"
  srcLight="/docs/light/authentication-overview.png"
  srcDark="/docs/dark/authentication-overview.png"
  width="1600"
  height="1383"
/>

ã“ã®ãƒšãƒ¼ã‚¸ã®ä¾‹ã§ã¯ã€æ•™è‚²ç›®çš„ã®ãŸã‚ã®åŸºæœ¬çš„ãªãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚ã‚«ã‚¹ã‚¿ãƒ èªè¨¼ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ãŒã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ã‚·ãƒ³ãƒ—ãƒ«ã•ã‚’å‘ä¸Šã•ã›ã‚‹ãŸã‚ã«ã€èªè¨¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ä½¿ç”¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚ã“ã‚Œã‚‰ã«ã¯èªè¨¼ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã€æ‰¿èªã®ãŸã‚ã®çµ„ã¿è¾¼ã¿ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ãŒå«ã¾ã‚Œã¦ãŠã‚Šã€ã•ã‚‰ã«ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒ­ã‚°ã‚¤ãƒ³ã€å¤šè¦ç´ èªè¨¼ã€å½¹å‰²ãƒ™ãƒ¼ã‚¹ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ãªã©ã®è¿½åŠ æ©Ÿèƒ½ã‚‚æä¾›ã•ã‚Œã¾ã™ã€‚[èªè¨¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒª](#auth-libraries)ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ãƒªã‚¹ãƒˆã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## èªè¨¼ {#authentication}

<AppOnly>

### æ–°è¦ç™»éŒ²ãƒ»ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ {#sign-up-and-login-functionality}

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³‡æ ¼æƒ…å ±ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ã€ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ¤œè¨¼ã—ã€èªè¨¼ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®APIã¾ãŸã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å‘¼ã³å‡ºã™ãŸã‚ã«ã€Reactã®[`<form>`](https://react.dev/reference/react-dom/components/form)è¦ç´ ã¨[Server Actions](/docs/app/building-your-application/data-fetching/server-actions-and-mutations)ãŠã‚ˆã³`useFormState`ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚

Server Actionsã¯å¸¸ã«ã‚µãƒ¼ãƒãƒ¼ã§å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€èªè¨¼ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®‰å…¨ã«å‡¦ç†ã™ã‚‹ãŸã‚ã®ç’°å¢ƒã‚’æä¾›ã—ã¾ã™ã€‚

æ–°è¦ç™»éŒ²/ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ãŸã‚ã®ã‚¹ãƒ†ãƒƒãƒ—ã¯æ¬¡ã®é€šã‚Šã§ã™ï¼š

#### 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³‡æ ¼æƒ…å ±ã‚’å–å¾—ã™ã‚‹ {#1-capture-user-credentials}

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³‡æ ¼æƒ…å ±ã‚’å–å¾—ã™ã‚‹ã«ã¯ã€é€ä¿¡æ™‚ã«Server Actionã‚’å‘¼ã³å‡ºã™ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã—ã¾ã™ã€‚ä¾‹ãˆã°ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åå‰ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å—ã‘ä»˜ã‘ã‚‹ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãƒ•ã‚©ãƒ¼ãƒ ï¼š

<Tabs>
<TabItem value="tsx" label="TypeScript">

```tsx title="app/ui/signup-form.tsx" switcher
import { signup } from '@/app/actions/auth'

export function SignupForm() {
  return (
    <form action={signup}>
      <div>
        <label htmlFor="name">Name</label>
        <input id="name" name="name" placeholder="Name" />
      </div>
      <div>
        <label htmlFor="email">Email</label>
        <input id="email" name="email" type="email" placeholder="Email" />
      </div>
      <div>
        <label htmlFor="password">Password</label>
        <input id="password" name="password" type="password" />
      </div>
      <button type="submit">Sign Up</button>
    </form>
  )
}
```

</TabItem>
<TabItem value="jsx" label="JavaScript">

```jsx title="app/ui/signup-form.js" switcher
import { signup } from '@/app/actions/auth'

export function SignupForm() {
  return (
    <form action={signup}>
      <div>
        <label htmlFor="name">Name</label>
        <input id="name" name="name" placeholder="Name" />
      </div>
      <div>
        <label htmlFor="email">Email</label>
        <input id="email" name="email" type="email" placeholder="Email" />
      </div>
      <div>
        <label htmlFor="password">Password</label>
        <input id="password" name="password" type="password" />
      </div>
      <button type="submit">Sign Up</button>
    </form>
  )
}
```

</TabItem>
</Tabs>

<Tabs>
<TabItem value="tsx" label="TypeScript">

```tsx title="app/actions/auth.tsx" switcher
export async function signup(formData: FormData) {}
```

</TabItem>
<TabItem value="jsx" label="JavaScript">

```jsx title="app/actions/auth.js" switcher
export async function signup(formData) {}
```

</TabItem>
</Tabs>

#### 2. ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚µãƒ¼ãƒãƒ¼ã§æ¤œè¨¼ã™ã‚‹ {#2-validate-form-fields-on-the-server}

Server Actionã‚’ä½¿ç”¨ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚µãƒ¼ãƒãƒ¼ã§æ¤œè¨¼ã—ã¾ã™ã€‚èªè¨¼ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãŒãƒ•ã‚©ãƒ¼ãƒ æ¤œè¨¼ã‚’æä¾›ã—ã¦ã„ãªã„å ´åˆã€[Zod](https://zod.dev/)ã‚„[Yup](https://github.com/jquense/yup)ã®ã‚ˆã†ãªã‚¹ã‚­ãƒ¼ãƒæ¤œè¨¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚

Zodã‚’ä½¿ç”¨ã™ã‚‹ä¾‹ã¨ã—ã¦ã€é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŒã¤ãƒ•ã‚©ãƒ¼ãƒ ã‚¹ã‚­ãƒ¼ãƒã‚’å®šç¾©ã§ãã¾ã™ï¼š

<Tabs>
<TabItem value="ts" label="TypeScript">

```ts title="app/lib/definitions.ts" switcher
import { z } from 'zod'

export const SignupFormSchema = z.object({
  name: z
    .string()
    .min(2, { message: 'åå‰ã¯å°‘ãªãã¨ã‚‚2æ–‡å­—ã§ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚' })
    .trim(),
  email: z
    .string()
    .email({ message: 'æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚' })
    .trim(),
  password: z
    .string()
    .min(8, { message: 'å°‘ãªãã¨ã‚‚8æ–‡å­—ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚' })
    .regex(/[a-zA-Z]/, { message: 'å°‘ãªãã¨ã‚‚1ã¤ã®æ–‡å­—ã‚’å«ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚' })
    .regex(/[0-9]/, { message: 'å°‘ãªãã¨ã‚‚1ã¤ã®æ•°å­—ã‚’å«ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚' })
    .regex(/[^a-zA-Z0-9]/, {
      message: 'å°‘ãªãã¨ã‚‚1ã¤ã®ç‰¹æ®Šæ–‡å­—ã‚’å«ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚',
    })
    .trim(),
})

export type FormState =
  | {
      errors?: {
        name?: string[]
        email?: string[]
        password?: string[]
      }
      message?: string
    }
  | undefined
```

</TabItem>
<TabItem value="js" label="JavaScript">

```js title="app/lib/definitions.js" switcher
import { z } from 'zod'

export const SignupFormSchema = z.object({
  name: z
    .string()
    .min(2, { message: 'åå‰ã¯å°‘ãªãã¨ã‚‚2æ–‡å­—ã§ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚' })
    .trim(),
  email: z
    .string()
    .email({ message: 'æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚' })
    .trim(),
  password: z
    .string()
    .min(8, { message: 'å°‘ãªãã¨ã‚‚8æ–‡å­—ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚' })
    .regex(/[a-zA-Z]/, { message: 'å°‘ãªãã¨ã‚‚1ã¤ã®æ–‡å­—ã‚’å«ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚' })
    .regex(/[0-9]/, { message: 'å°‘ãªãã¨ã‚‚1ã¤ã®æ•°å­—ã‚’å«ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚' })
    .regex(/[^a-zA-Z0-9]/, {
      message: 'å°‘ãªãã¨ã‚‚1ã¤ã®ç‰¹æ®Šæ–‡å­—ã‚’å«ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚',
    })
    .trim(),
})
```

</TabItem>
</Tabs>

ä¸è¦ãªèªè¨¼ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®APIã‚„ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å‘¼ã³å‡ºã—ã‚’é˜²ããŸã‚ã«ã€å®šç¾©ã•ã‚ŒãŸã‚¹ã‚­ãƒ¼ãƒã«ä¸€è‡´ã—ãªã„ã„ãšã‚Œã‹ã®ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚Œã°ã€Server Actionã§æ—©ã‚ã«`return`ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

<Tabs>
<TabItem value="ts" label="TypeScript">

```ts title="app/actions/auth.ts" switcher
import { SignupFormSchema, FormState } from '@/app/lib/definitions'

export async function signup(state: FormState, formData: FormData) {
  // ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ¤œè¨¼ã™ã‚‹
  const validatedFields = SignupFormSchema.safeParse({
    name: formData.get('name'),
    email: formData.get('email'),
    password: formData.get('password'),
  })

  // ã„ãšã‚Œã‹ã®ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒç„¡åŠ¹ãªå ´åˆã€æ—©æœŸã«çµ‚äº†ã™ã‚‹
  if (!validatedFields.success) {
    return {
      errors: validatedFields.error.flatten().fieldErrors,
    }
  }

  // ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚„ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å‘¼ã³å‡ºã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã™ã‚‹...
}
```

</TabItem>
<TabItem value="js" label="JavaScript">

```js title="app/actions/auth.js" switcher
import { SignupFormSchema } from '@/app/lib/definitions'

export async function signup(state, formData) {
  // ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ¤œè¨¼ã™ã‚‹
  const validatedFields = SignupFormSchema.safeParse({
    name: formData.get('name'),
    email: formData.get('email'),
    password: formData.get('password'),
  })

  // ã„ãšã‚Œã‹ã®ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒç„¡åŠ¹ãªå ´åˆã€æ—©æœŸã«çµ‚äº†ã™ã‚‹
  if (!validatedFields.success) {
    return {
      errors: validatedFields.error.flatten().fieldErrors,
    }
  }

  // ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚„ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å‘¼ã³å‡ºã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã™ã‚‹...
}
```

</TabItem>
</Tabs>

`<SignupForm />`ã«æˆ»ã‚Šã€Reactã®`useFormState`ãƒ•ãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡ä¸­ã«æ¤œè¨¼ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤ºã§ãã¾ã™ï¼š

<Tabs>
<TabItem value="tsx" label="TypeScript">

```tsx title="app/ui/signup-form.tsx" switcher
highlight={7,15,21,27-39}
'use client'

import { useFormState, useFormStatus } from 'react-dom'
import { signup } from '@/app/actions/auth'

export function SignupForm() {
  const [state, action] = useFormState(signup, undefined)

  return (
    <form action={action}>
      <div>
        <label htmlFor="name">Name</label>
        <input id="name" name="name" placeholder="Name" />
      </div>
      {state?.errors?.name && <p>{state.errors.name}</p>}

      <div>
        <label htmlFor="email">Email</label>
        <input id="email" name="email" placeholder="Email" />
      </div>
      {state?.errors?.email && <p>{state.errors.email}</p>}

      <div>
        <label htmlFor="password">Password</label>
        <input id="password" name="password" type="password" />
      </div>
      {state?.errors?.password && (
        <div>
          <p>Password must:</p>
          <ul>
            {state.errors.password.map((error) => (
              <li key={error}>- {error}</li>
            ))}
          </ul>
        </div>
      )}
      <SubmitButton />
    </form>
  )
}

function SubmitButton() {
  const { pending } = useFormStatus()

  return (
    <button disabled={pending} type="submit">
      Sign Up
    </button>
  )
}
```

</TabItem>
<TabItem value="jsx" label="JavaScript">

```jsx title="app/ui/signup-form.js" switcher
highlight={7,15,21,27-39}
'use client'

import { useFormState, useFormStatus } from 'react-dom'
import { signup } from '@/app/actions/auth'

export function SignupForm() {
  const [state, action] = useFormState(signup, undefined)

  return (
    <form action={action}>
      <div>
        <label htmlFor="name">Name</label>
        <input id="name" name="name" placeholder="John Doe" />
      </div>
      {state?.errors?.name && <p>{state.errors.name}</p>}

      <div>
        <label htmlFor="email">Email</label>
        <input id="email" name="email" placeholder="john@example.com" />
      </div>
      {state?.errors?.email && <p>{state.errors.email}</p>}

      <div>
        <label htmlFor="password">Password</label>
        <input id="password" name="password" type="password" />
      </div>
      {state?.errors?.password && (
        <div>
          <p>Password must:</p>
          <ul>
            {state.errors.password.map((error) => (
              <li key={error}>- {error}</li>
            ))}
          </ul>
        </div>
      )}
      <SubmitButton />
    </form>
  )
}

function SubmitButton() {
  const { pending } = useFormStatus()

  return (
    <button disabled={pending} type="submit">
      Sign Up
    </button>
  )
}
```

</TabItem>
</Tabs>

> **Good to know:**
>
> - ã“ã®ä¾‹ã§ã¯Next.js App Routerã«ãƒãƒ³ãƒ‰ãƒ«ã•ã‚Œã¦ã„ã‚‹Reactã®`useFormState`ãƒ•ãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚React 19ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã¯ã€ä»£ã‚ã‚Šã«`useActionState`ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚[React docs](https://react.dev/reference/react/useActionState)ã§è©³ç´°ã‚’ç¢ºèªã§ãã¾ã™ã€‚
> - React 19ã§ã¯ã€`useFormStatus`ã«ã‚ˆã£ã¦è¿”ã•ã‚Œã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã¯ã€dataã€methodã€actionãªã©ã®è¿½åŠ ã‚­ãƒ¼ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚React 19ã‚’ä½¿ç”¨ã—ã¦ã„ãªã„å ´åˆã€`pending`ã‚­ãƒ¼ã®ã¿ãŒåˆ©ç”¨å¯èƒ½ã§ã™ã€‚
> - React 19ã§ã¯ã€`useActionState`ã«ã‚‚è¿”ã•ã‚Œã‚‹çŠ¶æ…‹ã«`pending`ã‚­ãƒ¼ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚
> - ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›´ã‚’è¡Œã†å‰ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹æ¨©é™ãŒã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚[Authenticationã¨Authorization](#authorization)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

#### 3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã¾ãŸã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼è³‡æ ¼æƒ…å ±ã‚’ç¢ºèªã™ã‚‹ {#3-create-a-user-or-check-user-credentials}

ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ¤œè¨¼ã—ãŸå¾Œã€æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹ã‹ã€èªè¨¼ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®APIã‚„ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å‘¼ã³å‡ºã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã§ãã¾ã™ã€‚

å‰ã®ä¾‹ã‹ã‚‰ç¶šã‘ã¦ï¼š

<Tabs>
<TabItem value="tsx" label="TypeScript">

```tsx title="app/actions/auth.tsx" switcher
export async function signup(state: FormState, formData: FormData) {
  // 1. ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ¤œè¨¼ã™ã‚‹
  // ...

  // 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®æŒ¿å…¥ç”¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™ã™ã‚‹
  const { name, email, password } = validatedFields.data
  // ä¾‹ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ä¿å­˜ã™ã‚‹å‰ã«ãƒãƒƒã‚·ãƒ¥åŒ–ã™ã‚‹
  const hashedPassword = await bcrypt.hash(password, 10)

  // 3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æŒ¿å…¥ã™ã‚‹ã‹ã€Auth Libraryã®APIã‚’å‘¼ã³å‡ºã™
  const data = await db
    .insert(users)
    .values({
      name,
      email,
      password: hashedPassword,
    })
    .returning({ id: users.id })

  const user = data[0]

  if (!user) {
    return {
      message: 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚',
    }
  }

  // TODO:
  // 4. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹
  // 5. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹
}
```

</TabItem>
<TabItem value="jsx" label="JavaScript">

```jsx title="app/actions/auth.js" switcher
export async function signup(state, formData) {
  // 1. ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ¤œè¨¼ã™ã‚‹
  // ...

  // 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®æŒ¿å…¥ç”¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™ã™ã‚‹
  const { name, email, password } = validatedFields.data
  // ä¾‹ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ä¿å­˜ã™ã‚‹å‰ã«ãƒãƒƒã‚·ãƒ¥åŒ–ã™ã‚‹
  const hashedPassword = await bcrypt.hash(password, 10)

  // 3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æŒ¿å…¥ã™ã‚‹ã‹ã€Library APIã‚’å‘¼ã³å‡ºã™
  const data = await db
    .insert(users)
    .values({
      name,
      email,
      password: hashedPassword,
    })
    .returning({ id: users.id })

  const user = data[0]

  if (!user) {
    return {
      message: 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚',
    }
  }

  // TODO:
  // 4. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹
  // 5. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹
}
```

</TabItem>
</Tabs>

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä½œæˆã‚„ãƒ¦ãƒ¼ã‚¶ãƒ¼è³‡æ ¼æƒ…å ±ã®ç¢ºèªãŒæˆåŠŸã—ãŸå¾Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èªè¨¼çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®æˆ¦ç•¥ã«ã‚ˆã£ã¦ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯cookieã‚„ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã€ã¾ãŸã¯ãã®ä¸¡æ–¹ã«ä¿å­˜ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚[ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†](#session-management)ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«é€²ã‚“ã§è©³ç´°ã‚’å­¦ã³ã¾ã—ã‚‡ã†ã€‚

> **Tips:**
>
> - ä¸Šè¨˜ã®ä¾‹ã¯ã€æ•™è‚²ç›®çš„ã§èªè¨¼ã‚¹ãƒ†ãƒƒãƒ—ã‚’è©³ç´°ã«èª¬æ˜ã—ã¦ã„ã‚‹ãŸã‚å†—é•·ã§ã™ã€‚ã“ã‚Œã¯ã€ç‹¬è‡ªã®å®‰å…¨ãªã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ãŒè¿…é€Ÿã«è¤‡é›‘ã«ãªã‚‹ã“ã¨ã‚’å¼·èª¿ã—ã¦ã„ã¾ã™ã€‚[Auth Library](#auth-libraries)ã‚’ä½¿ç”¨ã—ã¦ãƒ—ãƒ­ã‚»ã‚¹ã‚’ç°¡ç´ åŒ–ã™ã‚‹ã“ã¨ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚
> - ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã‚’å‘ä¸Šã•ã›ã‚‹ãŸã‚ã«ã€ç™»éŒ²ãƒ•ãƒ­ãƒ¼ã®æ—©ã„æ®µéšã§é‡è¤‡ã™ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚„ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã„ãŸã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ä¾‹ãˆã°ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ä¸­ã¾ãŸã¯å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å¤±ã£ãŸéš›ã«ã€ã“ã‚Œã‚’è¡Œã†ã“ã¨ã§ç„¡é§„ãªãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚’é˜²ãã€å³æ™‚ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æä¾›ã§ãã¾ã™ã€‚[use-debounce](https://www.npmjs.com/package/use-debounce)ã®ã‚ˆã†ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦ã€ã“ã‚Œã‚‰ã®ãƒã‚§ãƒƒã‚¯ã®é »åº¦ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã®ãƒ‡ãƒã‚¦ãƒ³ã‚¹ã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚

</AppOnly>

<PagesOnly>

ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãŠã‚ˆã³/ã¾ãŸã¯ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã‚’å®Ÿè£…ã™ã‚‹ãŸã‚ã®æ‰‹é †ã¯æ¬¡ã®é€šã‚Šã§ã™ï¼š

1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ•ã‚©ãƒ¼ãƒ ã‚’é€šã˜ã¦è³‡æ ¼æƒ…å ±ã‚’å…¥åŠ›ã—ã¾ã™ã€‚
2. ãƒ•ã‚©ãƒ¼ãƒ ã¯APIãƒ«ãƒ¼ãƒˆã«ã‚ˆã£ã¦å‡¦ç†ã•ã‚Œã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã™ã€‚
3. èªè¨¼ãŒæˆåŠŸã—ãŸå ´åˆã€ãƒ—ãƒ­ã‚»ã‚¹ã¯å®Œäº†ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èªè¨¼ãŒæˆåŠŸã—ãŸã“ã¨ã‚’ç¤ºã—ã¾ã™ã€‚
4. èªè¨¼ãŒå¤±æ•—ã—ãŸå ´åˆã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè³‡æ ¼æƒ…å ±ã‚’å…¥åŠ›ã§ãã‚‹ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã‚’è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†ï¼š

<Tabs>
<TabItem value="tsx" label="TypeScript">

```tsx title="pages/login.tsx" switcher
import { FormEvent } from 'react'
import { useRouter } from 'next/router'

export default function LoginPage() {
  const router = useRouter()

  async function handleSubmit(event: FormEvent<HTMLFormElement>) {
    event.preventDefault()

    const formData = new FormData(event.currentTarget)
    const email = formData.get('email')
    const password = formData.get('password')

    const response = await fetch('/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password }),
    })

    if (response.ok) {
      router.push('/profile')
    } else {
      // ã‚¨ãƒ©ãƒ¼ã‚’å‡¦ç†ã™ã‚‹
    }
  }

  return (
    <form onSubmit={handleSubmit}>
      <input type="email" name="email" placeholder="Email" required />
      <input type="password" name="password" placeholder="Password" required />
      <button type="submit">Login</button>
    </form>
  )
}
```

</TabItem>
<TabItem value="jsx" label="JavaScript">

```jsx title="pages/login.jsx" switcher
import { FormEvent } from 'react'
import { useRouter } from 'next/router'

export default function LoginPage() {
  const router = useRouter()

  async function handleSubmit(event) {
    event.preventDefault()

    const formData = new FormData(event.currentTarget)
    const email = formData.get('email')
    const password = formData.get('password')

    const response = await fetch('/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password }),
    })

    if (response.ok) {
      router.push('/profile')
    } else {
      // ã‚¨ãƒ©ãƒ¼ã‚’å‡¦ç†ã™ã‚‹
    }
  }

  return (
    <form onSubmit={handleSubmit}>
      <input type="email" name="email" placeholder="Email" required />
      <input type="password" name="password" placeholder="Password" required />
      <button type="submit">Login</button>
    </form>
  )
}
```

</TabItem>
</Tabs>

ä¸Šè¨˜ã®ãƒ•ã‚©ãƒ¼ãƒ ã«ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã™ã‚‹ãŸã‚ã®2ã¤ã®å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚Šã¾ã™ã€‚é€ä¿¡æ™‚ã«ã€`/api/auth/login`ã¨ã„ã†APIãƒ«ãƒ¼ãƒˆã«POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹é–¢æ•°ã‚’ãƒˆãƒªã‚¬ãƒ¼ã—ã¾ã™ã€‚

æ¬¡ã«ã€APIãƒ«ãƒ¼ãƒˆã§èªè¨¼ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®APIã‚’å‘¼ã³å‡ºã—ã¦èªè¨¼ã‚’å‡¦ç†ã§ãã¾ã™ï¼š

<Tabs>
<TabItem value="ts" label="TypeScript">

```ts title="pages/api/auth/login.ts" switcher
import type { NextApiRequest, NextApiResponse } from 'next'
import { signIn } from '@/auth'

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  try {
    const { email, password } = req.body
    await signIn('credentials', { email, password })

    res.status(200).json({ success: true })
  } catch (error) {
    if (error.type === 'CredentialsSignin') {
      res.status(401).json({ error: 'Invalid credentials.' })
    } else {
      res.status(500).json({ error: 'Something went wrong.' })
    }
  }
}
```

</TabItem>
<TabItem value="js" label="JavaScript">

```js title="pages/api/auth/login.js" switcher
import { signIn } from '@/auth'

export default async function handler(req, res) {
  try {
    const { email, password } = req.body
    await signIn('credentials', { email, password })

    res.status(200).json({ success: true })
  } catch (error) {
    if (error.type === 'CredentialsSignin') {
      res.status(401).json({ error: 'Invalid credentials.' })
    } else {
      res.status(500).json({ error: 'Something went wrong.' })
    }
  }
}
```

</TabItem>
</Tabs>

</PagesOnly>

## ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç† {#session-management}

ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã¯ã€è¦æ±‚ã”ã¨ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èªè¨¼çŠ¶æ…‹ã‚’ç¶­æŒã™ã‚‹ãŸã‚ã«é‡è¦ã§ã™ã€‚ã“ã‚Œã«ã¯ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚„ãƒˆãƒ¼ã‚¯ãƒ³ã®ä½œæˆã€ä¿å­˜ã€æ›´æ–°ã€å‰Šé™¤ãŒå«ã¾ã‚Œã¾ã™ã€‚

ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã¯2ã¤ã®ã‚¿ã‚¤ãƒ—ãŒã‚ã‚Šã¾ã™ï¼š

1. [**ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹**](#stateless-sessions)ï¼šã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ï¼ˆã¾ãŸã¯ãƒˆãƒ¼ã‚¯ãƒ³ï¼‰ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®cookieã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚cookieã¯å„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨å…±ã«é€ä¿¡ã•ã‚Œã€ã‚µãƒ¼ãƒãƒ¼ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ç¢ºèªãŒè¡Œã‚ã‚Œã¾ã™ã€‚ã“ã®æ–¹æ³•ã¯ã‚·ãƒ³ãƒ—ãƒ«ã§ã™ãŒã€æ­£ã—ãå®Ÿè£…ã—ãªã„ã¨ã‚»ã‚­ãƒ¥ã‚¢ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
2. [**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**](#database-sessions)ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ã¯æš—å·åŒ–ã•ã‚ŒãŸã‚»ãƒƒã‚·ãƒ§ãƒ³IDã®ã¿ãŒé€ä¿¡ã•ã‚Œã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ã“ã®æ–¹æ³•ã¯ã‚ˆã‚Šã‚»ã‚­ãƒ¥ã‚¢ã§ã™ãŒã€è¤‡é›‘ã§ã‚µãƒ¼ãƒãƒ¼ãƒªã‚½ãƒ¼ã‚¹ã‚’å¤šãæ¶ˆè²»ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

> **Good to know:** ã„ãšã‚Œã‹ã®æ–¹æ³•ã€ã¾ãŸã¯ä¸¡æ–¹ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ãŒã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€ä¾‹ãˆã°[iron-session](https://github.com/vvo/iron-session)ã‚„[Jose](https://github.com/panva/jose)ã®ä½¿ç”¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚

### ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³ {#stateless-sessions}

<AppOnly>

ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¦ç®¡ç†ã™ã‚‹ãŸã‚ã«ã€ä»¥ä¸‹ã®ã‚¹ãƒ†ãƒƒãƒ—ã«å¾“ã†å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š

1. ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ç½²åã«ä½¿ç”¨ã™ã‚‹ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ã‚’ç”Ÿæˆã—ã€ãã‚Œã‚’[ç’°å¢ƒå¤‰æ•°](/docs/app/building-your-application/configuring/environment-variables)ã¨ã—ã¦ä¿å­˜ã—ã¾ã™ã€‚
2. ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’æš—å·åŒ–/å¾©å·ã—ã¾ã™ã€‚
3. Next.jsã®[`cookie`](/docs/app/api-reference/functions/cookies) APIã‚’ä½¿ç”¨ã—ã¦cookieã‚’ç®¡ç†ã—ã¾ã™ã€‚

ä¸Šè¨˜ã«åŠ ãˆã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«æˆ»ã£ãŸã¨ãã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’[æ›´æ–°ï¼ˆãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ï¼‰](#updating-or-refreshing-sessions)ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ãŸã¨ãã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’[å‰Šé™¤](#deleting-the-session)ã™ã‚‹æ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚

> **Good to know:** ä½¿ç”¨ã—ã¦ã„ã‚‹[èªè¨¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒª](#auth-libraries)ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚

#### 1. ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ã®ç”Ÿæˆ {#1-generating-a-secret-key}

ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç½²åã™ã‚‹ãŸã‚ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ã‚’ç”Ÿæˆã™ã‚‹æ–¹æ³•ã¯ã„ãã¤ã‹ã‚ã‚Šã¾ã™ã€‚ä¾‹ãˆã°ã€ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§`openssl`ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š

```bash title="terminal"
openssl rand -base64 32
```

ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ã€ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ã¨ã—ã¦ä½¿ç”¨ã§ãã‚‹32æ–‡å­—ã®ãƒ©ãƒ³ãƒ€ãƒ ãªæ–‡å­—åˆ—ã‚’ç”Ÿæˆã—ã€[ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«](/docs/app/building-your-application/configuring/environment-variables)ã«ä¿å­˜ã—ã¾ã™ï¼š

```bash title=".env"
SESSION_SECRET=your_secret_key
```

æ¬¡ã«ã€ã“ã®ã‚­ãƒ¼ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯ã§å‚ç…§ã—ã¾ã™ï¼š

```js title="app/lib/session.js"
const secretKey = process.env.SESSION_SECRET
```

#### 2. ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æš—å·åŒ–ãƒ»å¾©å·åŒ– {#2-encrypting-and-decrypting-sessions}

æ¬¡ã«ã€å¥½ã¿ã®[ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ãƒ©ã‚¤ãƒ–ãƒ©ãƒª](#session-management-libraries)ã‚’ä½¿ç”¨ã—ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æš—å·åŒ–ãƒ»å¾©å·åŒ–ã§ãã¾ã™ã€‚å‰ã®ä¾‹ã‹ã‚‰ç¶šã‘ã¦ã€[Jose](https://www.npmjs.com/package/jose)ï¼ˆ[Edge Runtime](/docs/app/building-your-application/rendering/edge-and-nodejs-runtimes)äº’æ›ï¼‰ã¨Reactã®[`server-only`](https://www.npmjs.com/package/server-only)ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ã¦ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯ãŒã‚µãƒ¼ãƒãƒ¼ã§ã®ã¿å®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

<Tabs>
<TabItem value="tsx" label="TypeScript">

```tsx title="app/lib/session.ts" switcher
import 'server-only'
import { SignJWT, jwtVerify } from 'jose'
import { SessionPayload } from '@/app/lib/definitions'

const secretKey = process.env.SESSION_SECRET
const encodedKey = new TextEncoder().encode(secretKey)

export async function encrypt(payload: SessionPayload) {
  return new SignJWT(payload)
    .setProtectedHeader({ alg: 'HS256' })
    .setIssuedAt()
    .setExpirationTime('7d')
    .sign(encodedKey)
}

export async function decrypt(session: string | undefined = '') {
  try {
    const { payload } = await jwtVerify(session, encodedKey, {
      algorithms: ['HS256'],
    })
    return payload
  } catch (error) {
    console.log('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ')
  }
}
```

</TabItem>
<TabItem value="jsx" label="JavaScript">

```jsx title="app/lib/session.js" switcher
import 'server-only'
import { SignJWT, jwtVerify } from 'jose'

const secretKey = process.env.SESSION_SECRET
const encodedKey = new TextEncoder().encode(secretKey)

export async function encrypt(payload) {
  return new SignJWT(payload)
    .setProtectedHeader({ alg: 'HS256' })
    .setIssuedAt()
    .setExpirationTime('7d')
    .sign(encodedKey)
}

export async function decrypt(session) {
  try {
    const { payload } = await jwtVerify(session, encodedKey, {
      algorithms: ['HS256'],
    })
    return payload
  } catch (error) {
    console.log('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ')
  }
}
```

</TabItem>
</Tabs>

> **Tips**:
>
> - ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã«ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®IDã‚„å½¹å‰²ãªã©ã€ä»¥å¾Œã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ä½¿ç”¨ã™ã‚‹æœ€å°é™ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚é›»è©±ç•ªå·ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰æƒ…å ±ãªã©ã®å€‹äººã‚’ç‰¹å®šã§ãã‚‹æƒ…å ±ã‚„ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãªã©ã®æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ã‚’å«ã‚“ã§ã¯ã„ã‘ã¾ã›ã‚“ã€‚

#### 3. Cookieã®è¨­å®šï¼ˆæ¨å¥¨ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ {#3-setting-cookies-recommended-options}

ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’cookieã«ä¿å­˜ã™ã‚‹ã«ã¯ã€Next.jsã®[`cookies`](/docs/app/api-reference/functions/cookies) APIã‚’ä½¿ç”¨ã—ã¾ã™ã€‚cookieã¯ã‚µãƒ¼ãƒãƒ¼ä¸Šã§è¨­å®šã•ã‚Œã€æ¨å¥¨ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š

- **HttpOnly**ï¼šã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®JavaScriptã‹ã‚‰cookieã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’ç¦æ­¢ã—ã¾ã™ã€‚
- **Secure**ï¼šhttpsã‚’ä½¿ç”¨ã—ã¦cookieã‚’é€ä¿¡ã—ã¾ã™ã€‚
- **SameSite**ï¼šcookieãŒã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨å…±ã«é€ä¿¡ã•ã‚Œã‚‹ã‹ã©ã†ã‹ã‚’æŒ‡å®šã—ã¾ã™ã€‚
- **Max-Ageã¾ãŸã¯Expires**ï¼šç‰¹å®šã®æœŸé–“å¾Œã«cookieã‚’å‰Šé™¤ã—ã¾ã™ã€‚
- **Path**ï¼šcookieã®URLãƒ‘ã‚¹ã‚’å®šç¾©ã—ã¾ã™ã€‚

å„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«ã¤ã„ã¦ã®è©³ç´°æƒ…å ±ã¯[MDN](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

<Tabs>
<TabItem value="ts" label="TypeScript">

```ts title="app/lib/session.ts" switcher
import 'server-only'
import { cookies } from 'next/headers'

export async function createSession(userId: string) {
  const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)
  const session = await encrypt({ userId, expiresAt })

  const cookieStore = await cookies()
  cookieStore.set('session', session, {
    httpOnly: true,
    secure: true,
    expires: expiresAt,
    sameSite: 'lax',
    path: '/',
  })
}
```

</TabItem>
<TabItem value="js" label="JavaScript">

```js title="app/lib/session.js" switcher
import 'server-only'
import { cookies } from 'next/headers'

export async function createSession(userId) {
  const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)
  const session = await encrypt({ userId, expiresAt })
  const cookieStore = await cookies()

  cookieStore.set('session', session, {
    httpOnly: true,
    secure: true,
    expires: expiresAt,
    sameSite: 'lax',
    path: '/',
  })
}
```

</TabItem>
</Tabs>

ã‚µãƒ¼ãƒãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«æˆ»ã‚Šã€`createSession()`é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã€[`redirect()`](/docs/app/building-your-application/routing/redirecting) APIã‚’ä½¿ç”¨ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é©åˆ‡ãªãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã§ãã¾ã™ï¼š

<Tabs>
<TabItem value="ts" label="TypeScript">

```ts title="app/actions/auth.ts" switcher
import { createSession } from '@/app/lib/session'

export async function signup(state: FormState, formData: FormData) {
  // ä»¥å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼š
  // 1. ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ¤œè¨¼ã™ã‚‹
  // 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®æŒ¿å…¥ç”¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™ã™ã‚‹
  // 3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æŒ¿å…¥ã™ã‚‹ã‹ã€Library APIã‚’å‘¼ã³å‡ºã™

  // ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼š
  // 4. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹
  await createSession(user.id)
  // 5. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹
  redirect('/profile')
}
```

</TabItem>
<TabItem value="js" label="JavaScript">

```js title="app/actions/auth.js" switcher
import { createSession } from '@/app/lib/session'

export async function signup(state, formData) {
  // ä»¥å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼š
  // 1. ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ¤œè¨¼ã™ã‚‹
  // 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®æŒ¿å…¥ç”¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™ã™ã‚‹
  // 3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æŒ¿å…¥ã™ã‚‹ã‹ã€Library APIã‚’å‘¼ã³å‡ºã™

  // ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼š
  // 4. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹
  await createSession(user.id)
  // 5. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹
  redirect('/profile')
}
```

</TabItem>
</Tabs>

> **Tips**:
>
> - **cookieã¯ã‚µãƒ¼ãƒãƒ¼ä¸Šã§è¨­å®šã•ã‚Œã‚‹ã¹ã**ã§ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã®æ”¹ã–ã‚“ã‚’é˜²ããŸã‚ã§ã™ã€‚
> - ğŸ¥ è¦–è´: Next.jsã§ã®ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¨èªè¨¼ã«ã¤ã„ã¦ã•ã‚‰ã«å­¦ã¶ â†’ [YouTube (11åˆ†)](https://www.youtube.com/watch?v=DJvM2lSPn6w).

#### ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æ›´æ–°ï¼ˆã¾ãŸã¯ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ï¼‰ {#updating-or-refreshing-sessions}

ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æœ‰åŠ¹æœŸé™ã‚’å»¶ã°ã™ã“ã¨ã‚‚ã§ãã¾ã™ã€‚ã“ã‚Œã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«å†ã³ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã¨ãã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã—ãŸã¾ã¾ã«ã—ã¦ãŠãã®ã«å½¹ç«‹ã¡ã¾ã™ã€‚ä¾‹ãˆã°ï¼š

<Tabs>
<TabItem value="ts" label="TypeScript">

```ts title="app/lib/session.ts" switcher
import 'server-only'
import { cookies } from 'next/headers'
import { decrypt } from '@/app/lib/session'

export async function updateSession() {
  const session = (await cookies()).get('session')?.value
  const payload = await decrypt(session)

  if (!session || !payload) {
    return null
  }

  const expires = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)

  const cookieStore = await cookies()
  cookieStore.set('session', session, {
    httpOnly: true,
    secure: true,
    expires: expires,
    sameSite: 'lax',
    path: '/',
  })
}
```

</TabItem>
<TabItem value="js" label="JavaScript">

```js title="app/lib/session.js" switcher
import 'server-only'
import { cookies } from 'next/headers'
import { decrypt } from '@/app/lib/session'

export async function updateSession() {
  const session = (await cookies()).get('session')?.value
  const payload = await decrypt(session)

  if (!session || !payload) {
    return null
  }

  const expires = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)(
    await cookies()
  ).set('session', session, {
    httpOnly: true,
    secure: true,
    expires: expires,
    sameSite: 'lax',
    path: '/',
  })
}
```

</TabItem>
</Tabs>

> **Tip:** èªè¨¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å»¶é•·ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

#### ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å‰Šé™¤ {#deleting-the-session}

ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã™ã‚‹ã«ã¯ã€cookieã‚’å‰Šé™¤ã—ã¾ã™ï¼š

<Tabs>
<TabItem value="ts" label="TypeScript">

```ts title="app/lib/session.ts" switcher
import 'server-only'
import { cookies } from 'next/headers'

export async function deleteSession() {
  const cookieStore = await cookies()
  cookieStore.delete('session')
}
```

</TabItem>
<TabItem value="js" label="JavaScript">

```js title="app/lib/session.js" switcher
import 'server-only'
import { cookies } from 'next/headers'

export async function deleteSession() {
  const cookieStore = await cookies()
  cookieStore.delete('session')
}
```

</TabItem>
</Tabs>

æ¬¡ã«`deleteSession()`é–¢æ•°ã‚’ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†…ã§å†åˆ©ç”¨ã§ãã¾ã™ã€‚ä¾‹ãˆã°ã€ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ™‚ã«ï¼š

<Tabs>
<TabItem value="ts" label="TypeScript">

```ts title="app/actions/auth.ts" switcher
import { cookies } from 'next/headers'
import { deleteSession } from '@/app/lib/session'

export async function logout() {
  deleteSession()
  redirect('/login')
}
```

</TabItem>
<TabItem value="js" label="JavaScript">

```js title="app/actions/auth.js" switcher
import { cookies } from 'next/headers'
import { deleteSession } from '@/app/lib/session'

export async function logout() {
  deleteSession()
  redirect('/login')
}
```

</TabItem>
</Tabs>

</AppOnly>

<PagesOnly>

#### Cookieã®è¨­å®šã¨å‰Šé™¤ {#setting-and-deleting-cookies}

[API Routes](https://nextjs.org/docs/canary/pages/building-your-application/routing/api-routes)ã‚’ä½¿ç”¨ã—ã¦ã€ã‚µãƒ¼ãƒãƒ¼ä¸Šã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’cookieã¨ã—ã¦è¨­å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š

<Tabs>
<TabItem value="ts" label="TypeScript">

```ts title="pages/api/login.ts" switcher
import { serialize } from 'cookie'
import type { NextApiRequest, NextApiResponse } from 'next'
import { encrypt } from '@/app/lib/session'

export default function handler(req: NextApiRequest, res: NextApiResponse) {
  const sessionData = req.body
  const encryptedSessionData = encrypt(sessionData)

  const cookie = serialize('session', encryptedSessionData, {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    maxAge: 60 * 60 * 24 * 7, // 1é€±é–“
    path: '/',
  })
  res.setHeader('Set-Cookie', cookie)
  res.status(200).json({ message: 'cookieã‚’æ­£å¸¸ã«è¨­å®šã—ã¾ã—ãŸï¼' })
}
```

</TabItem>
<TabItem value="js" label="JavaScript">

```js title="pages/api/login.js" switcher
import { serialize } from 'cookie'
import { encrypt } from '@/app/lib/session'

export default function handler(req, res) {
  const sessionData = req.body
  const encryptedSessionData = encrypt(sessionData)

  const cookie = serialize('session', encryptedSessionData, {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    maxAge: 60 * 60 * 24 * 7, // 1é€±é–“
    path: '/',
  })
  res.setHeader('Set-Cookie', cookie)
  res.status(200).json({ message: 'cookieã‚’æ­£å¸¸ã«è¨­å®šã—ã¾ã—ãŸï¼' })
}
```

</TabItem>
</Tabs>

</PagesOnly>

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³ {#database-sessions}

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¦ç®¡ç†ã™ã‚‹ãŸã‚ã«ã€æ¬¡ã®æ‰‹é †ã«å¾“ã„ã¾ã™ï¼š

1. ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¨ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä½œæˆã—ã¾ã™ï¼ˆã¾ãŸã¯Auth LibraryãŒã“ã‚Œã‚’å‡¦ç†ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ï¼‰ã€‚
2. ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æŒ¿å…¥ã€æ›´æ–°ã€å‰Šé™¤ã™ã‚‹æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ã€‚
3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã‚‹å‰ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’æš—å·åŒ–ã—ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨cookieã®åŒæœŸã‚’ç¢ºä¿ã—ã¾ã™ï¼ˆã“ã‚Œã¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã™ãŒã€[ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢](#optimistic-checks-with-middleware-optional)ã§ã®æ¥½è¦³çš„ãªèªè¨¼ãƒã‚§ãƒƒã‚¯ã®ãŸã‚ã«æ¨å¥¨ã•ã‚Œã¾ã™ï¼‰ã€‚

<AppOnly>

ä¾‹ãˆã°ï¼š

<Tabs>
<TabItem value="ts" label="TypeScript">

```ts title="app/lib/session.ts" switcher
import cookies from 'next/headers'
import { db } from '@/app/lib/db'
import { encrypt } from '@/app/lib/session'

export async function createSession(id: number) {
  const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)

  // 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹
  const data = await db
    .insert(sessions)
    .values({
      userId: id,
      expiresAt,
    })
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’è¿”ã™
    .returning({ id: sessions.id })

  const sessionId = data[0].id

  // 2. ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’æš—å·åŒ–ã™ã‚‹
  const session = await encrypt({ sessionId, expiresAt })

  // 3. æ¥½è¦³çš„ãªèªè¨¼ãƒã‚§ãƒƒã‚¯ã®ãŸã‚ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’cookieã«ä¿å­˜ã™ã‚‹
  const cookieStore = await cookies()
  cookieStore.set('session', session, {
    httpOnly: true,
    secure: true,
    expires: expiresAt,
    sameSite: 'lax',
    path: '/',
  })
}
```

</TabItem>
<TabItem value="js" label="JavaScript">

```js title="app/lib/session.js" switcher
import cookies from 'next/headers'
import { db } from '@/app/lib/db'
import { encrypt } from '@/app/lib/session'

export async function createSession(id) {
  const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)

  // 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹
  const data = await db
    .insert(sessions)
    .values({
      userId: id,
      expiresAt,
    })
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’è¿”ã™
    .returning({ id: sessions.id })

  const sessionId = data[0].id

  // 2. ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’æš—å·åŒ–ã™ã‚‹
  const session = await encrypt({ sessionId, expiresAt })

  // 3. æ¥½è¦³çš„ãªèªè¨¼ãƒã‚§ãƒƒã‚¯ã®ãŸã‚ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’cookieã«ä¿å­˜ã™ã‚‹
  const cookieStore = await cookies()
  cookieStore.set('session', session, {
    httpOnly: true,
    secure: true,
    expires: expiresAt,
    sameSite: 'lax',
    path: '/',
  })
}
```

</TabItem>
</Tabs>

> **Tips**:
>
> - ã‚ˆã‚Šè¿…é€Ÿãªãƒ‡ãƒ¼ã‚¿å–å¾—ã®ãŸã‚ã«ã€[Vercel Redis](https://vercel.com/docs/storage/vercel-kv)ã®ã‚ˆã†ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚ãŸã ã—ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ—ãƒ©ã‚¤ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã—ã€ãƒ‡ãƒ¼ã‚¿ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’çµ„ã¿åˆã‚ã›ã¦ã‚¯ã‚¨ãƒªæ•°ã‚’æ¸›ã‚‰ã™ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
> - ã‚ˆã‚Šé«˜åº¦ãªãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã€ä¾‹ãˆã°ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæœ€å¾Œã«ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸæ™‚é–“ã‚„ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ‡ãƒã‚¤ã‚¹ã®æ•°ã‚’è¿½è·¡ã™ã‚‹å ´åˆã€ã¾ãŸã¯ã™ã¹ã¦ã®ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã•ã›ã‚‹èƒ½åŠ›ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä¸ãˆã‚‹å ´åˆã«ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚

ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã‚’å®Ÿè£…ã—ãŸå¾Œã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†…ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚‚ã®ã‚„å®Ÿè¡Œã§ãã‚‹ã“ã¨ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã®æ‰¿èªãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚[æ‰¿èª](#authorization)ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«é€²ã‚“ã§è©³ç´°ã‚’å­¦ã³ã¾ã—ã‚‡ã†ã€‚

</AppOnly>

<PagesOnly>

**ã‚µãƒ¼ãƒãƒ¼ä¸Šã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹**:

<Tabs>
<TabItem value="ts" label="TypeScript">

```ts title="pages/api/create-session.ts" switcher
import db from '../../lib/db'
import type { NextApiRequest, NextApiResponse } from 'next'

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  try {
    const user = req.body
    const sessionId = generateSessionId()
    await db.insertSession({
      sessionId,
      userId: user.id,
      createdAt: new Date(),
    })

    res.status(200).json({ sessionId })
  } catch (error) {
    res.status(500).json({ error: 'Internal Server Error' })
  }
}
```

</TabItem>
<TabItem value="js" label="JavaScript">

```js title="pages/api/create-session.js" switcher
import db from '../../lib/db'

export default async function handler(req, res) {
  try {
    const user = req.body
    const sessionId = generateSessionId()
    await db.insertSession({
      sessionId,
      userId: user.id,
      createdAt: new Date(),
    })

    res.status(200).json({ sessionId })
  } catch (error) {
    res.status(500).json({ error: 'Internal Server Error' })
  }
}
```

</TabItem>
</Tabs>

</PagesOnly>

## æ‰¿èª {#authorization}

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªè¨¼ã•ã‚Œã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒä½œæˆã•ã‚ŒãŸå¾Œã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†…ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚‚ã®ã‚„å®Ÿè¡Œã§ãã‚‹ã‚‚ã®ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã®æ‰¿èªã‚’å®Ÿè£…ã§ãã¾ã™ã€‚

æ‰¿èªã®ä¸»ãªãƒã‚§ãƒƒã‚¯ã«ã¯2ã¤ã®ã‚¿ã‚¤ãƒ—ãŒã‚ã‚Šã¾ã™ï¼š

1. **æ¥½è¦³çš„**ï¼šcookieã«ä¿å­˜ã•ã‚ŒãŸã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ«ãƒ¼ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¾ãŸã¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹æ¨©é™ãŒã‚ã‚‹ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚ã“ã‚Œã‚‰ã®ãƒã‚§ãƒƒã‚¯ã¯ã€UIè¦ç´ ã®è¡¨ç¤º/éè¡¨ç¤ºã€æ¨©é™ã‚„å½¹å‰²ã«åŸºã¥ã„ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãªã©ã®è¿…é€Ÿãªæ“ä½œã«å½¹ç«‹ã¡ã¾ã™ã€‚
2. **ã‚»ã‚­ãƒ¥ã‚¢**ï¼šãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã•ã‚ŒãŸã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ«ãƒ¼ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¾ãŸã¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹æ¨©é™ãŒã‚ã‚‹ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚ã“ã‚Œã‚‰ã®ãƒã‚§ãƒƒã‚¯ã¯ã‚ˆã‚Šå®‰å…¨ã§ã‚ã‚Šã€æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦ã™ã‚‹æ“ä½œã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

ã©ã¡ã‚‰ã®ã‚±ãƒ¼ã‚¹ã§ã‚‚ã€ä»¥ä¸‹ã®ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ï¼š

- æ‰¿èªãƒ­ã‚¸ãƒƒã‚¯ã‚’ä¸€å…ƒåŒ–ã™ã‚‹ãŸã‚ã®[ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å±¤](#creating-a-data-access-layer-dal)ã‚’ä½œæˆã™ã‚‹
- å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’è¿”ã™ãŸã‚ã®[ãƒ‡ãƒ¼ã‚¿è»¢é€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆDTOï¼‰ã‚’ä½¿ç”¨ã™ã‚‹](#using-data-transfer-objects-dto)
- [ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢](#optimistic-checks-with-middleware-optional)ã‚’ä½¿ç”¨ã—ã¦æ¥½è¦³çš„ãªãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

### ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’ä½¿ç”¨ã—ãŸæ¥½è¦³çš„ãªãƒã‚§ãƒƒã‚¯ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ {#optimistic-checks-with-middleware-optional}

[ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢](/docs/app/building-your-application/routing/middleware)ã¨æ¨©é™ã«åŸºã¥ã„ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ã‚±ãƒ¼ã‚¹ãŒã„ãã¤ã‹ã‚ã‚Šã¾ã™ï¼š

- æ¥½è¦³çš„ãªãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†ã«ã¯ã€ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã¯ã™ã¹ã¦ã®ãƒ«ãƒ¼ãƒˆã§å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒ­ã‚¸ãƒƒã‚¯ã‚’ä¸€å…ƒåŒ–ã—ã€æœªæ‰¿èªã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’äº‹å‰ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹ãŸã‚ã®è‰¯ã„æ–¹æ³•ã§ã™ã€‚
- ãƒ¦ãƒ¼ã‚¶ãƒ¼é–“ã§ãƒ‡ãƒ¼ã‚¿ã‚’å…±æœ‰ã™ã‚‹é™çš„ãªãƒ«ãƒ¼ãƒˆã‚’ä¿è­·ã™ã‚‹ãŸã‚ï¼ˆä¾‹ãˆã°ã€æœ‰æ–™ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼‰ã€‚

ãŸã ã—ã€ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã¯ã™ã¹ã¦ã®ãƒ«ãƒ¼ãƒˆï¼ˆ[ãƒ—ãƒªãƒ•ã‚§ãƒƒãƒã—ãŸ](https://nextjs.org/docs/app/building-your-application/routing/linking-and-navigating#2-prefetching)ãƒ«ãƒ¼ãƒˆã‚‚å«ã‚€ï¼‰ã§å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€cookieã‹ã‚‰ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®èª­ã¿å–ã‚Šï¼ˆæ¥½è¦³çš„ãƒã‚§ãƒƒã‚¯ï¼‰ã«ã®ã¿æ³¨æ„ã—ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®å•é¡Œã‚’é˜²ããŸã‚ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’é¿ã‘ã¦ãã ã•ã„ã€‚

ä¾‹ãˆã°ï¼š

<Tabs>
<TabItem value="tsx" label="TypeScript">

```tsx title="middleware.ts" switcher
import { NextRequest, NextResponse } from 'next/server'
import { decrypt } from '@/app/lib/session'
import { cookies } from 'next/headers'

// 1. ä¿è­·ã•ã‚ŒãŸãƒ«ãƒ¼ãƒˆã¨å…¬é–‹ãƒ«ãƒ¼ãƒˆã‚’æŒ‡å®šã™ã‚‹
const protectedRoutes = ['/dashboard']
const publicRoutes = ['/login', '/signup', '/']

export default async function middleware(req: NextRequest) {
  // 2. ç¾åœ¨ã®ãƒ«ãƒ¼ãƒˆãŒä¿è­·ã•ã‚ŒãŸãƒ«ãƒ¼ãƒˆã‹å…¬é–‹ãƒ«ãƒ¼ãƒˆã‹ã‚’ç¢ºèªã™ã‚‹
  const path = req.nextUrl.pathname
  const isProtectedRoute = protectedRoutes.includes(path)
  const isPublicRoute = publicRoutes.includes(path)

  // 3. cookieã‹ã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å¾©å·åŒ–ã™ã‚‹
  const cookie = (await cookies()).get('session')?.value
  const session = await decrypt(cookie)

  // 4. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªè¨¼ã•ã‚Œã¦ã„ãªã„å ´åˆã€/loginã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹
  if (isProtectedRoute && !session?.userId) {
    return NextResponse.redirect(new URL('/login', req.nextUrl))
  }

  // 5. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªè¨¼ã•ã‚Œã¦ã„ã‚‹å ´åˆã€/dashboardã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹
  if (
    isPublicRoute &&
    session?.userId &&
    !req.nextUrl.pathname.startsWith('/dashboard')
  ) {
    return NextResponse.redirect(new URL('/dashboard', req.nextUrl))
  }

  return NextResponse.next()
}

// ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãŒå®Ÿè¡Œã•ã‚Œãªã„ãƒ«ãƒ¼ãƒˆã‚’æŒ‡å®šã™ã‚‹
export const config = {
  matcher: ['/((?!api|_next/static|_next/image|.*\\.png$).*)'],
}
```

</TabItem>
<TabItem value="js" label="JavaScript">

```js title="middleware.js" switcher
import { NextResponse } from 'next/server'
import { decrypt } from '@/app/lib/session'
import { cookies } from 'next/headers'

// 1. ä¿è­·ã•ã‚ŒãŸãƒ«ãƒ¼ãƒˆã¨å…¬é–‹ãƒ«ãƒ¼ãƒˆã‚’æŒ‡å®šã™ã‚‹
const protectedRoutes = ['/dashboard']
const publicRoutes = ['/login', '/signup', '/']

export default async function middleware(req) {
  // 2. ç¾åœ¨ã®ãƒ«ãƒ¼ãƒˆãŒä¿è­·ã•ã‚ŒãŸãƒ«ãƒ¼ãƒˆã‹å…¬é–‹ãƒ«ãƒ¼ãƒˆã‹ã‚’ç¢ºèªã™ã‚‹
  const path = req.nextUrl.pathname
  const isProtectedRoute = protectedRoutes.includes(path)
  const isPublicRoute = publicRoutes.includes(path)

  // 3. cookieã‹ã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å¾©å·åŒ–ã™ã‚‹
  const cookie = (await cookies()).get('session')?.value
  const session = await decrypt(cookie)

  // 5. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªè¨¼ã•ã‚Œã¦ã„ãªã„å ´åˆã€/loginã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹
  if (isProtectedRoute && !session?.userId) {
    return NextResponse.redirect(new URL('/login', req.nextUrl))
  }

  // 6. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªè¨¼ã•ã‚Œã¦ã„ã‚‹å ´åˆã€/dashboardã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹
  if (
    isPublicRoute &&
    session?.userId &&
    !req.nextUrl.pathname.startsWith('/dashboard')
  ) {
    return NextResponse.redirect(new URL('/dashboard', req.nextUrl))
  }

  return NextResponse.next()
}

// ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãŒå®Ÿè¡Œã•ã‚Œãªã„ãƒ«ãƒ¼ãƒˆã‚’æŒ‡å®šã™ã‚‹
export const config = {
  matcher: ['/((?!api|_next/static|_next/image|.*\\.png$).*)'],
}
```

</TabItem>
</Tabs>

ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã¯åˆæœŸãƒã‚§ãƒƒã‚¯ã«å½¹ç«‹ã¡ã¾ã™ãŒã€ãƒ‡ãƒ¼ã‚¿ã‚’ä¿è­·ã™ã‚‹ãŸã‚ã®å”¯ä¸€ã®é˜²å¾¡ãƒ©ã‚¤ãƒ³ã¨ã—ã¦ä½¿ç”¨ã™ã‚‹ã¹ãã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã®å¤§éƒ¨åˆ†ã¯ã€ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã«ã§ãã‚‹ã ã‘è¿‘ã¥ã‘ã¦è¡Œã†ã¹ãã§ã™ã€‚[ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å±¤](#creating-a-data-access-layer-dal)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

> **Tips**:
>
> - ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§ã¯ã€`req.cookies.get('session').value`ã‚’ä½¿ç”¨ã—ã¦cookieã‚’èª­ã¿å–ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
> - ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã¯[Edge Runtime](/docs/app/building-your-application/rendering/edge-and-nodejs-runtimes)ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€èªè¨¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒäº’æ›æ€§ãŒã‚ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚
> - ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®`matcher`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä½¿ç”¨ã—ã¦ã€ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãŒå®Ÿè¡Œã•ã‚Œã‚‹ãƒ«ãƒ¼ãƒˆã‚’æŒ‡å®šã§ãã¾ã™ã€‚ãŸã ã—ã€èªè¨¼ã®ãŸã‚ã«ã¯ã€ã™ã¹ã¦ã®ãƒ«ãƒ¼ãƒˆã§ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚

<AppOnly>

### ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ãƒ¬ã‚¤ãƒ¤ãƒ¼(DAL)ã‚’ä½œæˆã™ã‚‹ {#creating-a-data-access-layer-dal}

ãƒ‡ãƒ¼ã‚¿ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨æ‰¿èªãƒ­ã‚¸ãƒƒã‚¯ã‚’ä¸€å…ƒåŒ–ã™ã‚‹ãŸã‚ã«DALã‚’ä½œæˆã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚

DALã«ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨å¯¾è©±ã™ã‚‹éš›ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç¢ºèªã™ã‚‹é–¢æ•°ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã¹ãã§ã™ã€‚æœ€ä½é™ã€ã“ã®é–¢æ•°ã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒæœ‰åŠ¹ã§ã‚ã‚‹ã‹ã‚’ç¢ºèªã—ã€ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ã‹ã€ã•ã‚‰ãªã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã†ãŸã‚ã«å¿…è¦ãªãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¿”ã™ã¹ãã§ã™ã€‚

ä¾‹ãˆã°ã€`verifySession()`é–¢æ•°ã‚’å«ã‚€DALã®ãŸã‚ã®åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚ãã—ã¦ã€Reactã®[cache](https://react.dev/reference/react/cache) APIã‚’ä½¿ç”¨ã—ã¦ã€Reactã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ‘ã‚¹ä¸­ã«é–¢æ•°ã®æˆ»ã‚Šå€¤ã‚’ãƒ¡ãƒ¢åŒ–ã—ã¾ã™ï¼š

<Tabs>
<TabItem value="tsx" label="TypeScript">

```tsx title="app/lib/dal.ts" switcher
import 'server-only'

import { cookies } from 'next/headers'
import { decrypt } from '@/app/lib/session'

export const verifySession = cache(async () => {
  const cookie = (await cookies()).get('session')?.value
  const session = await decrypt(cookie)

  if (!session?.userId) {
    redirect('/login')
  }

  return { isAuth: true, userId: session.userId }
})
```

</TabItem>
<TabItem value="js" label="JavaScript">

```js title="app/lib/dal.js" switcher
import 'server-only'

import { cookies } from 'next/headers'
import { decrypt } from '@/app/lib/session'

export const verifySession = cache(async () => {
  const cookie = (await cookies()).get('session')?.value
  const session = await decrypt(cookie)

  if (!session.userId) {
    redirect('/login')
  }

  return { isAuth: true, userId: session.userId }
})
```

</TabItem>
</Tabs>

æ¬¡ã«ã€ãƒ‡ãƒ¼ã‚¿ãƒªã‚¯ã‚¨ã‚¹ãƒˆã€Server Actionsã€Route Handlersã§`verifySession()`é–¢æ•°ã‚’å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã™ï¼š

<Tabs>
<TabItem value="tsx" label="TypeScript">

```tsx title="app/lib/dal.ts" switcher
export const getUser = cache(async () => {
  const session = await verifySession()
  if (!session) return null

  try {
    const data = await db.query.users.findMany({
      where: eq(users.id, session.userId),
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã§ã¯ãªãã€å¿…è¦ãªã‚«ãƒ©ãƒ ã®ã¿ã‚’æ˜ç¤ºçš„ã«è¿”ã™
      columns: {
        id: true,
        name: true,
        email: true,
      },
    })

    const user = data[0]

    return user
  } catch (error) {
    console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ')
    return null
  }
})
```

</TabItem>
<TabItem value="jsx" label="JavaScript">

```jsx title="app/lib/dal.js" switcher
export const getUser = cache(async () => {
  const session = await verifySession()
  if (!session) return null

  try {
    const data = await db.query.users.findMany({
      where: eq(users.id, session.userId),
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã§ã¯ãªãã€å¿…è¦ãªã‚«ãƒ©ãƒ ã®ã¿ã‚’æ˜ç¤ºçš„ã«è¿”ã™
      columns: {
        id: true,
        name: true,
        email: true,
      },
    })

    const user = data[0]

    return user
  } catch (error) {
    console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ')
    return null
  }
})
```

</TabItem>
</Tabs>

> **Tip**:
>
> - DALã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚é–“ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿è­·ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã§ãã¾ã™ã€‚ ãŸã ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼é–“ã§ãƒ‡ãƒ¼ã‚¿ã‚’å…±æœ‰ã™ã‚‹é™çš„ãªãƒ«ãƒ¼ãƒˆã«é–¢ã—ã¦ã¯ã€ãƒ‡ãƒ¼ã‚¿ã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚é–“ã§ã¯ãªããƒ“ãƒ«ãƒ‰æ™‚é–“ã§å–å¾—ã•ã‚Œã¾ã™ã€‚[ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢](#optimistic-checks-with-middleware-optional)ã‚’ä½¿ç”¨ã—ã¦é™çš„ãƒ«ãƒ¼ãƒˆã‚’ä¿è­·ã—ã¦ãã ã•ã„ã€‚
> - ã‚»ã‚­ãƒ¥ã‚¢ãªãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†ãŸã‚ã«ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨æ¯”è¼ƒã—ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒæœ‰åŠ¹ã§ã‚ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã§ãã¾ã™ã€‚Reactã®[cache](https://react.dev/reference/react/cache)é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ‘ã‚¹ä¸­ã«ä¸å¿…è¦ãªé‡è¤‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«é€ä¿¡ã—ãªã„ã‚ˆã†ã«ã—ã¾ã™ã€‚
> - é–¢é€£ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’JavaScriptã‚¯ãƒ©ã‚¹ã«çµ±åˆã—ã€`verifySession()`ã‚’å®Ÿè¡Œã—ã¦ã‹ã‚‰ä»»æ„ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚‚æ¤œè¨ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

### ãƒ‡ãƒ¼ã‚¿è»¢é€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆDTOï¼‰ã®ä½¿ç”¨ {#using-data-transfer-objects-dto}

ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹éš›ã«ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ä½¿ç”¨ã™ã‚‹ãŸã‚ã«å¿…è¦ãªæœ€ä½é™ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚å…¨ä½“ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã™ã¹ãã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ä¾‹ãˆã°ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹å ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®IDã‚„åå‰ã®ã¿ã‚’è¿”ã—ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€é›»è©±ç•ªå·ãªã©ã‚’å«ã‚€å…¨ä½“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯è¿”ã•ãªã„ã§ã™ã€‚

ãŸã ã—ã€è¿”ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã®æ§‹é€ ã‚’åˆ¶å¾¡ã§ããªã„å ´åˆã‚„ã€ãƒãƒ¼ãƒ ã§ä½œæ¥­ã—ã¦ã„ã¦å…¨ä½“ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«æ¸¡ã•ã‚Œã‚‹ã®ã‚’é¿ã‘ãŸã„å ´åˆã«ã¯ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«å…¬é–‹ã™ã‚‹ã®ãŒå®‰å…¨ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æŒ‡å®šã™ã‚‹ã‚ˆã†ãªæˆ¦ç•¥ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚

<Tabs>
<TabItem value="tsx" label="TypeScript">

```tsx title="app/lib/dto.ts" switcher
import 'server-only'
import { getUser } from '@/app/lib/dal'

function canSeeUsername(viewer: User) {
  return true
}

function canSeePhoneNumber(viewer: User, team: string) {
  return viewer.isAdmin || team === viewer.team
}

export async function getProfileDTO(slug: string) {
  const data = await db.query.users.findMany({
    where: eq(users.slug, slug),
    // ç‰¹å®šã®ã‚«ãƒ©ãƒ ã‚’ã“ã“ã«è¿”ã™
  })
  const user = data[0]

  const currentUser = await getUser(user.id)

  // ã¾ãŸã¯ã“ã“ã§ã‚¯ã‚¨ãƒªå°‚ç”¨ã«ç‰¹å®šã®ã‚‚ã®ã‚’è¿”ã™
  return {
    username: canSeeUsername(currentUser) ? user.username : null,
    phonenumber: canSeePhoneNumber(currentUser, user.team)
      ? user.phonenumber
      : null,
  }
}
```

</TabItem>
<TabItem value="js" label="JavaScript">

```js title="app/lib/dto.js" switcher
import 'server-only'
import { getUser } from '@/app/lib/dal'

function canSeeUsername(viewer) {
  return true
}

function canSeePhoneNumber(viewer, team) {
  return viewer.isAdmin || team === viewer.team
}

export async function getProfileDTO(slug) {
  const data = await db.query.users.findMany({
    where: eq(users.slug, slug),
    // ç‰¹å®šã®ã‚«ãƒ©ãƒ ã‚’ã“ã“ã«è¿”ã™
  })
  const user = data[0]

  const currentUser = await getUser(user.id)

  // ã¾ãŸã¯ã“ã“ã§ã‚¯ã‚¨ãƒªå°‚ç”¨ã«ç‰¹å®šã®ã‚‚ã®ã‚’è¿”ã™
  return {
    username: canSeeUsername(currentUser) ? user.username : null,
    phonenumber: canSeePhoneNumber(currentUser, user.team)
      ? user.phonenumber
      : null,
  }
}
```

</TabItem>
</Tabs>

ãƒ‡ãƒ¼ã‚¿ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨æ‰¿èªãƒ­ã‚¸ãƒƒã‚¯ã‚’DALã«ä¸€å…ƒåŒ–ã—ã€DTOã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚»ã‚­ãƒ¥ã‚¢ã§ä¸€è²«æ€§ãŒã‚ã‚Šã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚¹ã‚±ãƒ¼ãƒ«ã™ã‚‹ã«ã¤ã‚Œã¦ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã€ç›£æŸ»ã€ãŠã‚ˆã³ãƒ‡ãƒãƒƒã‚°ãŒå®¹æ˜“ã«ãªã‚Šã¾ã™ã€‚

> **Good to know**:
>
> - DTOã‚’å®šç¾©ã™ã‚‹æ–¹æ³•ã¯ã„ãã¤ã‹ã‚ã‚Šã¾ã™ã€‚`toJSON()`ã‚’ä½¿ç”¨ã™ã‚‹æ–¹æ³•ã€ä¾‹ã®ã‚ˆã†ãªå€‹ã€…ã®é–¢æ•°ã€ã¾ãŸã¯JSã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹æ–¹æ³•ã§ã™ã€‚ã“ã‚Œã‚‰ã¯JavaScriptã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã‚ã‚Šã€Reactã‚„Next.jsã®æ©Ÿèƒ½ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ãã®ãŸã‚ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«æœ€é©ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹ãŸã‚ã«å°‘ã—èª¿ã¹ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚
> - [Next.jsã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨˜äº‹](https://nextjs.org/blog/security-nextjs-server-components-actions)ã§ã‚‚ç´¹ä»‹ã•ã‚Œã¦ã„ã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«ã¤ã„ã¦å­¦ã³ã¾ã™ã€‚

### ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ {#server-components}

[Server Components](/docs/app/building-your-application/rendering/server-components)ã§ã®èªè¨¼ãƒã‚§ãƒƒã‚¯ã¯å½¹å‰²ãƒ™ãƒ¼ã‚¹ã®ã‚¢ã‚¯ã‚»ã‚¹ã«ä¾¿åˆ©ã§ã™ã€‚ãŸã¨ãˆã°ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å½¹å‰²ã«åŸºã¥ã„ã¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’æ¡ä»¶ä»˜ã‘ã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹å ´åˆï¼š

<Tabs>
<TabItem value="tsx" label="TypeScript">

```tsx title="app/dashboard/page.tsx" switcher
import { verifySession } from '@/app/lib/dal'

export default function Dashboard() {
  const session = await verifySession()
  const userRole = session?.user?.role // 'role'ãŒã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä¸€éƒ¨ã§ã‚ã‚‹ã¨æƒ³å®š

  if (userRole === 'admin') {
    return <AdminDashboard />
  } else if (userRole === 'user') {
    return <UserDashboard />
  } else {
    redirect('/login')
  }
}
```

</TabItem>
<TabItem value="jsx" label="JavaScript">

```jsx title="app/dashboard/page.jsx" switcher
import { verifySession } from '@/app/lib/dal'

export default function Dashboard() {
  const session = await verifySession()
  const userRole = session.role // 'role'ãŒã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä¸€éƒ¨ã§ã‚ã‚‹ã¨æƒ³å®š

  if (userRole === 'admin') {
    return <AdminDashboard />
  } else if (userRole === 'user') {
    return <UserDashboard />
  } else {
    redirect('/login')
  }
}
```

</TabItem>
</Tabs>

ã“ã®ä¾‹ã§ã¯ã€DALã‹ã‚‰ã®`verifySession()`é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ã€'admin'ã€'user'ã€ãŠã‚ˆã³æœªæ‰¿èªã®å½¹å‰²ã‚’ç¢ºèªã—ã¾ã™ã€‚ã“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ã€å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªåˆ†ã®å½¹å‰²ã«å¿œã˜ã¦é©åˆ‡ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨å¯¾è©±ã™ã‚‹ã“ã¨ã‚’ä¿è¨¼ã—ã¾ã™ã€‚

### ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¨èªè¨¼ãƒã‚§ãƒƒã‚¯ {#layouts-and-auth-checks}

[Partial Rendering](/docs/app/building-your-application/routing/linking-and-navigating#4-partial-rendering)ã®ãŸã‚ã€[ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ](/docs/app/building-your-application/routing/layouts-and-templates)ã§ã®ãƒã‚§ãƒƒã‚¯ã«ã¯æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚ã“ã‚Œã‚‰ã¯ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ™‚ã«ã¯å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œãªã„ãŸã‚ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ãƒ«ãƒ¼ãƒˆã”ã¨ã«ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¾ã›ã‚“ã€‚

ä»£ã‚ã‚Šã«ã€ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚„æ¡ä»¶ä»˜ã‘ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«è¿‘ã„å ´æ‰€ã§ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ä¾‹ãˆã°ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”»åƒã‚’è¡¨ç¤ºã™ã‚‹å…±æœ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’è€ƒãˆã¦ã¿ã¦ãã ã•ã„ã€‚èªè¨¼ãƒã‚§ãƒƒã‚¯ã‚’ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§è¡Œã†ã®ã§ã¯ãªãã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆ`getUser()`ï¼‰ã‚’ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§å–å¾—ã—ã€èªè¨¼ãƒã‚§ãƒƒã‚¯ã‚’DALã§è¡Œã„ã¾ã™ã€‚

ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†…ã®ã©ã“ã§`getUser()`ãŒå‘¼ã³å‡ºã•ã‚Œã¦ã‚‚èªè¨¼ãƒã‚§ãƒƒã‚¯ãŒè¡Œã‚ã‚Œã€é–‹ç™ºè€…ãŒãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹è³‡æ ¼ãŒã‚ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹ã®ã‚’å¿˜ã‚Œã‚‹ã®ã‚’é˜²ãã¾ã™ã€‚

<Tabs>
<TabItem value="tsx" label="TypeScript">

```tsx title="app/layout.tsx" switcher
export default async function Layout({
  children,
}: {
  children: React.ReactNode;
}) {
  const user = await getUser();

  return (
    // ...
  )
}
```

</TabItem>
<TabItem value="jsx" label="JavaScript">

```js title="app/layout.js"
export default async function Layout({ children }) {
  const user = await getUser();

  return (
    // ...
  )
}
```

</TabItem>
</Tabs>

<Tabs>
<TabItem value="ts" label="TypeScript">

```ts title="app/lib/dal.ts" switcher
export const getUser = cache(async () => {
  const session = await verifySession()
  if (!session) return null

  // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—ã—ã€ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹
})
```

</TabItem>
<TabItem value="js" label="JavaScript">

```js title="app/lib/dal.js" switcher
export const getUser = cache(async () => {
  const session = await verifySession()
  if (!session) return null

  // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—ã—ã€ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹
})
```

</TabItem>
</Tabs>

> **Good to know:**
>
> - SPAã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰¿èªã•ã‚Œã¦ã„ãªã„å ´åˆã«ã¯ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¾ãŸã¯ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§`return null`ã‚’è¿”ã™ã®ãŒä¸€èˆ¬çš„ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚ã“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ã€Next.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«è¤‡æ•°ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆãŒã‚ã‚‹ãŸã‚ã€ãƒã‚¹ãƒˆã•ã‚ŒãŸãƒ«ãƒ¼ãƒˆã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚„Server Actionsã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’é˜²ãã“ã¨ãŒã§ããªã„ãŸã‚ã€**æ¨å¥¨ã•ã‚Œã¾ã›ã‚“**ã€‚

### ã‚µãƒ¼ãƒãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ {#server-actions}

[ã‚µãƒ¼ãƒãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³](/docs/app/building-your-application/data-fetching/server-actions-and-mutations)ã‚’å…¬é–‹ã•ã‚Œã¦ã„ã‚‹APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¨åŒã˜ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …ã§æ‰±ã„ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒŸãƒ¥ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

ä»¥ä¸‹ã®ä¾‹ã§ã¯ã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¨±å¯ã™ã‚‹å‰ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å½¹å‰²ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ï¼š

<Tabs>
<TabItem value="ts" label="TypeScript">

```ts title="app/lib/actions.ts" switcher
'use server'
import { verifySession } from '@/app/lib/dal'

export async function serverAction(formData: FormData) {
  const session = await verifySession()
  const userRole = session?.user?.role

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹æ¨©é™ãŒãªã„å ´åˆã€æ—©æœŸã«çµ‚äº†ã™ã‚‹
  if (userRole !== 'admin') {
    return null
  }

  // èªè¨¼ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¤ã„ã¦ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç¶šè¡Œã™ã‚‹
}
```

</TabItem>
<TabItem value="js" label="JavaScript">

```js title="app/lib/actions.js" switcher
'use server'
import { verifySession } from '@/app/lib/dal'

export async function serverAction() {
  const session = await verifySession()
  const userRole = session.user.role

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹æ¨©é™ãŒãªã„å ´åˆã€æ—©æœŸã«çµ‚äº†ã™ã‚‹
  if (userRole !== 'admin') {
    return null
  }

  // èªè¨¼ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¤ã„ã¦ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç¶šè¡Œã™ã‚‹
}
```

</TabItem>
</Tabs>

### ãƒ«ãƒ¼ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ {#route-handlers}

[ãƒ«ãƒ¼ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼](/docs/app/building-your-application/routing/route-handlers)ã‚’å…¬é–‹ã•ã‚Œã¦ã„ã‚‹APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¨åŒã˜ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …ã§æ‰±ã„ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ«ãƒ¼ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

ä¾‹ãˆã°ï¼š

<Tabs>
<TabItem value="ts" label="TypeScript">

```ts title="app/api/route.ts" switcher
import { verifySession } from '@/app/lib/dal'

export async function GET() {
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã¨å½¹å‰²ã®ç¢ºèª
  const session = await verifySession()

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªè¨¼ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹
  if (!session) {
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“
    return new Response(null, { status: 401 })
  }

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ'admin'å½¹å‰²ã‚’æŒã£ã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹
  if (session.user.role !== 'admin') {
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯èªè¨¼ã•ã‚Œã¦ã„ã¾ã™ãŒã€é©åˆ‡ãªæ¨©é™ã‚’æŒã£ã¦ã„ã¾ã›ã‚“
    return new Response(null, { status: 403 })
  }

  // èªè¨¼ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦ç¶šè¡Œã—ã¾ã™
}
```

</TabItem>
<TabItem value="js" label="JavaScript">

```js title="app/api/route.js" switcher
import { verifySession } from '@/app/lib/dal'

export async function GET() {
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã¨å½¹å‰²ã®ç¢ºèª
  const session = await verifySession()

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªè¨¼ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹
  if (!session) {
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“
    return new Response(null, { status: 401 })
  }

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ'admin'å½¹å‰²ã‚’æŒã£ã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹
  if (session.user.role !== 'admin') {
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯èªè¨¼ã•ã‚Œã¦ã„ã¾ã™ãŒã€é©åˆ‡ãªæ¨©é™ã‚’æŒã£ã¦ã„ã¾ã›ã‚“
    return new Response(null, { status: 403 })
  }

  // èªè¨¼ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦ç¶šè¡Œã—ã¾ã™
}
```

</TabItem>
</Tabs>

ä¸Šè¨˜ã®ä¾‹ã¯ã€2æ®µéšã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã‚’å‚™ãˆãŸãƒ«ãƒ¼ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚æœ€åˆã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç¢ºèªã—ã€æ¬¡ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ'admin'ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

## ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ {#context-providers}

Next.jsã§[æ··åœ¨](https://nextjs.org/docs/app/building-your-application/rendering/composition-patterns#composition)ã™ã‚‹Serverã¨Client Componentsã®ãŠã‹ã’ã§èªè¨¼ã«ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ãŒã€Reactã®`context`ã¯ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãŸã‚ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ã®ã¿é©ç”¨ã§ãã¾ã™ã€‚

ã“ã‚Œã¯æ©Ÿèƒ½ã—ã¾ã™ãŒã€ä»»æ„ã®å­Server Componentsã¯æœ€åˆã«ã‚µãƒ¼ãƒãƒ¼ã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã€ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ï¼š

<Tabs>
<TabItem value="tsx" label="TypeScript">

```tsx title="app/layout.ts" switcher
import { ContextProvider } from 'auth-lib'

export default function RootLayout({ children }) {
  return (
    <html lang="ja">
      <body>
        <ContextProvider>{children}</ContextProvider>
      </body>
    </html>
  )
}
```

</TabItem>
</Tabs>

```tsx title="app/ui/profile.ts switcher
"use client";

import { useSession } from "auth-lib";

export default function Profile() {
  const { userId } = useSession();
  const { data } = useSWR(`/api/user/${userId}`, fetcher)

  return (
    // ...
  );
}
```

```jsx title="app/ui/profile.js switcher
"use client";

import { useSession } from "auth-lib";

export default function Profile() {
  const { userId } = useSession();
  const { data } = useSWR(`/api/user/${userId}`, fetcher)

  return (
    // ...
  );
}
```

ã‚‚ã—ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ãªå ´åˆï¼ˆä¾‹ãˆã°ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒç”¨ï¼‰ã€Reactã®[`taintUniqueValue`](https://react.dev/reference/react/experimental_taintUniqueValue) API ã‚’ä½¿ç”¨ã—ã¦ã‚»ãƒ³ã‚·ãƒ†ã‚£ãƒ–ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ãŒã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«éœ²å‡ºã™ã‚‹ã“ã¨ã‚’é˜²ãã¾ã™ã€‚

</AppOnly>

<PagesOnly>

### ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ãƒ¬ã‚¤ãƒ¤ãƒ¼(DAL)ã‚’ä½œæˆã™ã‚‹ {#creating-a-data-access-layer-dal}

#### APIãƒ«ãƒ¼ãƒˆã‚’ä¿è­·ã™ã‚‹ {#protecting-api-routes}

Next.jsã®APIãƒ«ãƒ¼ãƒˆã¯ã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®ãƒ­ã‚¸ãƒƒã‚¯ã¨ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚’å‡¦ç†ã™ã‚‹ä¸Šã§é‡è¦ã§ã™ã€‚ã“ã‚Œã‚‰ã®ãƒ«ãƒ¼ãƒˆã‚’ä¿è­·ã—ã€ç‰¹å®šã®æ©Ÿèƒ½ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’èªè¨¼æ¸ˆã¿ã®ã¿ã«ã™ã‚‹ã“ã¨ãŒä¸å¯æ¬ ã§ã™ã€‚ã“ã‚Œã«ã¯å…¸å‹çš„ã«ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èªè¨¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¨å½¹å‰²ãƒ™ãƒ¼ã‚¹ã®æ¨©é™ã®æ¤œè¨¼ãŒå«ã¾ã‚Œã¾ã™ã€‚

ä»¥ä¸‹ã¯APIãƒ«ãƒ¼ãƒˆã‚’ä¿è­·ã™ã‚‹æ–¹æ³•ã®ä¾‹ã§ã™ï¼š

<Tabs>
<TabItem value="ts" label="TypeScript">

```ts title="pages/api/route.ts" switcher
import { NextApiRequest, NextApiResponse } from 'next'

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  const session = await getSession(req)

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªè¨¼ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹
  if (!session) {
    res.status(401).json({
      error: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“',
    })
    return
  }

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ'admin'å½¹å‰²ã‚’æŒã£ã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹
  if (session.user.role !== 'admin') {
    res.status(401).json({
      error: 'æœªæ‰¿èªã®ã‚¢ã‚¯ã‚»ã‚¹ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ç®¡ç†è€…æ¨©é™ã‚’æŒã£ã¦ã„ã¾ã›ã‚“ã€‚',
    })
    return
  }

  // èªè¨¼ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦ãƒ«ãƒ¼ãƒˆã®å‡¦ç†ã‚’ç¶šè¡Œã™ã‚‹
  // ... APIãƒ«ãƒ¼ãƒˆã®å®Ÿè£…
}
```

</TabItem>
<TabItem value="js" label="JavaScript">

```js title="pages/api/route.js" switcher
export default async function handler(req, res) {
  const session = await getSession(req)

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªè¨¼ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹
  if (!session) {
    res.status(401).json({
      error: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“',
    })
    return
  }

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ'admin'å½¹å‰²ã‚’æŒã£ã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹
  if (session.user.role !== 'admin') {
    res.status(401).json({
      error: 'æœªæ‰¿èªã®ã‚¢ã‚¯ã‚»ã‚¹ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ç®¡ç†è€…æ¨©é™ã‚’æŒã£ã¦ã„ã¾ã›ã‚“ã€‚',
    })
    return
  }

  // èªè¨¼ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦ãƒ«ãƒ¼ãƒˆã®å‡¦ç†ã‚’ç¶šè¡Œã™ã‚‹
  // ... APIãƒ«ãƒ¼ãƒˆã®å®Ÿè£…
}
```

</TabItem>
</Tabs>

ã“ã®ä¾‹ã¯ã€èªè¨¼ã¨æ‰¿èªã®2æ®µéšã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã‚’å«ã‚€APIãƒ«ãƒ¼ãƒˆã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚ã¾ãšã€ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã€æ¬¡ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ'admin'ã§ã‚ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚ã“ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã¯ã€èªè¨¼ã•ã‚Œæ‰¿èªã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é™å®šã•ã‚ŒãŸã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†ã®ãŸã‚ã®å …ç‰¢ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’ä¿è¨¼ã—ã¾ã™ã€‚

</PagesOnly>

## ãƒªã‚½ãƒ¼ã‚¹ {#resources}

Next.jsã§ã®èªè¨¼ã«ã¤ã„ã¦å­¦ã‚“ã ã‚‰ã€Next.jsã¨äº’æ›æ€§ã®ã‚ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã‚»ã‚­ãƒ¥ã‚¢ãªèªè¨¼ã‚„ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã‚’å®Ÿè£…ã™ã‚‹ãŸã‚ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ã”ç´¹ä»‹ã—ã¾ã™ï¼š

### èªè¨¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒª {#auth-libraries}

- [Auth.js](https://authjs.dev/getting-started/installation?framework=next.js)
- [Auth0](https://auth0.com/docs/quickstart/webapp/nextjs/01-login)
- [Clerk](https://clerk.com/docs/quickstarts/nextjs)
- [Kinde](https://kinde.com/docs/developer-tools/nextjs-sdk)
- [Ory](https://www.ory.sh/docs/getting-started/integrate-auth/nextjs)
- [Stack Auth](https://docs.stack-auth.com/getting-started/setup)
- [Supabase](https://supabase.com/docs/guides/getting-started/quickstarts/nextjs)
- [Stytch](https://stytch.com/docs/guides/quickstarts/nextjs)
- [WorkOS](https://workos.com/docs/user-management/nextjs)

### ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ãƒ©ã‚¤ãƒ–ãƒ©ãƒª {#session-management-libraries}

- [Iron Session](https://github.com/vvo/iron-session)
- [Jose](https://github.com/panva/jose)

## ã•ã‚‰ãªã‚‹èª­ã¿ç‰© {#further-reading}

èªè¨¼ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã«ã¤ã„ã¦å­¦ã³ç¶šã‘ã‚‹ãŸã‚ã«ã€ä»¥ä¸‹ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

- [Next.jsã«ãŠã‘ã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’è€ƒãˆã‚‹æ–¹æ³•](https://nextjs.org/blog/security-nextjs-server-components-actions)
- [XSSæ”»æ’ƒã‚’ç†è§£ã™ã‚‹](https://vercel.com/guides/understanding-xss-attacks)
- [CSRFæ”»æ’ƒã‚’ç†è§£ã™ã‚‹](https://vercel.com/guides/understanding-csrf-attacks)
- [The Copenhagen Book](https://thecopenhagenbook.com/)
