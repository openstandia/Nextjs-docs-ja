---
title: 'メモリ使用量'
description: '開発環境と本番環境でのアプリケーションのメモリを最適化します。'
---

アプリケーションが成長し、機能が充実してくると、ローカル開発や本番ビルドを行う際に、より多くのリソースが必要となることがあります。

次に、Next.jsでのメモリを最適化し、一般的な問題に対処するための戦略と技術を探っていきましょう。

## 依存関係の数を減らす

大量の依存関係を持つアプリケーションは、より多くのメモリを使用します。

[Bundle Analyzer](/docs/app/building-your-application/optimizing/package-bundling)は、大きな依存関係を調査し、パフォーマンスとメモリ使用量の向上のために除去できる可能性を見つける手助けをしてくれます。

## `experimental.webpackMemoryOptimizations`を試す

`v15.0.0`以降では、`next.config.js`ファイルに`experimental.webpackMemoryOptimizations: true`を追加することで、Webpackの動作が変更され、最大メモリ使用量が減少します。ただし、コンパイル時間がわずかに増加する可能性があります。

> **Good to know**: この機能は現在、他のプロジェクトでテストするために実験的であり、リスクは低いと見られています。

## `next build`を`--experimental-debug-memory-usage`で実行する

`14.2.0`から`next build --experimental-debug-memory-usage`を実行すると、ビルド中にメモリの使用状況（ヒープ使用量やガベージコレクションの統計など）についての情報を継続的に出力するモードでビルドを実行できます。メモリ使用量が設定した制限に近づくと、自動的にヒープスナップショットも取得されます。

> **Good to know**: この機能は、カスタムWebpack設定がない限り自動的に有効となるWebpackビルドワーカーオプションとは互換性がありません。

## ヒーププロファイルを記録する

メモリの問題を探るためにNode.jsからヒーププロファイルを記録し、Chrome DevToolsでメモリリークの潜在的な原因を特定できます。

ターミナルで、Next.jsビルドを開始する際にNode.jsに`--heap-prof`フラグを渡してください：

```sh
node --heap-prof node_modules/next/dist/bin/next build
```

ビルド終了時に、Node.jsによって`.heapprofile`ファイルが作成されます。

Chrome DevToolsで、メモリタブを開き、「Load Profile」ボタンをクリックしてファイルを視覚化できます。

## ヒープのスナップショットを解析する

アプリケーションのメモリ使用状況を解析するには、インスペクターツールを使用できます。

`next build`や`next dev`コマンドを実行する際、コマンドの先頭に`NODE_OPTIONS=--inspect`を追加します。これによって、インスペクターエージェントがデフォルトポートで公開されます。ユーザーコードが開始される前に停止させたい場合は、代わりに`--inspect-brk`を渡すことができます。プロセスが実行中に、Chrome DevToolsなどのツールを使用してデバッグポートに接続し、保持されているメモリを確認するためのヒープスナップショットを記録・解析できます。

`14.2.0`から、ヒープスナップショットを取得しやすくするために、`next build`を`--experimental-debug-memory-usage`フラグで実行することも可能です。

このモードで実行している間、プロセスにいつでも`SIGUSR2`シグナルを送信すると、プロセスはヒープスナップショットを取得します。

ヒープスナップショットはNext.jsアプリケーションのプロジェクトrootに保存され、Chrome DevToolsなどのヒープアナライザーにロードして保持されているメモリを確認できます。このモードは、まだWebpackビルドワーカーとは互換性がありません。

詳細は[ヒープスナップショットの記録と解析方法](https://developer.chrome.com/docs/devtools/memory-problems/heap-snapshots)を参照してください。

## Webpackビルドワーカー

Webpackビルドワーカーは、別のNode.jsワーカー内でWebpackコンパイルを実行することで、ビルド中のアプリケーションのメモリ使用量を減少させます。

このオプションは、カスタムWebpack設定がない場合は`v14.1.0`からデフォルトで有効化されます。

古いバージョンのNext.jsを使用している場合やカスタムWebpack設定を使用している場合、このオプションを有効にするには、`next.config.js`に`experimental.webpackBuildWorker: true`を設定します。

> **Good to know**: この機能は、すべてのカスタムWebpackプラグインと互換性がない可能性があります。

## Webpackキャッシュを無効にする

[Webpackキャッシュ](https://webpack.js.org/configuration/cache/)は、生成されたWebpackモジュールをメモリまたはディスクに保存して、ビルドの速度を向上させます。これによりパフォーマンスが向上しますが、キャッシュされたデータを保存するためにアプリケーションのメモリ使用量も増加します。

この動作を無効にするには、アプリケーションに[カスタムWebpack設定](/docs/app/api-reference/next-config-js/webpack)を追加できます：

```js filename="next.config.mjs"
/** @type {import('next').NextConfig} */
const nextConfig = {
  webpack: (
    config,
    { buildId, dev, isServer, defaultLoaders, nextRuntime, webpack }
  ) => {
    if (config.cache && !dev) {
      config.cache = Object.freeze({
        type: 'memory',
      })
    }
    // 重要: 修正後の設定を返す
    return config
  },
}

export default nextConfig
```

## 静的解析を無効にする

型チェックやリンティングは特に大規模プロジェクトで多くのメモリを必要とすることがあります。
しかし、ほとんどのプロジェクトにはこれらのタスクをすでに処理している専用のCIランナーがあります。
ビルド時に「型の検証とリンティング」ステップでメモリ不足の問題が発生する場合は、ビルド中にこれらのタスクを無効にすることができます：

```js filename="next.config.mjs"
/** @type {import('next').NextConfig} */
const nextConfig = {
  eslint: {
    // 警告: プロジェクトにESLintエラーがある場合でも
    // 本番ビルドが正常に完了するようにします。
    ignoreDuringBuilds: true,
  },
  typescript: {
    // !! 警告 !!
    // プロジェクトに型エラーがある場合でも
    // 本番ビルドが正常に完了するように許可します。
    // !! 警告 !!
    ignoreBuildErrors: true,
  },
}

export default nextConfig
```

- [TypeScriptエラーを無視する](/docs/pages/building-your-application/configuring/typescript#ignoring-typescript-errors)
- [Next.js設定のESLint](/docs/pages/api-reference/next-config-js/eslint)

これにより型エラーやリンティングの問題のために不正なデプロイが行われる可能性があることを忘れないでください。
静的解析が完了した後にのみビルドを本番環境に昇格させることを強く推奨します。
Vercelにデプロイする場合、[ステージングデプロイのガイド](https://vercel.com/docs/deployments/managing-deployments#staging-and-promoting-a-production-deployment)を確認し、カスタムタスクが成功した後にビルドを本番環境に昇格させる方法を学ぶことができます。

## ソースマップを無効にする

ソースマップを生成することは、ビルドプロセス中に余分なメモリを消費します。

ソースマップの生成を無効にするには、`productionBrowserSourceMaps: false`と`experimental.serverSourceMaps: false`をNext.js設定に追加します。

> **Good to know**: 一部のプラグインはソースマップをオンにし、無効にするためにはカスタム設定が必要になる場合があります。

## Edgeメモリの問題

Next.js `v14.1.3`でEdge runtimeを使用する際のメモリ問題が修正されました。このバージョン（またはそれ以降）に更新して、問題が解決されるか確認してください。