---
title: 'パッケージバンドルの最適化'
nav_title: 'パッケージバンドル'
description: 'アプリケーションのサーバーとクライアントのバンドルを最適化する方法を学びます。'
related:
  description: '本番環境用にアプリケーションを最適化する方法をもっと詳しく学びます。'
  links:
    - 'app/building-your-application/deploying/production-checklist'
---

外部パッケージをバンドル化することで、アプリケーションのパフォーマンスを大幅に向上させることができます。<AppOnly>デフォルトでは、Server ComponentとRoute Handler内でインポートされたパッケージはNext.jsによって自動的にバンドル化されます。このページでは、パッケージバンドルの分析とさらに最適化する方法についてご案内します。</AppOnly><PagesOnly>デフォルトでは、アプリケーションにインポートされたパッケージはバンドル化されません。これにより、パフォーマンスに影響を及ぼしたり、モノレポや`node_modules`からインポートされた場合に外部パッケージが事前にバンドル化されていないと機能しないことがあります。このページでは、パッケージバンドルを分析し、設定する方法を説明します。</PagesOnly>

## JavaScriptバンドルの分析

[`@next/bundle-analyzer`](https://www.npmjs.com/package/@next/bundle-analyzer)はNext.jsのプラグインで、アプリケーションバンドルのサイズを管理するのに役立ちます。各パッケージとその依存関係のサイズの視覚的なレポートを生成します。この情報を使って、大きな依存関係を削除したり、コードを分割または[遅延読み込み](/docs/app/building-your-application/optimizing/lazy-loading)することができます。

### インストール

以下のコマンドを実行してプラグインをインストールします。

```bash
npm i @next/bundle-analyzer
# または
yarn add @next/bundle-analyzer
# または
pnpm add @next/bundle-analyzer
```

次に、`next.config.js`にバンドルアナライザーの設定を追加します。

```js filename="next.config.js"
/** @type {import('next').NextConfig} */
const nextConfig = {}

const withBundleAnalyzer = require('@next/bundle-analyzer')({
  enabled: process.env.ANALYZE === 'true',
})

module.exports = withBundleAnalyzer(nextConfig)
```

### レポートの生成

以下のコマンドを実行してバンドルを分析します。

```bash
ANALYZE=true npm run build
# または
ANALYZE=true yarn build
# または
ANALYZE=true pnpm build
```

レポートはブラウザに新しいタブとして開かれるので、確認することができます。定期的にアプリケーションのバンドルを評価することで、時間が経つにつれてアプリケーションのパフォーマンスを維持するのに役立ちます。

## パッケージインポートの最適化

Iconライブラリのような特定のパッケージは、何百ものモジュールをエクスポートすることがあり、開発と本番環境でのパフォーマンスの問題を引き起こす可能性があります。

これらのパッケージをどのようにインポートするかを最適化するには、`next.config.js`に[`optimizePackageImports`](/docs/app/api-reference/next-config-js/optimizePackageImports)オプションを追加します。このオプションは実際に使用するモジュールのみをロードし、多数の名前付きエクスポートを含むインポート文を書く利便性を提供します。

```js filename="next.config.js"
/** @type {import('next').NextConfig} */
const nextConfig = {
  experimental: {
    optimizePackageImports: ['icon-library'],
  },
}

module.exports = nextConfig
```

Next.jsはいくつかのライブラリを自動的に最適化するため、optimizePackageImportsリストに含める必要はありません。 [完全なリスト](https://nextjs.org/docs/app/api-reference/next-config-js/optimizePackageImports)をご覧ください。

<PagesOnly>

## 特定のパッケージのバンドル化

特定のパッケージをバンドル化するには、`next.config.js`で[`transpilePackages`](/docs/app/api-reference/next-config-js/transpilePackages)オプションを使用します。このオプションは、事前にバンドル化されていない外部パッケージをバンドル化するのに便利です。例えば、モノレポや`node_modules`からインポートした場合です。

```js filename="next.config.js"
/** @type {import('next').NextConfig} */
const nextConfig = {
  transpilePackages: ['package-name'],
}

module.exports = nextConfig
```

## 全パッケージのバンドル化

全パッケージを自動的にバンドル化するには（app routerのデフォルト設定）、`next.config.js`で[`bundlePagesRouterDependencies`](/docs/pages/api-reference/next-config-js/bundlePagesRouterDependencies)オプションを使用します。

```js filename="next.config.js"
/** @type {import('next').NextConfig} */
const nextConfig = {
  bundlePagesRouterDependencies: true,
}

module.exports = nextConfig
```

## 特定のパッケージのバンドル化からの除外

[`bundlePagesRouterDependencies`](/docs/pages/api-reference/next-config-js/bundlePagesRouterDependencies)オプションを有効にした場合、`next.config.js`で[`serverExternalPackages`](/docs/pages/api-reference/next-config-js/serverExternalPackages)オプションを使用して、特定のパッケージを自動的なバンドル化から除外できます。

```js filename="next.config.js"
/** @type {import('next').NextConfig} */
const nextConfig = {
  // Pages Routerで外部パッケージを自動的にバンドル:
  bundlePagesRouterDependencies: true,
  // AppおよびPages Routerの両方でバンドルから特定のパッケージを除外:
  serverExternalPackages: ['package-name'],
}

module.exports = nextConfig
```

</PagesOnly>

<AppOnly>

## 特定のパッケージのバンドル化からの除外

Server ComponentとRoute Handler内でインポートされたパッケージはNext.jsによって自動的にバンドル化されるため、`next.config.js`で[`serverExternalPackages`](/docs/app/api-reference/next-config-js/serverExternalPackages)オプションを使用して特定のパッケージをバンドル化から除外できます。

```js filename="next.config.js"
/** @type {import('next').NextConfig} */
const nextConfig = {
  serverExternalPackages: ['package-name'],
}

module.exports = nextConfig
```

Next.jsは現在も互換性を維持するために作業中の人気パッケージのリストを含んでおり、これらは自動的に除外されています。[完全なリスト](/docs/app/api-reference/next-config-js/serverExternalPackages)をご覧ください。

</AppOnly>