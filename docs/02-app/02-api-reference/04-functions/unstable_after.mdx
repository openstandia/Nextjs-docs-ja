---
title: 'unstable_after'
description: 'after 関数の API リファレンス。'
version: '不安定'
---

`unstable_after` は、レスポンス（または prerender）が終了した後に実行される作業をスケジュールするために使用されます。これは、ログや分析など、レスポンスをブロックしてはいけないタスクや他の副作用に役立ちます。

これは [Server Components](/docs/app/building-your-application/rendering/server-components)（[`generateMetadata`](https://nextjs.org/docs/app/api-reference/functions/generate-metadata)を含む）、[Server Actions](/docs/app/building-your-application/data-fetching/server-actions-and-mutations)、[Route Handlers](/docs/app/building-your-application/routing/route-handlers) および [Middleware](/docs/app/building-your-application/routing/middleware) で使用できます。

この関数は、レスポンス（または prerender）が終了した後に実行されるコールバックを受け付けます：

```tsx title="app/layout.tsx"
import { unstable_after as after } from 'next/server'
// カスタムログ関数
import { log } from '@/app/utils'

export default function Layout({ children }: { children: React.ReactNode }) {
  after(() => {
    // レイアウトがレンダリングされてユーザーに送信された後に実行
    log()
  })
  return <>{children}</>
}
```

```jsx filename="app/layout.js"
import { unstable_after as after } from 'next/server'
// カスタムログ関数
import { log } from '@/app/utils'

export default function Layout({ children }) {
  after(() => {
    // レイアウトがレンダリングされてユーザーに送信された後に実行
    log()
  })
  return <>{children}</>
}
```

> **Good to know:** `unstable_after` は [Dynamic API](/docs/app/building-your-application/rendering/server-components#dynamic-apis)ではなく、呼び出してもルートがダイナミックになることはありません。静的ページ内で使用される場合、ビルド時またはページが再検証されるときにコールバックが実行されます。

## リファレンス {#reference}

### パラメータ {#parameters}

- レスポンス（または prerender）が終了した後に実行されるコールバック関数

### サーバーレス関数の持続時間 {#serverless-function-duration}

`unstable_after` は、プラットフォームのデフォルトまたは設定されたサーバーレス関数の最大持続時間で実行されます。プラットフォームが対応している場合、[`maxDuration`](/docs/app/api-reference/file-conventions/route-segment-config#maxduration) ルートセグメント設定を使用してタイムアウト制限を設定できます。

## Good to know {#good-to-know}

- `unstable_after` は、レスポンスが正常に完了しなかった場合でも実行されます。エラーがスローされた場合や、`notFound` や `redirect` が呼び出された場合を含みます。
- React の `cache` を使用して `unstable_after` 内で呼び出された関数を重複排除できます。
- [`cookies`](/docs/app/api-reference/functions/cookies) は、レスポンスがすでに送信されているため、`unstable_after` 内で設定することはできません。
- [Dynamic APIs](/docs/app/building-your-application/rendering/server-components#dynamic-apis) は `unstable_after` 内で呼び出すことはできません。それらを `unstable_after` の外で呼び出し、返されたオブジェクトを使用してください。
- `unstable_after` は、他の `unstable_after` 呼び出しの中にネストさせて使用できます。たとえば、`unstable_after` 呼び出しをラップして追加機能を提供するユーティリティ関数を作成できます。

## 代替手段 {#alternatives}

`unstable_after` の使用ケースは、主要なレスポンスをブロックせずに二次的なタスクを処理することです。プラットフォームの [`waitUntil()`](https://vercel.com/docs/functions/functions-api-reference) を使用したり、Promise から `await` を外したりすることに似ていますが、以下の違いがあります：

- **`waitUntil()`**: Promise を受け取り、リクエストのライフサイクル中に実行されるタスクをキューに入れます。これに対して、`unstable_after` はレスポンスが終了した**後**に実行されるコールバックを受け取ります。
- **`await` を取り除く**: レスポンス中に実行が開始され、リソースを使用します。レスポンスが送信された後、サーバーレス環境では関数が計算を直ちに停止するため、タスクが中断される可能性があり、信頼性がありません。

その他の Next.js の API とコンテキストを考慮して設計されている `unstable_after` の使用を推奨します。

| バージョン履歴 | 説明                                |
| -------------- | ----------------------------------- |
| `v15.0.0-rc`   | `unstable_after` が導入されました。 |
