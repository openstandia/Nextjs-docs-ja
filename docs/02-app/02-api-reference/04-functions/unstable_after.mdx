---
title: 'unstable_after'
description: 'after 関数のAPIリファレンス。'
---

`unstable_after` は、レスポンスが完了した後に実行される作業をスケジュールできるようにします。これはログや分析など、レスポンスをブロックすべきでないタスクやその他の副作用にも有用です。

これは、[Server Components](/docs/app/building-your-application/rendering/server-components)（[`generateMetadata`](https://nextjs.org/docs/app/api-reference/functions/generate-metadata)を含む）、[Server Actions](/docs/app/building-your-application/data-fetching/server-actions-and-mutations)、[Route Handlers](/docs/app/building-your-application/routing/route-handlers)、および[Middleware](/docs/app/building-your-application/routing/middleware)で使用できます。

この関数は、レスポンスが完了した後に実行されるコールバックを受け取ります：

```tsx title="app/layout.tsx switcher
import { unstable_after as after } from 'next/server'
// カスタムログ関数
import { log } from '@/app/utils'

export default function Layout({ children }: { children: React.ReactNode }) {
  after(() => {
    // レイアウトがレンダリングされ、ユーザーに送信された後に実行
    log()
  })
  return <>{children}</>
}
```

```jsx filename="app/layout.js switcher
import { unstable_after as after } from 'next/server'
// カスタムログ関数
import { log } from '@/app/utils'

export default function Layout({ children }) {
  after(() => {
    // レイアウトがレンダリングされ、ユーザーに送信された後に実行
    log()
  })
  return <>{children}</>
}
```

## リファレンス {#reference}

### パラメータ {#parameters}

- レスポンスが完了した後に実行されるコールバック関数

### サーバーレス関数の実行時間 {#serverless-function-duration}

`unstable_after` は、プラットフォームのデフォルトまたは設定されたサーバーレス関数の最大実行時間に従って実行されます。プラットフォームが対応している場合、[`maxDuration`](/docs/app/api-reference/file-conventions/route-segment-config#maxduration)ルートセグメントの設定を使用してタイムアウトリミットを設定できます。

## 知っておくと良いこと {#good-to-know}

- レスポンスが正常に完了しなかった場合にも `unstable_after` が実行されます。エラーが発生したときや、`notFound` や `redirect` が呼び出されたときも含まれます。
- `unstable_after` はルートを動的レンダリングにオプトインする[動的API](/docs/app/building-your-application/rendering/server-components#dynamic-apis)です。この動作は、[`export dynamic = "force-static"`](/docs/app/api-reference/file-conventions/route-segment-config#dynamic)セグメント設定でオーバーライドできます。
- `unstable_after`内で呼び出される関数を重複排除するためにReactの `cache` を使用できます。
- `cookies` は `unstable_after` 内で設定できません。なぜなら、レスポンスはすでに送信されているからです。
- `unstable_after` は他の `unstable_after` 呼び出しの中にネストすることができます。たとえば、さらなる機能を追加するために `unstable_after` 呼び出しをラップするユーティリティ関数を作成できます。

## 代替手段 {#alternatives}

`unstable_after` のユースケースは、主要なレスポンスをブロックせずに副次的なタスクを処理することです。プラットフォームの[`waitUntil()`](https://vercel.com/docs/functions/functions-api-reference) を使用するか、promiseから `await` を削除することに似ていますが、以下の違いがあります：

- **`waitUntil()`**: promise を受け取り、リクエストのライフサイクル中に実行されるタスクをキューに入れます。`unstable_after` は、レスポンスが完了した**後に**実行されるコールバックを受け取ります。
- **`await` を削除する**: レスポンス中に実行を開始し、リソースを使用します。また、レスポンスが送信された直後に関数が計算を停止するため、サーバーレス環境では信頼性に欠ける場合があります。

その他のNext.jsのAPIやコンテキストを考慮して設計されているため、`unstable_after` の使用を推奨します。

| バージョン履歴 | 説明                                |
| -------------- | ----------------------------------- |
| `v15.0.0-rc`   | `unstable_after` が導入されました。 |
