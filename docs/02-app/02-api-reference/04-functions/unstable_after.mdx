---
title: 'unstable_after'
description: 'after関数のAPIリファレンス。'
---

`unstable_after`を使用すると、レスポンスが完了した後に実行されるワークをスケジュールできます。これは、ロギングやアナリティクスなど、レスポンスをブロックするべきではないタスクやその他の副作用に役立ちます。

これは、[Server Component](/docs/app/building-your-application/rendering/server-components)（[`generateMetadata`](https://nextjs.org/docs/app/api-reference/functions/generate-metadata)も含む）、[Server Actions](/docs/app/building-your-application/data-fetching/server-actions-and-mutations)、[Route Handlers](/docs/app/building-your-application/routing/route-handlers)、および[Middleware](/docs/app/building-your-application/routing/middleware)で使用できます。

この関数は、レスポンスが完了した後に実行されるコールバックを受け取ります：

```tsx filename="app/layout.tsx switcher
import { unstable_after as after } from 'next/server'
// カスタムロギング関数
import { log } from '@/app/utils'

export default function Layout({ children }: { children: React.ReactNode }) {
  after(() => {
    // レイアウトがレンダリングされ、ユーザーに送信された後に実行されます
    log()
  })
  return <>{children}</>
}
```

```jsx filename="app/layout.js switcher
import { unstable_after as after } from 'next/server'
// カスタムロギング関数
import { log } from '@/app/utils'

export default function Layout({ children }) {
  after(() => {
    // レイアウトがレンダリングされ、ユーザーに送信された後に実行されます
    log()
  })
  return <>{children}</>
}
```

## リファレンス

### パラメーター

- レスポンスが完了した後に実行されるコールバック関数

### サーバーレス関数の持続時間

`unstable_after`は、プラットフォームのデフォルトまたはサーバーレス関数の設定された最大持続時間で実行されます。プラットフォームが対応している場合、[`maxDuration`](/docs/app/api-reference/file-conventions/route-segment-config#maxduration) route segment configを使用してタイムアウト制限を設定できます。

## 知っておくとよいこと

- `unstable_after`は、レスポンスが正常に完了しなかった場合でも、エラーがスローされた場合や`notFound`または`redirect`が呼び出された場合にも実行されます。
- `unstable_after`は、routeを動的レンダリングに切り替える[Dynamic API](/docs/app/building-your-application/rendering/server-components#dynamic-apis)です。この動作は、[`export dynamic = "force-static"`](/docs/app/api-reference/file-conventions/route-segment-config#dynamic) segment configで上書きすることができます。
- `unstable_after`の内部で呼び出される関数を重複排除するために、Reactの`cache`を使用できます。
- `unstable_after`内で[`cookies`](/docs/app/api-reference/functions/cookies)を設定することはできません。レスポンスはすでに送信されているためです。
- `unstable_after`は、他の`unstable_after`呼び出しの内部にネストできます。たとえば、追加の機能を追加するために`unstable_after`呼び出しをラップするユーティリティ関数を作成できます。

## 代替案

`unstable_after`の使用例は、主要なレスポンスをブロックせずに二次的なタスクを処理することです。これは、プラットフォームの[`waitUntil()`](https://vercel.com/docs/functions/functions-api-reference)を使用するか、プロミスから`await`を削除することに似ていますが、以下の違いがあります：

- **`waitUntil()`**: プロミスを受け入れ、リクエストのライフサイクル中にタスクをキューに入れて実行しますが、`unstable_after`はレスポンスが完了した**後**に実行されるコールバックを受け入れます。
- **`await`を削除**: レスポンスの間に実行を開始し、リソースを使用します。また、サーバーレス環境では信頼性が低く、レスポンスが送信された直後に関数が計算を停止するため、タスクを中断する可能性があります。

`unstable_after`は、他のNext.js APIやコンテキストを考慮して設計されているため、使用をお勧めします。

| バージョン履歴   | 説明                          |
| --------------- | ---------------------------- |
| `v15.0.0-rc`    | `unstable_after`が導入されました。 |