---
title: 'instrumentation.js'
description: 'instrumentation.js ファイルの API リファレンス'
related:
  title: 'Instrumentationについてもっと学ぶ'
  links:
    - app/building-your-application/optimizing/instrumentation
---

`instrumentation.js|ts`ファイルは、アプリケーションに観測ツールを統合するために使用されます。これにより、パフォーマンスや動作を追跡し、製品環境での問題をデバッグできます。

使用するには、アプリケーションの**root**または[`src`フォルダ](/docs/app/building-your-application/configuring/src-directory)の中にこのファイルを配置してください。

## エクスポート {#exports}

### `register`（オプション） {#register-optional}

このファイルは、新しい Next.js サーバーインスタンスが開始されるときに**一度**呼び出される`register`関数をエクスポートします。`register`は非同期関数にすることもできます。

<Tabs>
<TabItem value="ts" label="TypeScript">

```ts title="instrumentation.ts" switcher
import { registerOTel } from '@vercel/otel'

// register 関数をエクスポート
export function register() {
  registerOTel('next-app') // next-app を登録
}
```

</TabItem>
<TabItem value="js" label="JavaScript">

```js title="instrumentation.js" switcher
import { registerOTel } from '@vercel/otel'

// register 関数をエクスポート
export function register() {
  registerOTel('next-app') // next-app を登録
}
```

</TabItem>
</Tabs>

### `onRequestError`（オプション） {#onrequesterror-optional}

> このAPIはNext.js canaryで利用可能です。

カスタムの観測プロバイダーに**サーバー**エラーを追跡するために、`onRequestError`関数をオプションでエクスポートすることができます。

- `onRequestError`で非同期タスクを実行する場合は、それらが確実に待たれるようにしてください。`onRequestError`は、Next.js サーバーがエラーをキャプチャしたときにトリガーされます。
- `error` インスタンスは、Server Componentsのレンダリング中に遭遇した場合、Reactによって処理される可能性があるため、元のエラーインスタンスではない場合があります。この場合、エラーに対して`digest`プロパティを使用して実際のエラータイプを識別できます。

<Tabs>
<TabItem value="ts" label="TypeScript">

```ts title="instrumentation.ts" switcher
import { type Instrumentation } from 'next'

// onRequestError 関数を非同期にエクスポート
export const onRequestError: Instrumentation.onRequestError = async (
  err,
  request,
  context
) => {
  // エラーを報告するための非同期フェッチ
  await fetch('https://.../report-error', {
    method: 'POST', // HTTP メソッドとしてPOSTを使用
    body: JSON.stringify({
      message: err.message,
      request,
      context,
    }),
    headers: {
      'Content-Type': 'application/json', // JSONとして送信
    },
  })
}
```

</TabItem>
<TabItem value="js" label="JavaScript">

```js title="instrumentation.js" switcher
// onRequestError 関数を非同期にエクスポート
export async function onRequestError(err, request, context) {
  // エラーを報告するための非同期フェッチ
  await fetch('https://.../report-error', {
    method: 'POST', // HTTP メソッドとしてPOSTを使用
    body: JSON.stringify({
      message: err.message,
      request,
      context,
    }),
    headers: {
      'Content-Type': 'application/json', // JSONとして送信
    },
  })
}
```

</TabItem>
</Tabs>

#### パラメータ {#parameters}

この関数は3つのパラメータ：`error`、`request`、および`context`を受け取ります。

```ts title="Types"
// onRequestError 関数の型定義
export function onRequestError(
  error: { digest: string } & Error, // digest プロパティを持つエラー
  request: {
    path: string // リソースのパス e.g. /blog?name=foo
    method: string // リクエストメソッド e.g. GET, POST など
    headers: { [key: string]: string } // ヘッダーのキーと値
  },
  context: {
    routerKind: 'Pages Router' | 'App Router' // ルーターのタイプ
    routePath: string // ルートファイルのパス e.g. /app/blog/[dynamic]
    routeType: 'render' | 'route' | 'action' | 'middleware' // エラーが発生したコンテキスト
    renderSource:
      | 'react-server-components'
      | 'react-server-components-payload'
      | 'server-rendering' // レンダリングのソース
    revalidateReason: 'on-demand' | 'stale' | undefined // 定期的に再検証される理由 未定義の場合は通常のリクエスト
    renderType: 'dynamic' | 'dynamic-resume' // PPR の場合は 'dynamic-resume'
  }
): void | Promise<void> // 関数の戻り値
```

- `error`: 捕捉されたエラーそのもの（型は常に`Error`）と、エラーのユニークなIDである`digest`プロパティ。
- `request`: エラーに関連する読み取り専用のリクエスト情報。
- `context`: エラーが発生したコンテキスト。これには、ルーターのタイプ（App または Pages Router）、サーバーコンポーネント（render）、ルートハンドラー（route）、サーバーアクション（action）、またはミドルウェア（middleware）が含まれます。

### ランタイムの指定 {#specifying-the-runtime}

`instrumentation.js`ファイルは、Node.jsおよびEdgeランタイムの両方で動作しますが、特定のランタイムをターゲットにするために`process.env.NEXT_RUNTIME`を使用できます。

```js title="instrumentation.js"
// register 関数のランタイムを特定のものに紐づける
export function register() {
  if (process.env.NEXT_RUNTIME === 'edge') {
    return require('./register.edge') // edge用の登録ファイル
  } else {
    return require('./register.node') // node用の登録ファイル
  }
}

// onRequestError 関数のランタイムを特定のものに紐づける
export function onRequestError() {
  if (process.env.NEXT_RUNTIME === 'edge') {
    return require('./on-request-error.edge') // edge用のエラーファイル
  } else {
    return require('./on-request-error.node') // node用のエラーファイル
  }
}
```

## バージョン履歴 {#version-history}

| Version      | 変更内容                                                |
| ------------ | ------------------------------------------------------- |
| `v15.0.0-RC` | `onRequestError`が導入され、`instrumentation`が安定版に |
| `v14.0.4`    | `instrumentation`に対するTurbopackサポート              |
| `v13.2.0`    | `instrumentation`が実験的な機能として導入された         |
