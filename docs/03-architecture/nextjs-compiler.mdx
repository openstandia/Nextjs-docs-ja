---
title: 'Next.js コンパイラ'
description: 'Rust で書かれた Next.js コンパイラは、Next.js アプリケーションを変換し、圧縮します。'
---

Rustで書かれたNext.jsコンパイラは、[SWC](https://swc.rs/)を使用して、Next.jsがJavaScriptコードを変換し、本番環境で圧縮することを可能にします。これにより、Babelによる個々のファイルの処理や、出力バンドルの圧縮に使われていたTerserを置き換えます。

Next.jsコンパイラを使用すると、Babelよりも17倍速いコンパイルが可能で、Next.js バージョン12以降デフォルトで有効になっています。すでにBabelの設定を持っていたり、[サポートされていない機能](#unsupported-features)を使用している場合、アプリケーションはNext.jsコンパイラからオプトアウトし、Babelの使用を続けます。

## なぜSWCを選んだのか {#why-swc}

[SWC](https://swc.rs/)は、次世代の高速開発ツールのための、拡張可能なRustベースのプラットフォームです。

SWCはコンパイル、圧縮、バンドルなどに使用でき、拡張することが設計されています。組み込みまたはカスタムのコード変換を実行するために呼び出すことができ、それらの変換はNext.jsのような高レベルのツールを通じて実行されます。

私たちがSWCをベースに選んだ理由は次のとおりです：

- **拡張性：** SWCはNext.js内でCrateとして利用でき、ライブラリをフォークしたり、設計制約を回避したりする必要がありません
- **パフォーマンス：** Fast Refreshで約3倍、ビルドで約5倍の高速化をSWCに切り替えることで実現し、さらに最適化の余地も残されています
- **WebAssembly：** RustのWASMのサポートは、可能な全てのプラットフォームをサポートし、Next.js開発をどこへでも持っていくために不可欠です
- **コミュニティ：** Rustのコミュニティとエコシステムは素晴らしく、成長し続けています

## サポートされている機能 {#supported-features}

### Styled Components {#styled-components}

`babel-plugin-styled-components`をNext.js コンパイラに移植する作業を進めています。

まず、Next.jsの最新バージョンに更新します：`npm install next@latest`。その後、`next.config.js`ファイルを更新してください：

```js title="next.config.js"
module.exports = {
  compiler: {
    styledComponents: true,
  },
}
```

高度なユースケースには、styled-componentsコンパイルのための個別のプロパティを設定できます。

> 注意：`ssr`と`displayName`の変換は、Next.jsで`styled-components`を使用するための主な要件です。

```js title="next.config.js"
module.exports = {
  compiler: {
    // オプションの詳細はhttps://styled-components.com/docs/tooling#babel-pluginを参照してください。
    styledComponents: {
      // 開発時にはデフォルトで有効化されており、ファイルサイズを減少させるために本番環境では無効化されます。
      // これを設定すると、すべての環境でのデフォルトが上書きされます。
      displayName?: boolean,
      // デフォルトでは有効化されています。
      ssr?: boolean,
      // デフォルトでは有効化されています。
      fileName?: boolean,
      // デフォルトでは空です。
      topLevelImportPaths?: string[],
      // デフォルトは["index"]です。
      meaninglessFileNames?: string[],
      // デフォルトでは有効化されています。
      minify?: boolean,
      // デフォルトでは有効化されています。
      transpileTemplateLiterals?: boolean,
      // デフォルトでは空です。
      namespace?: string,
      // デフォルトでは無効化されています。
      pure?: boolean,
      // デフォルトでは有効化されています。
      cssProp?: boolean,
    },
  },
}
```

### Jest {#jest}

Next.js コンパイラはテストをトランスパイルし、Next.jsとJestの設定を簡素化します。以下を含みます：

- `.css`、`.module.css`（およびその`.scss`バリアント）、画像のインポートの自動モック
- SWCを使用した`transform`の自動設定
- `.env`（およびそのすべてのバリアント）の`process.env`への読み込み
- `node_modules`をテストの解決および変換から無視
- テストの解決から`.next`を無視
- 実験的なSWC変換を有効にするフラグのために`next.config.js`をロード

まず、Next.jsの最新バージョンに更新します：`npm install next@latest`。その後、`jest.config.js`ファイルを更新してください：

```js title="jest.config.js"
const nextJest = require('next/jest')

// Next.jsアプリへのパスを提供し、next.config.jsと.envファイルの読み込みを可能にします
const createJestConfig = nextJest({ dir: './' })

// Jestに渡したいカスタム設定
const customJestConfig = {
  setupFilesAfterEnv: ['<rootDir>/jest.setup.js'],
}

// createJestConfigは、next/jestがNext.jsの設定を読み込むことを保証するために、非同期でこの方法でエクスポートされます
module.exports = createJestConfig(customJestConfig)
```

### Relay {#relay}

[Relay](https://relay.dev/)サポートを有効にするには：

```js title="next.config.js"
module.exports = {
  compiler: {
    relay: {
      // relay.config.jsと一致させる必要があります
      src: './',
      artifactDirectory: './__generated__',
      language: 'typescript',
      eagerEsModules: false,
    },
  },
}
```

> **Good to know**: Next.jsでは、`pages`ディレクトリ内のすべてのJavaScriptファイルがルートと見なされます。そのため、`relay-compiler`を使用するには、`artifactDirectory`の設定を`pages`の外側で指定する必要があります。そうしないと、`relay-compiler`は`__generated__`ディレクトリ内のソースファイルの隣にファイルを生成し、このファイルはルートと見なされ、本番ビルドが壊れる原因になります。

### React プロパティの削除 {#remove-react-properties}

JSXプロパティを削除することができます。これはテストによく使用されます。`babel-plugin-react-remove-properties`に似ています。

デフォルトの正規表現`^data-test`に一致するプロパティを削除するには：

```js title="next.config.js"
module.exports = {
  compiler: {
    reactRemoveProperties: true,
  },
}
```

カスタムプロパティを削除するには：

```js title="next.config.js"
module.exports = {
  compiler: {
    // ここで定義された正規表現はRustで処理されるため、JavaScriptの`RegExp`とは構文が異なります。
    // 詳細はhttps://docs.rs/regexを参照してください。
    reactRemoveProperties: { properties: ['^data-custom$'] },
  },
}
```

### コンソールの削除 {#remove-console}

この変換を使用すると、アプリケーションコード（`node_modules`は含まない）のすべての`console.*`呼び出しを削除できます。`babel-plugin-transform-remove-console`に似ています。

すべての`console.*`呼び出しを削除するには：

```js title="next.config.js"
module.exports = {
  compiler: {
    removeConsole: true,
  },
}
```

`console.error`を除いたすべての`console.*`出力を削除するには：

```js title="next.config.js"
module.exports = {
  compiler: {
    removeConsole: {
      exclude: ['error'],
    },
  },
}
```

### レガシーデコレータ {#legacy-decorators}

Next.jsは`jsconfig.json` または`tsconfig.json`において `experimentalDecorators` を自動的に検出します。レガシーデコレータは、`mobx`の古いバージョンのライブラリと共に使用されることが一般的です。

このフラグは、既存のアプリケーションとの互換性のためにのみサポートされています。新しいアプリケーションでレガシーデコレータを使用することは推奨されません。

まず、Next.jsの最新バージョンに更新します：`npm install next@latest`。その後、`jsconfig.json`または`tsconfig.json`ファイルを更新してください：

```js
{
  "compilerOptions": {
    "experimentalDecorators": true
  }
}
```

### importSource {#importsource}

Next.jsは `jsconfig.json` または `tsconfig.json` における `jsxImportSource` を自動的に検出し、それを適用します。これは [Theme UI](https://theme-ui.com)のようなライブラリと共に使用されることが一般的です。

まず、Next.jsの最新バージョンに更新します：`npm install next@latest`。その後、`jsconfig.json`または`tsconfig.json`ファイルを更新してください：

```js
{
  "compilerOptions": {
    "jsxImportSource": "theme-ui"
  }
}
```

### Emotion {#emotion}

`@emotion/babel-plugin`をNext.js コンパイラに移植する作業を進めています。

まず、Next.jsの最新バージョンに更新します：`npm install next@latest`。その後、`next.config.js`ファイルを更新してください：

```js title="next.config.js"

module.exports = {
  compiler: {
    emotion: boolean | {
      // デフォルトはtrueです。ビルドタイプが本番の場合に無効化されます。
      sourceMap?: boolean,
      // デフォルトは 'dev-only'です。
      autoLabel?: 'never' | 'dev-only' | 'always',
      // デフォルトは '[local]'です。
      // 許可される値：`[local]` `[filename]` `[dirname]`
      // このオプションは、autoLabel が 'dev-only' あるいは 'always' に設定されている場合のみ機能します。
      // これは最終的なラベルのフォーマットを指定します。
      // フォーマットは、変数部分を角括弧[]で囲んだ文字列で定義されます。
      // たとえば、"my-classname--[local]"というラベルフォーマットを指定すると、[local]は結果が割り当てられる変数名に置き換えられます。
      labelFormat?: string,
      // デフォルトはundefinedです。
      // このオプションを使用すると、コンパイラに何のインポートを変換するべきかを
      // 伝えることができ、Emotionのエクスポートを再エクスポートした場合でも、変換を使用できます。
      importMap?: {
        [packageName: string]: {
          [exportName: string]: {
            canonicalImport?: [string, string],
            styledBaseImport?: [string, string],
          }
        }
      },
    },
  },
}
```

### 圧縮 {#minification}

v13以降、Next.jsのswcコンパイラがデフォルトで圧縮に使用されます。これはTerserよりも7倍速いです。

> **Good to know:** v15以降、圧縮は `next.config.js` でカスタマイズできなくなりました。 `swcMinify` フラグのサポートは削除されました。

### モジュールのトランスパイル {#module-transpilation}

Next.jsはローカルパッケージ（モノレポのような）や外部依存（`node_modules`）からの依存を自動的にトランスパイルおよびバンドルすることができます。これは `next-transpile-modules` パッケージを置き換えます。

```js title="next.config.js"
module.exports = {
  transpilePackages: ['@acme/ui', 'lodash-es'],
}
```

### インポートのモジュール化 {#modularize-imports}

このオプションは、Next.js 13.5の[`optimizePackageImports`](/docs/app/api-reference/config/next-config-js/optimizePackageImports)によって置き換えられました。インポートパスを手動で設定する必要がない新しいオプションにアップグレードすることをお勧めします。

### 定義（ビルド時に変数を置換する） {#define-replacing-variables-during-build}

`define` オプションを使用すると、コード内の変数をビルド時に静的に置換できます。このオプションはキー-値のペアとしてオブジェクトを受け取り、キーは対応する値で置き換えられる変数です。

`next.config.js`に`compiler.define`フィールドを使用します：

```js title="next.config.js"
module.exports = {
  compiler: {
    define: {
      MY_STRING_VARIABLE: JSON.stringify('my-string'),
      MY_NUMBER_VARIABLE: '42',
    },
  },
}
```

## 実験的な機能 {#experimental-features}

### SWC トレースプロファイリング {#swc-trace-profiling}

SWCの内部変換トレースをChromiumの[トレースイベントフォーマット](https://docs.google.com/document/d/1CvAClvFfyA5R-PhYUmn5OOQtYMH4h6I0nSsKchNAySU/preview?mode=html#%21=)として生成できます。

```js title="next.config.js"
module.exports = {
  experimental: {
    swcTraceProfiling: true,
  },
}
```

有効化されると、swcは`.next/`以下に`swc-trace-profile-${timestamp}.json`という名前のトレースを生成します。Chromiumのトレースビューア（chrome://tracing/, https://ui.perfetto.dev/）や、互換性のあるフレームグラフビューア（https://www.speedscope.app/）が生成されたトレースを読み込み、可視化できます。

### SWCプラグイン（実験的） {#swc-plugins-experimental}

Wasmで書かれたSWCの実験的なプラグインサポートを使用して、変換の動作をカスタマイズするためにswcのトランスフォームを設定できます。

```js title="next.config.js"
module.exports = {
  experimental: {
    swcPlugins: [
      [
        'plugin',
        {
          ...pluginOptions,
        },
      ],
    ],
  },
}
```

`swcPlugins`は、プラグインを設定するためのタプルの配列を受け取ります。プラグインのタプルは、プラグインへのパスとプラグイン構成用のオブジェクトを含みます。プラグインへのパスは、npmモジュールパッケージ名または`.wasm`バイナリ自体への絶対パスにできます。

## サポートされていない機能 {#unsupported-features}

アプリケーションに`.babelrc`ファイルがある場合、Next.jsは個々のファイルの変換に自動的にBabelを使用します。これにより、カスタムBabelプラグインを利用している既存のアプリケーションとの後方互換性が保証されます。

カスタムBabel設定を使用している場合は、[設定を共有してください](https://github.com/vercel/next.js/discussions/30174)。よく使われるBabel変換を可能な限り多く移植し、将来的にはプラグインのサポートも検討しています。

## バージョン履歴 {#version-history}

| バージョン | 変更点                                                                                                                                                                                                                      |
| ---------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `v13.1.0`  | [モジュールのトランスパイル](https://nextjs.org/blog/next-13-1#built-in-module-transpilation-stable)と[インポートのモジュール化](https://nextjs.org/blog/next-13-1#import-resolution-for-smaller-bundles)が安定化しました。 |
| `v13.0.0`  | SWC Minifier がデフォルトで有効になりました。                                                                                                                                                                               |
| `v12.3.0`  | SWC Minifier が[安定版](https://nextjs.org/blog/next-12-3#swc-minifier-stable)になりました。                                                                                                                                |
| `v12.2.0`  | [SWCプラグイン](#swc-plugins-experimental)の実験的サポートが追加されました。                                                                                                                                                |
| `v12.1.0`  | Styled Components、Jest、Relay、React プロパティの削除、レガシーデコレータ、コンソールの削除、およびjsxImportSourceのサポートが追加されました。                                                                             |
| `v12.0.0`  | Next.js コンパイラが[導入](https://nextjs.org/blog/next-12)されました。                                                                                                                                                     |
