---
title: 'Next.js コンパイラ'
description: 'Next.js コンパイラはRustで書かれ、あなたの Next.js アプリケーションを変換し、最適化します。'
---

Next.js コンパイラは、Rustで書かれた [SWC](https://swc.rs/) を使用して、Next.js があなたのJavaScriptコードをプロダクション用に変換し、最適化します。これは個々のファイルに対するBabelや、出力バンドルを最適化するためのTerserに代わるものです。

Next.js コンパイラを使ったコンパイルはBabelに比べて17倍高速で、Next.js バージョン12以降はデフォルトで有効になっています。既存のBabelの設定がある場合や[未対応の機能](#unsupported-features)を使用している場合、アプリケーションはNext.js コンパイラをオプトアウトし、Babelを使用し続けます。

## なぜSWCか？ {#why-swc}

[SWC](https://swc.rs/)は、次世代の高速な開発者ツールのための拡張可能なRustベースのプラットフォームです。

SWCはコンパイル、最適化、バンドルなどのために使用でき、拡張を前提として設計されています。これは、組み込みもしくはカスタムによるコード変換を実行するために呼び出すことができます。それらの変換を実行するのは、Next.jsのような高次ツールを通じて行われます。

私たちはいくつかの理由でSWCを基盤とすることを選びました：

- **拡張性**：SWCはNext.jsの内部でCrateとして使用でき、ライブラリをフォークしたり設計制約を迂回する必要がありません
- **性能**：SWCに切り替えることで、Next.jsで約3倍速いFast Refreshと約5倍速いビルド速度を達成しました。まだ最適化の余地があります
- **WebAssembly**：RustのWASMサポートは、可能なすべてのプラットフォームをサポートし、Next.jsの開発をどこへでも持っていくために不可欠です
- **コミュニティ**：Rustのコミュニティとエコシステムは素晴らしく、今も成長しています

## サポートされている機能 {#supported-features}

### Styled Components {#styled-components}

`babel-plugin-styled-components` を Next.js コンパイラに移植する作業を進めています。

まず、最新のNext.jsにアップデートします：`npm install next@latest`。次に、`next.config.js`ファイルを更新します：

```js title="next.config.js"
module.exports = {
  compiler: {
    styledComponents: true,
  },
}
```

高度なユースケースについては、styled-components のコンパイルに対して個別のプロパティを設定できます。

> 注意: `ssr`と`displayName`の変換は、Next.js において `styled-components` を利用するための主要な要件です。

```js title="next.config.js"
module.exports = {
  compiler: {
    // オプションの詳細については https://styled-components.com/docs/tooling#babel-plugin を参照してください。
    styledComponents: {
      // 開発ではデフォルトで有効になっており、ファイルサイズを削減するためにプロダクションでは無効になっています。これを設定すると、すべての環境でデフォルトを上書きします。
      displayName?: boolean,
      // デフォルトで有効。
      ssr?: boolean,
      // デフォルトで有効。
      fileName?: boolean,
      // デフォルトでは空です。
      topLevelImportPaths?: string[],
      // デフォルトは["index"]です。
      meaninglessFileNames?: string[],
      // デフォルトで有効。
      minify?: boolean,
      // デフォルトで有効。
      transpileTemplateLiterals?: boolean,
      // デフォルトでは空です。
      namespace?: string,
      // デフォルトでは無効。
      pure?: boolean,
      // デフォルトで有効。
      cssProp?: boolean,
    },
  },
}
```

### Jest {#jest}

Next.js コンパイラはあなたのテストを変換し、JestとNext.jsの設定を簡素化します。対象には以下が含まれます：

- `.css`、`.module.css`（およびその `.scss` 変種）、画像のインポートを自動でモック
- SWCを使って自動的に`transform`を設定
- `.env`（およびそのすべての変種）を`process.env`に読み込み
- テストの解決と変換から`node_modules`を無視
- テストの解決から`.next`を無視
- インベントリ化するSWC変換を有効化するフラグ用に`next.config.js`を読み込み

まず、最新のNext.jsにアップデートします：`npm install next@latest`。次に、`jest.config.js`ファイルを更新します：

```js title="jest.config.js"
const nextJest = require('next/jest')

// next.config.js と .env ファイルの読み込みを可能にするあなたのNext.jsアプリへのパスを提供します
const createJestConfig = nextJest({ dir: './' })

// Jestに渡したいカスタム設定
const customJestConfig = {
  setupFilesAfterEnv: ['<rootDir>/jest.setup.js'],
}

// createJestConfigがNext.jsの設定をロードできるように、この方法でエクスポートします。これは非同期です
module.exports = createJestConfig(customJestConfig)
```

### Relay {#relay}

[Relay](https://relay.dev/) のサポートを有効にする：

```js title="next.config.js"
module.exports = {
  compiler: {
    relay: {
      // relay.config.js と一致させる必要があります
      src: './',
      artifactDirectory: './__generated__',
      language: 'typescript',
      eagerEsModules: false,
    },
  },
}
```

> **Good to know**: Next.jsでは、`pages`ディレクトリ内のすべてのJavaScriptファイルがルートと見なされます。そのため、`relay-compiler`では、`pages`の外で`artifactDirectory`の設定を指定する必要があります。そうでない場合、`relay-compiler`はソースファイルの横にファイルを`__generated__`ディレクトリに生成し、このファイルはルートと見なされ、プロダクションビルドが壊れます。

### React プロパティの削除 {#remove-react-properties}

JSXプロパティを削除することができます。これはテストでよく使用されます。`babel-plugin-react-remove-properties`に似ています。

デフォルトの正規表現`^data-test`に一致するプロパティを削除するには：

```js title="next.config.js"
module.exports = {
  compiler: {
    reactRemoveProperties: true,
  },
}
```

カスタムプロパティを削除するには：

```js title="next.config.js"
module.exports = {
  compiler: {
    // ここで定義された正規表現はRustで処理されるため、JavaScriptの`RegExp`とは異なる構文です。https://docs.rs/regex を参照してください。
    reactRemoveProperties: { properties: ['^data-custom$'] },
  },
}
```

### Console の削除 {#remove-console}

この変換はアプリケーションコード内のすべての`console.*`呼び出しを削除します（`node_modules`は対象外です）。`babel-plugin-transform-remove-console`に似ています。

すべての`console.*`呼び出しを削除するには：

```js title="next.config.js"
module.exports = {
  compiler: {
    removeConsole: true,
  },
}
```

`console.error`を除く`console.*`出力を削除するには：

```js title="next.config.js"
module.exports = {
  compiler: {
    removeConsole: {
      exclude: ['error'],
    },
  },
}
```

### レガシーデコレータ {#legacy-decorators}

Next.jsは`jsconfig.json`または`tsconfig.json`における`experimentalDecorators`を自動的に検出します。レガシーデコレータは`mobx`などの古いバージョンのライブラリでよく使われます。

このフラグは既存のアプリケーションとの互換性のためにのみサポートされています。新しいアプリケーションでレガシーデコレータを使用することは推奨しません。

まず、最新のNext.jsにアップデートします：`npm install next@latest`。次に、`jsconfig.json`または`tsconfig.json`ファイルを更新します：

```js
{
  "compilerOptions": {
    "experimentalDecorators": true
  }
}
```

### importSource {#importsource}

Next.jsは`jsconfig.json`または`tsconfig.json`における`jsxImportSource`を自動的に検出して適用します。これは[Theme UI](https://theme-ui.com)のようなライブラリでよく用いられます。

まず、最新のNext.jsにアップデートします：`npm install next@latest`。次に、`jsconfig.json`または`tsconfig.json`ファイルを更新します：

```js
{
  "compilerOptions": {
    "jsxImportSource": "theme-ui"
  }
}
```

### Emotion {#emotion}

`@emotion/babel-plugin`をNext.js コンパイラに移植する作業を進めています。

まず、最新のNext.jsにアップデートします：`npm install next@latest`。次に、`next.config.js`ファイルを更新します：

```js title="next.config.js"

module.exports = {
  compiler: {
    emotion: boolean | {
      // デフォルトはtrueです。ビルドタイプがプロダクションの場合に無効になります。
      sourceMap?: boolean,
      // デフォルトは'dev-only'です。
      autoLabel?: 'never' | 'dev-only' | 'always',
      // デフォルトは'[local]'です。
      // 許可される値: `[local]` `[filename]` `[dirname]`
      // このオプションはautoLabelが'dev-only'または'always'に設定されている場合のみ動作します。
      // これにより、結果のラベルのフォーマットを定義できます。
      // フォーマットは変数部分を角括弧 [] で囲んで文字列で定義します。
      // 例えば labelFormat: "my-classname--[local]" の場合、[local]はこれが割り当てられる変数の名前に置き換えられます。
      labelFormat?: string,
      // デフォルトでは未定義です。
      // コンパイラが変換すべきインポートを定義する際に使用します
      // あなたがEmotionのエクスポートを再エクスポートする場合でも変換を使用することができます。
      importMap?: {
        [packageName: string]: {
          [exportName: string]: {
            canonicalImport?: [string, string],
            styledBaseImport?: [string, string],
          }
        }
      },
    },
  },
}
```

### 最適化 {#minification}

Next.jsのswcコンパイラはv13以降デフォルトで最適化に使用されています。これはTerserよりも7倍速いです。

> **Good to know**: v15以降、最適化のカスタマイズは`next.config.js`では行えなくなりました。`swcMinify`フラグのサポートは削除されました。

### モジュールのトランスパイル {#module-transpilation}

Next.jsはローカルパッケージ（例えばモノレポ）や外部の依存関係（`node_modules`）からの依存を自動的にトランスパイルしてバンドルできます。これは`next-transpile-modules`パッケージに代わるものです。

```js title="next.config.js"
module.exports = {
  transpilePackages: ['@acme/ui', 'lodash-es'],
}
```

### インポートのモジュール化 {#modularize-imports}

このオプションは、Next.js 13.5で[`optimizePackageImports`](/docs/app/api-reference/config/next-config-js/optimizePackageImports)に置き換えられました。新しいインポートパスの手動設定が不要なオプションへアップグレードすることをお勧めします。

### 定義 (ビルド時に変数を置き換え) {#define-replacing-variables-during-build}

`define`オプションは、ビルド時にコード内の変数を静的に置き換えることを可能にします。
オプションは、キーが置き換えられるべき変数、値が対応する値であるキー-値ペアとしてオブジェクトを取ります。

`next.config.js`の`compiler.define`フィールドを使用します：

```js title="next.config.js"
module.exports = {
  compiler: {
    define: {
      MY_STRING_VARIABLE: JSON.stringify('my-string'),
      MY_NUMBER_VARIABLE: '42',
    },
  },
}
```

## 実験的機能 {#experimental-features}

### SWC トレースプロファイリング {#swc-trace-profiling}

Chromiumの[トレースイベント形式](https://docs.google.com/document/d/1CvAClvFfyA5R-PhYUmn5OOQtYMH4h6I0nSsKchNAySU/preview?mode=html#%21=)としてSWCの内部変換トレースを生成できます。

```js title="next.config.js"
module.exports = {
  experimental: {
    swcTraceProfiling: true,
  },
}
```

有効化すると、swcは`.next/`内に`swc-trace-profile-${timestamp}.json`という名前でトレースを生成します。Chromiumのトレースビューアー（chrome://tracing/, https://ui.perfetto.dev/）や対応するフレームグラフビューアー（https://www.speedscope.app/）で生成されたトレースを読み込み、可視化できます。

### SWC プラグイン (実験的) {#swc-plugins-experimental}

SWCの変換をカスタマイズするために、WASMで書かれたSWCの実験的プラグインサポートを使用するように設定できます。

```js title="next.config.js"
module.exports = {
  experimental: {
    swcPlugins: [
      [
        'plugin',
        {
          ...pluginOptions,
        },
      ],
    ],
  },
}
```

`swcPlugins`は、プラグインを設定するためのタプルの配列を受け付けます。プラグインのタプルはプラグインへのパスとプラグイン構成用のオブジェクトを含みます。プラグインへのパスはnpmモジュールパッケージ名か`.wasm`バイナリ自体への絶対パスにすることができます。

## 未サポートの機能 {#unsupported-features}

アプリケーションに`.babelrc`ファイルがある場合、Next.js は自動的にファイルの変換にBabelを使用します。これにより、カスタムBabelプラグインを活用する既存のアプリケーションとの後方互換性が保証されます。

カスタム Babel セットアップを使用している場合、[設定ファイルを共有してください](https://github.com/vercel/next.js/discussions/30174)。可能な限り多くの一般的に使用されるBabel変換を移植し、将来的にはプラグインをサポートする作業を進めています。

## バージョン履歴 {#version-history}

| バージョン | 変更点                                                                                                                                                                                                                                 |
| ---------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `v13.1.0`  | [モジュールのトランスパイル](https://nextjs.org/blog/next-13-1#built-in-module-transpilation-stable) および [インポートのモジュール化](https://nextjs.org/blog/next-13-1#import-resolution-for-smaller-bundles) が安定版になりました。 |
| `v13.0.0`  | SWC Minifierがデフォルトで有効になりました。                                                                                                                                                                                           |
| `v12.3.0`  | SWC Minifier [安定版](https://nextjs.org/blog/next-12-3#swc-minifier-stable)                                                                                                                                                           |
| `v12.2.0`  | [SWC Plugins](#swc-plugins-experimental) 実験的サポートが追加されました。                                                                                                                                                              |
| `v12.1.0`  | Styled Components, Jest, Relay, React プロパティの削除、レガシーデコレータ、Console の削除、jsxImportSourceのサポートが追加されました。                                                                                                |
| `v12.0.0`  | Next.js コンパイラが[導入されました](https://nextjs.org/blog/next-12)。                                                                                                                                                                |
