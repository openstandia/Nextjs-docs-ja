---
title: 'Next.js Compiler'
description: 'Rustで記述されたNext.js Compilerは、Next.jsアプリケーションを変換し、最小化します。'
---

Next.js Compilerは、[SWC](https://swc.rs/)を使用してRustで書かれたもので、Next.jsがJavaScriptコードをプロダクション用に変換し、最小化することを可能にします。これは、個々のファイルに対してBabelを、出力バンドルの最小化に対してTerserを置き換えます。

Next.js Compilerを使用したコンパイルは、Babelに比べて17倍速く、Next.jsバージョン12からデフォルトで有効になっています。既存のBabel設定や[サポートされていない機能](#unsupported-features)を利用している場合、アプリケーションはNext.js Compilerの使用をオプトアウトし、Babelの使用を継続します。

## なぜSWCなのか？ {#why-swc}

[SWC](https://swc.rs/)は、次世代の迅速な開発者ツールのための拡張可能なRustベースのプラットフォームです。

SWCは、コンパイル、最小化、バンドリングなどのために使用でき、拡張することができます。組み込みまたはカスタムのコード変換を行うために呼び出すことが可能です。これらの変換は、Next.jsのような上位レベルのツールを通じて実行されます。

私たちがSWCを採用した理由はいくつかあります：

- **拡張性**：SWCは、Next.js内でCrateとして利用でき、ライブラリをフォークしたり、設計上の制約を回避する必要がありません
- **パフォーマンス**：SWCに切り替えることで、Next.jsで~3倍速いFast Refreshと~5倍速いビルドを達成しましたが、さらなる最適化の余地があります
- **WebAssembly**：RustのWASMサポートは、すべての可能なプラットフォームをサポートし、Next.js開発をあらゆる場所に持ち込むために重要です
- **コミュニティ**：Rustコミュニティとエコシステムは素晴らしく、まだ成長しています

## サポートされている機能 {#supported-features}

### Styled Components {#styled-components}

`babel-plugin-styled-components`をNext.js Compilerに移植する作業を進めています。

まず、Next.jsの最新バージョンに更新します： `npm install next@latest`。その後、`next.config.js`ファイルを更新します：

```js title="next.config.js"
module.exports = {
  compiler: {
    styledComponents: true,
  },
}
```

高度な使用ケースでは、styled-componentsコンパイルのために個別のプロパティを設定できます。

> 注: `ssr`と`displayName`変換は、Next.jsで`styled-components`を使用するための主な要件です。

```js title="next.config.js"
module.exports = {
  compiler: {
    // optionsの詳細については、https://styled-components.com/docs/tooling#babel-plugin を参照してください。
    styledComponents: {
      // 開発中はデフォルトで有効、プロダクションではファイルサイズを減らすために無効です。
      // この設定をするとすべての環境でデフォルトを上書きします。
      displayName?: boolean,
      // デフォルトで有効。
      ssr?: boolean,
      // デフォルトで有効。
      fileName?: boolean,
      // デフォルトで空。
      topLevelImportPaths?: string[],
      // デフォルトは["index"]。
      meaninglessFileNames?: string[],
      // デフォルトで有効。
      minify?: boolean,
      // デフォルトで有効。
      transpileTemplateLiterals?: boolean,
      // デフォルトで空。
      namespace?: string,
      // デフォルトで無効。
      pure?: boolean,
      // デフォルトで有効。
      cssProp?: boolean,
    },
  },
}
```

### Jest {#jest}

Next.js Compilerは、テストをトランスパイルし、Next.jsとJestの設定を簡素化します。これには以下が含まれます：

- `.css`、`.module.css`（およびその`.scss`のバリアント）とイメージインポートの自動モック
- SWCを使用した`transform`の自動設定
- `.env`（およびそのすべてのバリアント）を`process.env`にロード
- `node_modules`をテストの解決と変換から無視
- `.next`をテストの解決から無視
- 実験的なSWC変換を有効にするフラグのために`next.config.js`をロード

まず、Next.jsの最新バージョンに更新します： `npm install next@latest`。その後、`jest.config.js`ファイルを更新します：

```js title="jest.config.js"
const nextJest = require('next/jest')

// Next.jsアプリのパスを指定することで、next.config.jsと.envファイルのロードを有効にします
const createJestConfig = nextJest({ dir: './' })

// Jestに渡したい任意のカスタム設定
const customJestConfig = {
  setupFilesAfterEnv: ['<rootDir>/jest.setup.js'],
}

// next/jestがNext.jsの設定をロードできるように、この方法でcreateJestConfigをエクスポートします
module.exports = createJestConfig(customJestConfig)
```

### Relay {#relay}

[Relay](https://relay.dev/)サポートを有効にするには：

```js title="next.config.js"
module.exports = {
  compiler: {
    relay: {
      // relay.config.jsに合わせる必要があります
      src: './',
      artifactDirectory: './__generated__',
      language: 'typescript',
      eagerEsModules: false,
    },
  },
}
```

> **Good to know**: Next.jsでは、`pages`ディレクトリ内のすべてのJavaScriptファイルはルートとみなされます。そのため、`relay-compiler`用には`artifactDirectory`構成設定を`pages`の外側に指定する必要があります。そうしないと、`relay-compiler`は`__generated__`ディレクトリ内のソースファイルの横にファイルを生成し、このファイルがルートとみなされ、プロダクションビルドが壊れる可能性があります。

### Reactプロパティの削除 {#remove-react-properties}

JSXプロパティを削除することができます。これは、テストによく使用されます。`babel-plugin-react-remove-properties`と同様です。

デフォルトの正規表現`^data-test`に一致するプロパティを削除するには：

```js title="next.config.js"
module.exports = {
  compiler: {
    reactRemoveProperties: true,
  },
}
```

カスタムプロパティを削除するには：

```js title="next.config.js"
module.exports = {
  compiler: {
    // ここで定義された正規表現はRustで処理されるため、JavaScript `RegExp`とは構文が異なります。https://docs.rs/regexを参照してください。
    reactRemoveProperties: { properties: ['^data-custom$'] },
  },
}
```

### Consoleの削除 {#remove-console}

この変換により、アプリケーションコード（`node_modules`ではありません）内のすべての`console.*`呼び出しを削除できます。`babel-plugin-transform-remove-console`と似ています。

すべての`console.*`呼び出しを削除するには：

```js title="next.config.js"
module.exports = {
  compiler: {
    removeConsole: true,
  },
}
```

`console.*`出力を削除するが、`console.error`を除外するには：

```js title="next.config.js"
module.exports = {
  compiler: {
    removeConsole: {
      exclude: ['error'],
    },
  },
}
```

### 従来のデコレータ {#legacy-decorators}

Next.jsは、`jsconfig.json`または`tsconfig.json`内の`experimentalDecorators`を自動的に検出します。従来のデコレータは、`mobx`の古いバージョンのライブラリなどと共に一般的に使用されます。

このフラグは、既存アプリケーションとの互換性のためだけにサポートされています。新しいアプリケーションで従来のデコレータを使用することは推奨されません。

まず、Next.jsの最新バージョンに更新します：`npm install next@latest`。その後、`jsconfig.json`または`tsconfig.json`ファイルを更新します：

```js
{
  "compilerOptions": {
    "experimentalDecorators": true
  }
}
```

### importSource {#importsource}

Next.jsは、`jsconfig.json`または`tsconfig.json`内の`jsxImportSource`を自動的に検出し、それを適用します。これは、[Theme UI](https://theme-ui.com)のようなライブラリと共に一般的に使用されます。

まず、Next.jsの最新バージョンに更新します：`npm install next@latest`。その後、`jsconfig.json`または`tsconfig.json`ファイルを更新します：

```js
{
  "compilerOptions": {
    "jsxImportSource": "theme-ui"
  }
}
```

### Emotion {#emotion}

`@emotion/babel-plugin`をNext.js Compilerに移植する作業を進めています。

まず、Next.jsの最新バージョンに更新します：`npm install next@latest`。その後、`next.config.js`ファイルを更新します：

```js title="next.config.js"

module.exports = {
  compiler: {
    emotion: boolean | {
      // デフォルトはtrueです。ビルドタイプがプロダクションのときに無効になります。
      sourceMap?: boolean,
      // デフォルトは'dev-only'です。
      autoLabel?: 'never' | 'dev-only' | 'always',
      // デフォルトは'[local]'です。
      // 許可される値: `[local]` `[filename]`および`[dirname]`
      // このオプションは、autoLabelが'dev-only'または'always'に設定されている場合のみ機能します。
      // 結果のラベルの形式を定義することができます。
      // 形式は、ブラケット[]で囲まれた変数部分を使用して文字列で定義されます。
      // 例えば、ラベル形式: "my-classname--[local]"は、[local]が変数名で置き換えられます。
      labelFormat?: string,
      // デフォルトはundefinedです。
      // このオプションを使用して、コンパイラーがどのインポートを変換するかを決定することを指定できます。
      // これにより、Emotionのエクスポートを再エクスポートしても変換を続けることができます。
      importMap?: {
        [packageName: string]: {
          [exportName: string]: {
            canonicalImport?: [string, string],
            styledBaseImport?: [string, string],
          }
        }
      },
    },
  },
}
```

### ミニフィケーション {#minification}

Next.jsのswcコンパイラーは、v13からデフォルトでミニフィケーションに使用されています。これはTerserに比べて7倍速いです。

> **Good to know:** v15以降、ミニフィケーションは`next.config.js`を使用してカスタマイズできません。`swcMinify`フラグのサポートは削除されました。

### モジュールトランスパイル {#module-transpilation}

Next.jsは、ローカルパッケージ（モノレポのような）や外部依存（`node_modules`）からの依存関係を自動的にトランスパイルし、バンドルすることができます。これは`next-transpile-modules`パッケージを置き換えます。

```js title="next.config.js"
module.exports = {
  transpilePackages: ['@acme/ui', 'lodash-es'],
}
```

### インポートのモジュール化 {#modularize-imports}

このオプションは、Next.js 13.5の[`optimizePackageImports`](/docs/app/api-reference/config/next-config-js/optimizePackageImports)により置き換えられました。 インポートパスの手動設定を必要としない新しいオプションを使用することをお勧めします。

### 定義（ビルド中の変数置換） {#define-replacing-variables-during-build}

`define`オプションを使用すると、ビルド時にコード内の変数を静的に置換できます。
このオプションは、キーを置換すべき変数、値を置換先の値とするキー値ペアのオブジェクトを受け取ります。

`next.config.js`の`compiler.define`フィールドを使用します：

```js title="next.config.js"
module.exports = {
  compiler: {
    define: {
      MY_STRING_VARIABLE: JSON.stringify('my-string'),
      MY_NUMBER_VARIABLE: '42',
    },
  },
}
```

## 実験的な機能 {#experimental-features}

### SWCトレースプロファイリング {#swc-trace-profiling}

SWCの内部変換トレースをchromiumの[トレースイベント形式](https://docs.google.com/document/d/1CvAClvFfyA5R-PhYUmn5OOQtYMH4h6I0nSsKchNAySU/preview?mode=html#%21=)として生成できます。

```js title="next.config.js"
module.exports = {
  experimental: {
    swcTraceProfiling: true,
  },
}
```

有効化すると、swcは`.next/`ディレクトリ以下に`swc-trace-profile-${timestamp}.json`という名前のトレースを生成します。Chromiumのトレースビューア（chrome://tracing/, https://ui.perfetto.dev/）、または互換性のあるフレームグラフビューア（https://www.speedscope.app/）で生成されたトレースをロード＆ビジュアライズできます。

### SWCプラグイン（実験的） {#swc-plugins-experimental}

SWCのトランスフォームを設定して、wasmで書かれたSWCの実験的プラグインサポートを使用し、変換動作をカスタマイズできます。

```js title="next.config.js"
module.exports = {
  experimental: {
    swcPlugins: [
      [
        'plugin',
        {
          ...pluginOptions,
        },
      ],
    ],
  },
}
```

`swcPlugins`は、プラグインの設定用のタプルの配列を受け入れます。プラグイン用のタプルは、プラグインへのパスとプラグイン設定用のオブジェクトを含みます。プラグインへのパスはnpmモジュールパッケージ名、または`.wasm`バイナリ自身への絶対パスを指定できます。

## サポートされていない機能 {#unsupported-features}

アプリケーションに`.babelrc`ファイルがある場合、Next.jsは個々のファイルを変換するために自動的にBabelを使用するようにフォールバックします。これにより、カスタムBabelプラグインを活用する既存のアプリケーションとの後方互換性が保証されます。

カスタムBabel設定を使用している場合は、[設定を共有してください](https://github.com/vercel/next.js/discussions/30174)。多くの一般的に使用されるBabel変換を移植するとともに、将来的にはプラグインのサポートを目指しています。

## バージョン履歴 {#version-history}

| バージョン | 変更点                                                                                                                                                                                                           |
| ---------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `v13.1.0`  | [Module Transpilation](https://nextjs.org/blog/next-13-1#built-in-module-transpilation-stable) と [Modularize Imports](https://nextjs.org/blog/next-13-1#import-resolution-for-smaller-bundles) が安定版になった |
| `v13.0.0`  | SWC Minifierがデフォルトで有効になった                                                                                                                                                                           |
| `v12.3.0`  | SWC Minifierが[安定版](https://nextjs.org/blog/next-12-3#swc-minifier-stable)になった                                                                                                                            |
| `v12.2.0`  | [SWC Plugins](#swc-plugins-experimental) の実験的サポートが追加された                                                                                                                                            |
| `v12.1.0`  | Styled Components、Jest、Relay、Reactプロパティの削除、従来のデコレータ、Consoleの削除、jsxImportSourceのサポートが追加された                                                                                    |
| `v12.0.0`  | Next.js Compilerが[導入された](https://nextjs.org/blog/next-12)                                                                                                                                                  |
