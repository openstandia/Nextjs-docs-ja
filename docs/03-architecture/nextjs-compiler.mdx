---
title: 'Next.js Compiler'
description: 'Rust で記述された Next.js Compiler は、Next.js アプリケーションを変換し、最小化します。'
---

Rust で [SWC](https://swc.rs/) を使用して書かれた Next.js Compiler は、Next.js が JavaScript コードをプロダクション用に変換し、最小化することを可能にします。これにより、個々のファイルについては Babel を、出力バンドルの最小化については Terser を置き換えます。

Next.js Compiler を使用したコンパイルは Babel よりも 17 倍高速であり、Next.js バージョン 12 以降、デフォルトで有効になっています。既存の Babel 設定がある場合や、[未対応機能](#unsupported-features)を使用している場合、アプリケーションは Next.js Compiler からオプトアウトし、Babel を引き続き使用します。

## なぜ SWC なのか？ {#why-swc}

[SWC](https://swc.rs/) は次世代の高速デベロッパーツール向けに開発された、拡張性のある Rust ベースのプラットフォームです。

SWC はコンパイル、最小化、バンドル化などに使用でき、拡張できるように設計されています。これを呼び出してコード変換（組み込みまたはカスタム）を実行することができ、その変換を実行するのは Next.js などの上位レベルのツールです。

私たちが SWC を基盤に選んだ理由はいくつかあります：

- **拡張性：** SWC は Next.js 内部で Crate として使用可能で、ライブラリをフォークしたり、設計制約を回避したりする必要がありません。
- **パフォーマンス：** SWC に切り替えることで、Next.js の Fast Refresh が約3倍、ビルドが約5倍速くなりました。さらに最適化の余地があります。
- **WebAssembly：** Rust の WASM サポートは、すべてのプラットフォームで Next.js 開発を進めるために不可欠です。
- **コミュニティ：** Rust コミュニティとエコシステムは素晴らしく、まだ成長しています。

## 対応する機能 {#supported-features}

### Styled Components {#styled-components}

`babel-plugin-styled-components` を Next.js Compiler に移植中です。

まず、Next.js の最新バージョンに更新します： `npm install next@latest`。その後、`next.config.js` ファイルを更新します：

```js title="next.config.js"
module.exports = {
  compiler: {
    styledComponents: true,
  },
}
```

高度なユースケースの場合は、styled-components コンパイルの個々のプロパティを構成することができます。

> 注：`styled-components` を Next.js で使用するには、`ssr` と `displayName` 変換が主な要件です。

```js title="next.config.js"
module.exports = {
  compiler: {
    // オプションに関する詳細は https://styled-components.com/docs/tooling#babel-plugin を参照してください。
    styledComponents: {
      // 開発ではデフォルトで有効、本番ではファイルサイズを削減するために無効です。
      // この設定によりすべての環境でのデフォルトを上書きします。
      displayName?: boolean,
      // デフォルトで有効です。
      ssr?: boolean,
      // デフォルトで有効です。
      fileName?: boolean,
      // デフォルトは空です。
      topLevelImportPaths?: string[],
      // デフォルトは ["index"] です。
      meaninglessFileNames?: string[],
      // デフォルトで有効です。
      minify?: boolean,
      // デフォルトで有効です。
      transpileTemplateLiterals?: boolean,
      // デフォルトは空です。
      namespace?: string,
      // デフォルトで無効です。
      pure?: boolean,
      // デフォルトで有効です。
      cssProp?: boolean,
    },
  },
}
```

### Jest {#jest}

Next.js Compiler はテストコードをトランスパイルし、Jest を Next.js とともに簡単に構成します。以下を含みます：

- `.css`、`.module.css`（およびその `.scss` バリエーション）とイメージインポートの自動モック
- SWC を使用して `transform` を自動設定
- `.env`（およびそのすべてのバリエーション）を `process.env` にロード
- `node_modules` はテスト解決および変換から無視
- テスト解決から `.next` を無視
- 実験的な SWC 変換を有効にするフラグのために `next.config.js` をロード

まず、Next.js の最新バージョンに更新します： `npm install next@latest`。その後、`jest.config.js` ファイルを更新します：

```js title="jest.config.js"
const nextJest = require('next/jest')

// Next.js アプリへのパスを指定することで next.config.js と .env ファイルをロードできるようになります
const createJestConfig = nextJest({ dir: './' })

// Jest に渡したいカスタム設定
const customJestConfig = {
  setupFilesAfterEnv: ['<rootDir>/jest.setup.js'],
}

// createJestConfig はこのようにエクスポートされており、next/jest が Next.js の設定をロードできることを保証します。これは非同期です。
module.exports = createJestConfig(customJestConfig)
```

### Relay {#relay}

[Relay](https://relay.dev/) のサポートを有効にするには：

```js title="next.config.js"
module.exports = {
  compiler: {
    relay: {
      // relay.config.js に一致する必要があります
      src: './',
      artifactDirectory: './__generated__',
      language: 'typescript',
      eagerEsModules: false,
    },
  },
}
```

> **Good to know：** Next.js では、`pages` ディレクトリ内のすべての JavaScript ファイルはルートとして見なされます。そのため、`relay-compiler` を使用する場合は、`artifactDirectory` の設定を `pages` の外で指定する必要があります。そうでないと、`relay-compiler` は `__generated__` ディレクトリのソースファイルの隣にファイルを生成し、これがルートとして見なされるため、プロダクションビルドが失敗します。

### React プロパティの削除 {#remove-react-properties}

JSX プロパティを削除することができます。これはテストによく使用されます。`babel-plugin-react-remove-properties` に似ています。

デフォルトの正規表現 `^data-test` に一致するプロパティを削除するには：

```js title="next.config.js"
module.exports = {
  compiler: {
    reactRemoveProperties: true,
  },
}
```

カスタムプロパティを削除するには：

```js title="next.config.js"
module.exports = {
  compiler: {
    // ここで定義された正規表現は Rust で処理されるため、JavaScript の `RegExp` とは異なる構文です。
    // 詳細は https://docs.rs/regex を参照してください。
    reactRemoveProperties: { properties: ['^data-custom$'] },
  },
}
```

### コンソールの削除 {#remove-console}

この変換により、アプリケーションコード内（`node_modules` ではありません）のすべての `console.*` 呼び出しを削除することができます。`babel-plugin-transform-remove-console` に似ています。

すべての `console.*` 呼び出しを削除するには：

```js title="next.config.js"
module.exports = {
  compiler: {
    removeConsole: true,
  },
}
```

`console.error` を除いてすべての `console.*` 出力を削除するには：

```js title="next.config.js"
module.exports = {
  compiler: {
    removeConsole: {
      exclude: ['error'],
    },
  },
}
```

### レガシーデコレータ {#legacy-decorators}

Next.js は `jsconfig.json` または `tsconfig.json` で `experimentalDecorators` を自動検出します。レガシーデコレータは `mobx` の古いバージョンのライブラリと共に使用されることが一般的です。

このフラグは、既存のアプリケーションとの互換性のためにのみサポートされています。新しいアプリケーションでレガシーデコレータを使用することはお勧めしません。

まず、Next.js の最新バージョンに更新します： `npm install next@latest`。その後、`jsconfig.json` または `tsconfig.json` ファイルを更新します：

```js
{
  "compilerOptions": {
    "experimentalDecorators": true
  }
}
```

### importSource {#importsource}

Next.js は `jsconfig.json` または `tsconfig.json` で `jsxImportSource` を自動検出して適用します。これは [Theme UI](https://theme-ui.com) のようなライブラリと共に使用されることが一般的です。

まず、Next.js の最新バージョンに更新します： `npm install next@latest`。その後、`jsconfig.json` または `tsconfig.json` ファイルを更新します：

```js
{
  "compilerOptions": {
    "jsxImportSource": "theme-ui"
  }
}
```

### Emotion {#emotion}

`@emotion/babel-plugin` を Next.js Compiler に移植中です。

まず、Next.js の最新バージョンに更新します： `npm install next@latest`。その後、`next.config.js` ファイルを更新します：

```js title="next.config.js"

module.exports = {
  compiler: {
    emotion: boolean | {
      // デフォルトは true です。ビルドタイプがプロダクションの場合は無効になります。
      sourceMap?: boolean,
      // デフォルトは 'dev-only' です。
      autoLabel?: 'never' | 'dev-only' | 'always',
      // デフォルトは '[local]' です。
      // 許可される値：`[local]` `[filename]` および `[dirname]`
      // このオプションは autoLabel が 'dev-only' または 'always' に設定されている場合のみ機能します。
      // 生成されたラベルの形式を定義することができます。
      // 変数部分は角カッコ [] で囲まれた文字列で定義されます。
      // たとえば、labelFormat: "my-classname--[local]" の場合、[local] は結果が代入されている変数の名前に置き換えられます。
      labelFormat?: string,
      // デフォルトは undefined です。
      // このオプションによって、どのインポートを見て変換を実行するかをコンパイラに伝えることができます。
      // Emotion のエクスポートを再エクスポートする場合でも、変換を使用できます。
      importMap?: {
        [packageName: string]: {
          [exportName: string]: {
            canonicalImport?: [string, string],
            styledBaseImport?: [string, string],
          }
        }
      },
    },
  },
}
```

### 最小化 {#minification}

Next.js の swc コンパイラは v13 からデフォルトで最小化に使用されています。これは Terser よりも 7 倍高速です。

> **Good to know：** v15 からは最小化が `next.config.js` を使用してカスタマイズできなくなっています。`swcMinify` フラグのサポートは削除されました。

### モジュールトランスピレーション {#module-transpilation}

Next.js はローカルパッケージ（モノレポなど）や外部依存関係（`node_modules`）からの依存関係を自動でトランスパイルしてバンドルできます。これにより、`next-transpile-modules` パッケージを置き換えます。

```js title="next.config.js"
module.exports = {
  transpilePackages: ['@acme/ui', 'lodash-es'],
}
```

### モジュール化したインポート {#modularize-imports}

このオプションは Next.js 13.5 の [`optimizePackageImports`](/docs/app/api-reference/config/next-config-js/optimizePackageImports) に置き換えられました。インポートパスの手動設定を必要としない新しいオプションの使用をお勧めします。

### 定義（ビルド時に変数を置換）{#define-replacing-variables-during-build}

`define` オプションを使用すると、ビルド時にコード内の変数を静的に置き換えることができます。このオプションはキーと値のペアとしてオブジェクトを受け取ります。キーは対応する値で置き換えられる変数です。

`next.config.js` で `compiler.define` フィールドを使用します：

```js title="next.config.js"
module.exports = {
  compiler: {
    define: {
      MY_STRING_VARIABLE: JSON.stringify('my-string'),
      MY_NUMBER_VARIABLE: '42',
    },
  },
}
```

## 実験的な機能 {#experimental-features}

### SWC トレースプロファイリング {#swc-trace-profiling}

Chromium の [trace event フォーマット](https://docs.google.com/document/d/1CvAClvFfyA5R-PhYUmn5OOQtYMH4h6I0nSsKchNAySU/preview?mode=html#%21=) として SWC の内部変換トレースを生成できます。

```js title="next.config.js"
module.exports = {
  experimental: {
    swcTraceProfiling: true,
  },
}
```

有効にすると、swc は `.next/` 以下に `swc-trace-profile-${timestamp}.json` という名前のトレースを生成します。Chromium のトレースビューアー（chrome://tracing/、https://ui.perfetto.dev/）、または互換性のあるフレームグラフビューアー（https://www.speedscope.app/）で生成されたトレースをロードおよび視覚化できます。

### SWC プラグイン（実験的） {#swc-plugins-experimental}

swc の transform を構成して WASM による SWC の実験的プラグインサポートを使用し、変換の振る舞いをカスタマイズできます。

```js title="next.config.js"
module.exports = {
  experimental: {
    swcPlugins: [
      [
        'plugin',
        {
          ...pluginOptions,
        },
      ],
    ],
  },
}
```

`swcPlugins` はプラグインを構成するタプルの配列を受け入れます。プラグインのタプルには、プラグインへのパスとプラグイン設定用のオブジェクトが含まれます。プラグインへのパスは npm モジュールパッケージ名でも、`.wasm` バイナリの絶対パスでもかまいません。

## 未対応機能 {#unsupported-features}

アプリケーションに `.babelrc` ファイルがある場合、Next.js は個々のファイルの変換に自動的に Babel を使用します。これにより、カスタム Babel プラグインを活用する既存のアプリケーションとの後方互換性が保証されます。

カスタム Babel 設定を使用している場合は、[設定を共有してください](https://github.com/vercel/next.js/discussions/30174)。多くの一般的な Babel 変換を移植する作業や、将来的なプラグインサポートを進めています。

## バージョン履歴 {#version-history}

| バージョン | 変更点                                                                                                                                                                                                                             |
| ---------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `v13.1.0`  | [モジュールトランスピレーション](https://nextjs.org/blog/next-13-1#built-in-module-transpilation-stable) と [モジュール化したインポート](https://nextjs.org/blog/next-13-1#import-resolution-for-smaller-bundles) が安定しました。 |
| `v13.0.0`  | SWC Minifier がデフォルトで有効になりました。                                                                                                                                                                                      |
| `v12.3.0`  | SWC Minifier [安定版](https://nextjs.org/blog/next-12-3#swc-minifier-stable) 。                                                                                                                                                    |
| `v12.2.0`  | [SWC プラグイン](#swc-plugins-experimental) の実験的サポートが追加されました。                                                                                                                                                     |
| `v12.1.0`  | Styled Components、Jest、Relay、React プロパティの削除、Legacy Decorators、コンソールの削除、jsxImportSource がサポートされました。                                                                                                |
| `v12.0.0`  | Next.js Compiler が[導入されました](https://nextjs.org/blog/next-12) 。                                                                                                                                                            |
