---
title: 'Next.js Compiler'
description: 'Rustで書かれたNext.js Compilerが、Next.jsアプリケーションを変換し圧縮します'
---

Rustで書かれた[SWC](https://swc.rs/)を使用したNext.js Compilerは、Next.jsがJavaScriptコードをプロダクション向けに変換し圧縮します。これにより、個々のファイルに対するBabelと、出力バンドルの圧縮にTerserを置き換えます。

Next.js Compilerを使用したコンパイルはBabelと比べて17倍速く、Next.jsバージョン12以降でデフォルトで有効になっています。既存のBabelの設定がある場合や[サポートされていない機能](#unsupported-features)を使用している場合、アプリケーションはNext.js Compilerをオプトアウトし、Babelの使用を継続します。

## なぜSWCなのか {#why-swc}

[SWC](https://swc.rs/)は、次世代の高速開発者ツールのための拡張可能なRustを基盤とするプラットフォームです。

SWCはコンパイル、最小化、バンドルなどに使用することができ、拡張するために設計されています。これは、組み込みまたはカスタムのコード変換を実行するために呼び出すことができるものです。その変換の実行は、Next.jsのような高レベルのツールを通して行われます。

私たちがSWCを基に構築した理由は以下の通りです：

- **拡張性:** SWCは、Next.js内でCrateとして使用でき、ライブラリをフォークしたり設計の制約を回避したりすることなく使用可能です
- **パフォーマンス:** SWCへの切り替えによって、Next.jsでのFast Refreshが約3倍速く、ビルドが約5倍速くなり、さらに最適化の余地があります
- **WebAssembly:** RustのWASMサポートはすべてのプラットフォームをサポートし、Next.jsの開発をあらゆる場所に広げるために不可欠です
- **コミュニティ:** Rustのコミュニティとエコシステムは素晴らしく、さらに成長を続けています

## サポートされている機能 {#supported-features}

### Styled Components {#styled-components}

`babel-plugin-styled-components`をNext.js Compilerに移植する作業を行っています。

まず、Next.jsを最新バージョンに更新してください：`npm install next@latest` 次に、`next.config.js`ファイルを更新してください：

```js title="next.config.js"
module.exports = {
  compiler: {
    styledComponents: true,
  },
}
```

高度なユースケースのために個別のプロパティを設定することができます。

> 注: `ssr`と`displayName`の変換は、Next.jsで`styled-components`を使用するための主な要件です。

```js title="next.config.js"
module.exports = {
  compiler: {
    // オプションの詳細については、https://styled-components.com/docs/tooling#babel-plugin を参照してください。
    styledComponents: {
      // 開発ではデフォルトで有効、プロダクションではファイルサイズを減らすために無効にされます。
      // この設定は全ての環境のデフォルトを上書きします。
      displayName?: boolean,
      // デフォルトで有効です。
      ssr?: boolean,
      // デフォルトで有効です。
      fileName?: boolean,
      // デフォルトで空です。
      topLevelImportPaths?: string[],
      // デフォルトは["index"]。
      meaninglessFileNames?: string[],
      // デフォルトで有効です。
      minify?: boolean,
      // デフォルトで有効です。
      transpileTemplateLiterals?: boolean,
      // デフォルトで空です。
      namespace?: string,
      // デフォルトで無効です。
      pure?: boolean,
      // デフォルトで有効です。
      cssProp?: boolean,
    },
  },
}
```

### Jest {#jest}

Next.js Compilerはテストをトランスパイルし、Next.jsとJestの設定を簡素化します。これには以下が含まれます：

- `.css`, `.module.css`（およびその`.scss`バリアント）の自動モックと画像のインポート
- SWCを使って`transform`を自動設定
- `.env`（およびすべてのバリアント）を`process.env`にロード
- テストの解決と変換から`node_modules`を無視
- テストの解決から`.next`を無視
- 実験的なSWC変換を有効にするフラグのために`next.config.js`をロード

まず、Next.jsを最新バージョンに更新してください：`npm install next@latest` 次に、`jest.config.js`ファイルを更新してください：

```js title="jest.config.js"
const nextJest = require('next/jest')

// next.config.jsと.envファイルのロードを可能にするためにNext.jsアプリへのパスを指定します
const createJestConfig = nextJest({ dir: './' })

// Jestに渡したいカスタム設定を追加します
const customJestConfig = {
  setupFilesAfterEnv: ['<rootDir>/jest.setup.js'],
}

// next/jestがNext.jsの設定をロードできるように、createJestConfigはこのようにエクスポートされています
module.exports = createJestConfig(customJestConfig)
```

### Relay {#relay}

[Relay](https://relay.dev/)サポートを有効にするには：

```js title="next.config.js"
module.exports = {
  compiler: {
    relay: {
      // relay.config.jsに合わせてください
      src: './',
      artifactDirectory: './__generated__',
      language: 'typescript',
      eagerEsModules: false,
    },
  },
}
```

> **Good to know**: Next.jsでは、`pages`ディレクトリ内のすべてのJavaScriptファイルがルートとみなされます。そのため、`relay-compiler`では、`pages`の外で`artifactDirectory`設定を指定する必要があります。さもないと、`relay-compiler`は`__generated__`ディレクトリ内のソースファイルの隣にファイルを生成し、このファイルがルートとして扱われ、プロダクションビルドを壊すことになります。

### Reactプロパティの削除 {#remove-react-properties}

JSXプロパティを削除することができます。これはテストに使用されることが多いです。`babel-plugin-react-remove-properties`に似ています。

デフォルトの正規表現`^data-test`と一致するプロパティを削除するには：

```js title="next.config.js"
module.exports = {
  compiler: {
    reactRemoveProperties: true,
  },
}
```

カスタムプロパティを削除するには：

```js title="next.config.js"
module.exports = {
  compiler: {
    // ここで定義される正規表現はRustで処理されるため、構文がJavaScriptの`RegExp`と異なります。
    // 詳しくは https://docs.rs/regex を参照してください。
    reactRemoveProperties: { properties: ['^data-custom$'] },
  },
}
```

### コンソールの削除 {#remove-console}

この変換により、アプリケーションコード内のすべての`console.*`呼び出しを削除できます（`node_modules`は除く）。`babel-plugin-transform-remove-console`に似ています。

すべての`console.*`呼び出しを削除するには：

```js title="next.config.js"
module.exports = {
  compiler: {
    removeConsole: true,
  },
}
```

`console.error`を除くすべての`console.*`の出力を削除するには：

```js title="next.config.js"
module.exports = {
  compiler: {
    removeConsole: {
      exclude: ['error'],
    },
  },
}
```

### レガシーデコレータ {#legacy-decorators}

Next.jsは`jsconfig.json`または`tsconfig.json`内の`experimentalDecorators`を自動的に検出します。レガシーデコレータは、`mobx`のような古いバージョンのライブラリとよく使用されます。

このフラグは、既存のアプリケーションとの互換性のためにのみサポートされています。レガシーデコレータの使用は新しいアプリケーションには推奨されません。

まず、Next.jsを最新バージョンに更新してください：`npm install next@latest` 次に、`jsconfig.json`または`tsconfig.json`ファイルを更新してください：

```js
{
  "compilerOptions": {
    "experimentalDecorators": true
  }
}
```

### importSource {#importsource}

Next.jsは、`jsconfig.json`または`tsconfig.json`内で`jsxImportSource`を自動的に検出し、適用します。これは[Theme UI](https://theme-ui.com)のようなライブラリとともによく使用されます。

まず、Next.jsを最新バージョンに更新してください：`npm install next@latest` 次に、`jsconfig.json`または`tsconfig.json`ファイルを更新してください：

```js
{
  "compilerOptions": {
    "jsxImportSource": "theme-ui"
  }
}
```

### Emotion {#emotion}

`@emotion/babel-plugin`をNext.js Compilerに移植する作業を行っています。

まず、Next.jsを最新バージョンに更新してください：`npm install next@latest` 次に、`next.config.js`ファイルを更新してください：

```js title="next.config.js"

module.exports = {
  compiler: {
    emotion: boolean | {
      // デフォルトはtrue。ビルドタイプがプロダクションの場合は無効になります。
      sourceMap?: boolean,
      // デフォルトは'dev-only'。
      autoLabel?: 'never' | 'dev-only' | 'always',
      // デフォルトは'[local]'。
      // 許可されている値： `[local]` `[filename]` および `[dirname]`。
      // autoLabelが'dev-only'または'always'に設定されているときにのみ、このオプションは機能します。
      // 結果のラベルの形式を定義することができます。
      // 形式は文字列で定義され、変数的な部分は角括弧[]で囲まれます。
      // 例えば、labelFormat: "my-classname--[local]"のように、[local]は結果が割り当てられる変数名に置き換えられます。
      labelFormat?: string,
      // デフォルトはundefined。
      // このオプションを使って、コンパイラが何を変換するかを判断するために見るべき
      // インポートを指定できます。Emotionのエクスポートを再エクスポートする場合でも、
      // 変換を使用することができます。
      importMap?: {
        [packageName: string]: {
          [exportName: string]: {
            canonicalImport?: [string, string],
            styledBaseImport?: [string, string],
          }
        }
      },
    },
  },
}
```

### 圧縮 {#minification}

Next.jsのswcコンパイラはバージョン13以降でデフォルトで圧縮に使用されています。これはTerserより7倍速いです。

何らかの理由でTerserがまだ必要な場合は、設定が可能です。

```js title="next.config.js"
module.exports = {
  swcMinify: false,
}
```

### モジュールのトランスパイル {#module-transpilation}

Next.jsはローカルパッケージ（モノレポのような）や外部の依存関係（`node_modules`）からの依存関係を自動的にトランスパイルおよびバンドルすることができます。これは`next-transpile-modules`パッケージを置き換えます。

```js title="next.config.js"
module.exports = {
  transpilePackages: ['@acme/ui', 'lodash-es'],
}
```

### インポートのモジュール化 {#modularize-imports}

このオプションは、Next.js 13.5での[`optimizePackageImports`](/docs/app/api-reference/config/next-config-js/optimizePackageImports)に取って代わられました。インポートパスの手動設定を必要としない新しいオプションを使用するようにアップグレードすることをお勧めします。

### Define (ビルド時の変数置き換え) {#define-replacing-variables-during-build}

`define`オプションを使用すると、ビルド時にコード内の変数を静的に置き換えることができます。
オプションはキーと値のペアのオブジェクトを受け取ります。キーは対応する値に置き換えられる変数です。

`next.config.js`で`compiler.define`フィールドを使用してください：

```js title="next.config.js"
module.exports = {
  compiler: {
    define: {
      MY_STRING_VARIABLE: JSON.stringify('my-string'),
      MY_NUMBER_VARIABLE: '42',
    },
  },
}
```

## 実験的な機能 {#experimental-features}

### SWCトレースプロファイリング {#swc-trace-profiling}

SWCの内部変換トレースをクロミウムの[トレースイベントフォーマット](https://docs.google.com/document/d/1CvAClvFfyA5R-PhYUmn5OOQtYMH4h6I0nSsKchNAySU/preview?mode=html#%21=)として生成することができます。

```js title="next.config.js"
module.exports = {
  experimental: {
    swcTraceProfiling: true,
  },
}
```

有効にすると、swcは`.next/`以下にタイムスタンプ付きの`swc-trace-profile-${timestamp}.json`としてトレースを生成します。クロミウムのトレースビューワ（chrome://tracing/, https://ui.perfetto.dev/）、あるいは互換性のあるフレームグラフビューワ（https://www.speedscope.app/）で生成されたトレースを読み込み、可視化できます。

### SWCプラグイン (実験的) {#swc-plugins-experimental}

wasmで書かれたSWCの実験的プラグインサポートを使用して、変換動作をカスタマイズするようにSWCの変換を設定できます。

```js title="next.config.js"
module.exports = {
  experimental: {
    swcPlugins: [
      [
        'plugin',
        {
          ...pluginOptions,
        },
      ],
    ],
  },
}
```

`swcPlugins`はプラグインを設定するためのタプルの配列を受け入れます。プラグインのタプルにはプラグインへのパスとプラグイン設定のためのオブジェクトが含まれています。プラグインへのパスはnpmモジュールパッケージ名または`.wasm`バイナリそのものへの絶対パスが可能です。

## サポートされていない機能 {#unsupported-features}

アプリケーションに`.babelrc`ファイルがある場合、Next.jsは自動的に個々のファイルの変換にBabelを使用することにフォールバックします。これにより、既存のアプリケーションとカスタムBabelプラグインを利用するアプリケーションとの後方互換性が確保されます。

カスタムBabelのセットアップを使用している場合は、[設定を共有してください](https://github.com/vercel/next.js/discussions/30174)。私たちは、できるだけ多くの一般的に使用されるBabel変換の移植と、将来的にプラグインのサポートに取り組んでいます。

## バージョン履歴 {#version-history}

| バージョン | 変更点                                                                                                                                                                                                   |
| ---------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `v13.1.0`  | [Module Transpilation](https://nextjs.org/blog/next-13-1#built-in-module-transpilation-stable) と [Modularize Imports](https://nextjs.org/blog/next-13-1#import-resolution-for-smaller-bundles) を安定化 |
| `v13.0.0`  | SWC Minifierをデフォルトで有効化                                                                                                                                                                         |
| `v12.3.0`  | SWC Minifierを[安定化](https://nextjs.org/blog/next-12-3#swc-minifier-stable)                                                                                                                            |
| `v12.2.0`  | [SWC Plugins](#swc-plugins-experimental) 実験的サポートを追加                                                                                                                                            |
| `v12.1.0`  | Styled Components, Jest, Relay, Remove React Properties, Legacy Decorators, Remove Console, そしてjsxImportSourceのサポートを追加                                                                        |
| `v12.0.0`  | Next.jsコンパイラを[導入](https://nextjs.org/blog/next-12)                                                                                                                                               |
