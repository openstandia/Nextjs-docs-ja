---
title: 'Next.js Compiler'
description: 'Rustで書かれた、Next.jsアプリケーションを変換および圧縮するNext.js Compiler。'
---

Next.js Compilerは、[SWC](https://swc.rs/)を使用してRustで書かれており、Next.jsが本番用のJavaScriptコードを変換し圧縮することを可能にします。これにより、個別ファイルではBabelの代わりに、出力バンドルの圧縮にはTerserの代わりに使われます。

Next.js CompilerによるコンパイルはBabelの17倍速く、Next.jsバージョン12からデフォルトで有効になっています。現在のBabel設定がある場合や[サポートされていない機能](#unsupported-features)を使用している場合、アプリケーションはNext.js Compilerからオプトアウトし、引き続きBabelを使用します。

## なぜSWCなのか {#why-swc}

[SWC](https://swc.rs/)は、次世代の高速な開発者ツールのための拡張性のあるRustベースのプラットフォームです。

SWCはコンパイル、圧縮、バンドル、その他の用途に使用可能で、拡張するように設計されています。コード変換を行うために呼び出すことができます（組み込みもしくはカスタム）。それらの変換は、Next.jsのようなより高レベルのツールを通じて実行されます。

我々がSWCを利用することを決めた理由は以下の通りです：

- **拡張性：** SWCは、Next.js内でCrateとして使用でき、ライブラリをフォークしたり、設計上の制約を回避したりする必要がありません。
- **パフォーマンス：** SWCに切り替えることで、Next.jsで約3倍の高速なFast Refreshと約5倍の高速ビルドを実現できました；まだ最適化の余地がありますが、進行中です。
- **WebAssembly：** WASMをサポートするRustのサポートは、すべての可能なプラットフォームに対応し、Next.jsの開発をどこにでも展開するために不可欠です。
- **コミュニティ：** Rustのコミュニティとエコシステムは驚異的で、まだ成長しています。

## サポートされている機能 {#supported-features}

### Styled Components {#styled-components}

`babel-plugin-styled-components`をNext.js Compilerに移植する作業を進めています。

まず、Next.jsの最新バージョンに更新してください：`npm install next@latest`。その後、`next.config.js`ファイルを更新します：

```js title="next.config.js"
module.exports = {
  compiler: {
    styledComponents: true,
  },
}
```

高度な使用例として、styled-componentsコンパイルの個々のプロパティを設定することができます。

> 注意：Next.jsで`styled-components`を使用するためには、`ssr`と`displayName`の変換が主な要件です。

```js title="next.config.js"
module.exports = {
  compiler: {
    // オプションに関する詳細は https://styled-components.com/docs/tooling#babel-plugin を参照してください。
    styledComponents: {
      // 開発環境ではデフォルトで有効、ファイルサイズを減らすために本番環境では無効になっています、
      // これを設定することで、すべての環境のデフォルトをオーバーライドします。
      displayName?: boolean,
      // デフォルトで有効。
      ssr?: boolean,
      // デフォルトで有効。
      fileName?: boolean,
      // デフォルトは空。
      topLevelImportPaths?: string[],
      // デフォルトは ["index"]。
      meaninglessFileNames?: string[],
      // デフォルトで有効。
      minify?: boolean,
      // デフォルトで有効。
      transpileTemplateLiterals?: boolean,
      // デフォルトは空。
      namespace?: string,
      // デフォルトで無効。
      pure?: boolean,
      // デフォルトで有効。
      cssProp?: boolean,
    },
  },
}
```

### Jest {#jest}

Next.js Compilerはテストをコンパイルし、Next.jsとJestの設定を簡素化します：

- `.css`、`.module.css`（およびそれらの`.scss`バリアント）、画像インポートの自動モック
- SWCを使用して`transform`を自動的に設定
- `.env`（およびすべてのバリアント）を`process.env`にロード
- テストの解決と変換から`node_modules`を無視
- テストの解決から`.next`を無視
- 実験的なSWC変換を有効にするフラグのために`next.config.js`をロード

まず、Next.jsの最新バージョンに更新してください：`npm install next@latest`。その後、`jest.config.js`ファイルを更新します：

```js title="jest.config.js"
const nextJest = require('next/jest')

// Next.jsアプリへのパスを提供することで、next.config.jsと.envファイルのロードが有効になります
const createJestConfig = nextJest({ dir: './' })

// Jestに渡すカスタム設定
const customJestConfig = {
  setupFilesAfterEnv: ['<rootDir>/jest.setup.js'],
}

// next/jestがNext.jsの設定を非同期にロードできるように、この方法でcreateJestConfigをエクスポートします
module.exports = createJestConfig(customJestConfig)
```

### Relay {#relay}

[Relay](https://relay.dev/)サポートを有効にするには：

```js title="next.config.js"
module.exports = {
  compiler: {
    relay: {
      // これはrelay.config.jsと一致する必要があります
      src: './',
      artifactDirectory: './__generated__',
      language: 'typescript',
      eagerEsModules: false,
    },
  },
}
```

> **Good to know：** Next.jsでは、`pages`ディレクトリ内のすべてのJavaScriptファイルがルートと見なされます。したがって、`relay-compiler`では`pages`の外で`artifactDirectory`構成設定を指定する必要があります; そうしないと、`relay-compiler`は`__generated__`ディレクトリ内のソースファイルの隣にファイルを生成し、このファイルがルートと見なされ、本番ビルドが壊れます。

### Reactプロパティの削除 {#remove-react-properties}

JSXプロパティを削除できるようにします。これはテストによく使用されます。`babel-plugin-react-remove-properties`に類似しています。

デフォルトの正規表現`^data-test`に一致するプロパティを削除するには：

```js title="next.config.js"
module.exports = {
  compiler: {
    reactRemoveProperties: true,
  },
}
```

カスタムプロパティを削除するには：

```js title="next.config.js"
module.exports = {
  compiler: {
    // ここで定義された正規表現はRustで処理されるため、構文がJavaScriptの`RegExp`とは異なります。
    // https://docs.rs/regex を参照してください。
    reactRemoveProperties: { properties: ['^data-custom$'] },
  },
}
```

### コンソールの削除 {#remove-console}

この変換はアプリケーションコード内のすべての`console.*`呼び出しを削除できます（`node_modules`ではない）。`babel-plugin-transform-remove-console`に類似しています。

すべての`console.*`呼び出しを削除するには：

```js title="next.config.js"
module.exports = {
  compiler: {
    removeConsole: true,
  },
}
```

`console.error`を除く`console.*`出力を削除するには：

```js title="next.config.js"
module.exports = {
  compiler: {
    removeConsole: {
      exclude: ['error'],
    },
  },
}
```

### レガシーデコレーター {#legacy-decorators}

Next.jsは、`jsconfig.json`または`tsconfig.json`に`experimentalDecorators`を自動検出します。レガシーデコレーターは、`mobx`のような古いバージョンのライブラリでよく使用されます。

このフラグは既存のアプリケーションとの互換性のためにのみサポートされています。新しいアプリケーションでレガシーデコレーターを使用することはお勧めしません。

まず、Next.jsの最新バージョンに更新してください：`npm install next@latest`。その後、`jsconfig.json`または`tsconfig.json`ファイルを更新します：

```js
{
  "compilerOptions": {
    "experimentalDecorators": true
  }
}
```

### importSource {#importsource}

Next.jsは`jsconfig.json`または`tsconfig.json`内の`jsxImportSource`を自動検出し、それを適用します。これは[Theme UI](https://theme-ui.com)のようなライブラリでよく使用されます。

まず、Next.jsの最新バージョンに更新してください：`npm install next@latest`。その後、`jsconfig.json`または`tsconfig.json`ファイルを更新します：

```js
{
  "compilerOptions": {
    "jsxImportSource": "theme-ui"
  }
}
```

### Emotion {#emotion}

`@emotion/babel-plugin`をNext.js Compilerに移植する作業を進めています。

まず、Next.jsの最新バージョンに更新してください：`npm install next@latest`。その後、`next.config.js`ファイルを更新します：

```js title="next.config.js"

module.exports = {
  compiler: {
    emotion: boolean | {
      // デフォルトはtrue; ビルドタイプが本番の場合は無効になります。
      sourceMap?: boolean,
      // デフォルトは 'dev-only'。
      autoLabel?: 'never' | 'dev-only' | 'always',
      // デフォルトは '[local]'。
      // 許可される値は： `[local]` `[filename]` および `[dirname]`
      // このオプションはautoLabelが 'dev-only' または 'always' に設定されている場合にのみ機能します。
      // 結果ラベルのフォーマットを定義することができます。
      // フォーマットは、変数部分が角括弧[]で囲まれている文字列を介して定義されます。
      // たとえば、labelFormat: "my-classname--[local]"のように設定し、[local]は変数が割り当てられている名前で置き換えられます。
      labelFormat?: string,
      // デフォルトはundefined。
      // このオプションは、どのインポートを調べて変換するかをコンパイラに指示できるようにします。
      // それで、Emotionのエクスポートを再エクスポートしても、変換を引き続き使用できます。
      importMap?: {
        [packageName: string]: {
          [exportName: string]: {
            canonicalImport?: [string, string],
            styledBaseImport?: [string, string],
          }
        }
      },
    },
  },
}
```

### 圧縮 {#minification}

Next.jsのswcコンパイラは、v13からデフォルトで圧縮に使用されています。これはTerserの7倍速いです。

> **Good to know：** v15から、圧縮は`next.config.js`を使用してカスタマイズできなくなりました。`swcMinify`フラグのサポートは削除されました。

### モジュールトランスパイル {#module-transpilation}

Next.jsはローカルパッケージ（例：モノレポ）または外部依存（`node_modules`）からの依存関係を自動的にトランスパイルしバンドルできます。これにより、`next-transpile-modules`パッケージが置き換えられます。

```js title="next.config.js"
module.exports = {
  transpilePackages: ['@acme/ui', 'lodash-es'],
}
```

### インポートのモジュール化 {#modularize-imports}

このオプションは、Next.js 13.5の[`optimizePackageImports`](/docs/app/api-reference/config/next-config-js/optimizePackageImports)により廃止されました。インポートパスの手動設定を必要としない新しいオプションの使用にアップグレードすることをお勧めします。

### 変数をビルド中に置換する（Define） {#define-replacing-variables-during-build}

`define`オプションは、ビルド時にコード内の変数を静的に置換することを可能にします。このオプションは、キーと値のペアのオブジェクトを受け取り、キーは対応する値で置き換えるべき変数です。

`next.config.js`内の`compiler.define`フィールドを使用します：

```js title="next.config.js"
module.exports = {
  compiler: {
    define: {
      MY_STRING_VARIABLE: JSON.stringify('my-string'),
      MY_NUMBER_VARIABLE: '42',
    },
  },
}
```

## 実験的機能 {#experimental-features}

### SWCトレースプロファイリング {#swc-trace-profiling}

SWCの内部変換トレースをChromiumの[trace event形式](https://docs.google.com/document/d/1CvAClvFfyA5R-PhYUmn5OOQtYMH4h6I0nSsKchNAySU/preview?mode=html#%21=)として生成できます。

```js title="next.config.js"
module.exports = {
  experimental: {
    swcTraceProfiling: true,
  },
}
```

一度有効にすると、swcは`.next/`以下に`swc-trace-profile-${timestamp}.json`という名前でトレースを生成します。Chromiumのトレースビューア（chrome://tracing/, https://ui.perfetto.dev/）、または互換性のあるフレームグラフビューア（https://www.speedscope.app/）が生成されたトレースを読み込み&視覚化できます。

### SWCプラグイン（実験的） {#swc-plugins-experimental}

SWCの実験的なプラグインサポートをwasmで記述したものを使用して、変換のカスタマイズを行うためにswcの変換を設定できます。

```js title="next.config.js"
module.exports = {
  experimental: {
    swcPlugins: [
      [
        'plugin',
        {
          ...pluginOptions,
        },
      ],
    ],
  },
}
```

`swcPlugins`はプラグインを設定するためのタプルの配列を受け入れます。 プラグイン用のタプルにはプラグインへのパスと、プラグイン設定用のオブジェクトが含まれます。 プラグインへのパスはnpmモジュールのパッケージ名か、`.wasm`バイナリそのものへの絶対パスで指定できます。

## サポートされていない機能 {#unsupported-features}

アプリケーションに`.babelrc`ファイルがあると、Next.jsは自動的にBabelを使用して個別のファイルを変換するようにフォールバックします。これは、カスタムBabelプラグインを利用している既存のアプリケーションとの後方互換性を確保します。

カスタムBabel設定を使用している場合、[ぜひあなたの設定を共有してください](https://github.com/vercel/next.js/discussions/30174)。私たちは、多くのよく使用されるBabel変換を可能な限り移植し、将来的にはプラグインもサポートすることを目指しています。

## バージョン履歴 {#version-history}

| バージョン | 変更点                                                                                                                                                                                                                    |
| ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `v13.1.0`  | [モジュールトランスパイル](https://nextjs.org/blog/next-13-1#built-in-module-transpilation-stable)および[インポートのモジュール化](https://nextjs.org/blog/next-13-1#import-resolution-for-smaller-bundles)が安定版です。 |
| `v13.0.0`  | SWC Minifierがデフォルトで有効化されました。                                                                                                                                                                              |
| `v12.3.0`  | SWC Minifier [安定版](https://nextjs.org/blog/next-12-3#swc-minifier-stable)。                                                                                                                                            |
| `v12.2.0`  | [SWCプラグイン](#swc-plugins-experimental)の実験的サポートが追加されました。                                                                                                                                              |
| `v12.1.0`  | Styled Components、Jest、Relay、Reactプロパティの削除、レガシーデコレーター、コンソールの削除、およびjsxImportSourceのサポートが追加されました。                                                                          |
| `v12.0.0`  | Next.js Compiler [が導入されました](https://nextjs.org/blog/next-12)。                                                                                                                                                    |
