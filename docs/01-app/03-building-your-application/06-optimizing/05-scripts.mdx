---
title: 'Script最適化'
nav_title: 'Scripts'
description: '組み込みのScriptコンポーネントを使用してサードパーティスクリプトを最適化します。'
related:
  title: 'APIリファレンス'
  description: 'next/script APIの詳細を学びましょう。'
  links:
    - app/api-reference/components/script
---

{/* このドキュメントの内容はapp routerとpages routerの間で共有されています。Pages Routerに特化した内容を追加するには、`<PagesOnly>コンテンツ</PagesOnly>`コンポーネントを使用できます。共有されたコンテンツは、コンポーネントでラップしないでください。 */}

<AppOnly>

### レイアウトスクリプト {#layout-scripts}

複数のルートに対してサードパーティスクリプトを読み込むためには、`next/script`をインポートし、スクリプトをレイアウトコンポーネント内に直接含めます：

<Tabs>
<TabItem value="tsx" label="TypeScript">

```tsx title="app/dashboard/layout.tsx" switcher
import Script from 'next/script'

export default function DashboardLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <>
      <section>{children}</section>
      <Script src="https://example.com/script.js" />
    </>
  )
}
```

</TabItem>
<TabItem value="jsx" label="JavaScript">

```jsx title="app/dashboard/layout.js" switcher
import Script from 'next/script'

export default function DashboardLayout({ children }) {
  return (
    <>
      <section>{children}</section>
      <Script src="https://example.com/script.js" />
    </>
  )
}
```

</TabItem>
</Tabs>

ユーザーがフォルダルート（例えば`dashboard/page.js`）または任意のネストされたルート（例えば`dashboard/settings/page.js`）にアクセスすると、サードパーティスクリプトが取得されます。Next.jsは、ユーザーが同じレイアウト内で複数のルートを移動しても、スクリプトが**一度だけ**読み込まれることを保証します。

</AppOnly>

### アプリケーションスクリプト {#application-scripts}

<AppOnly>

すべてのルートに対してサードパーティスクリプトを読み込むためには、`next/script`をインポートし、root レイアウトにスクリプトを直接含めます：

<Tabs>
<TabItem value="tsx" label="TypeScript">

```tsx title="app/layout.tsx" switcher
import Script from 'next/script'

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="en">
      <body>{children}</body>
      <Script src="https://example.com/script.js" />
    </html>
  )
}
```

</TabItem>
<TabItem value="jsx" label="JavaScript">

```jsx title="app/layout.js" switcher
import Script from 'next/script'

export default function RootLayout({ children }) {
  return (
    <html lang="en">
      <body>{children}</body>
      <Script src="https://example.com/script.js" />
    </html>
  )
}
```

</TabItem>
</Tabs>

</AppOnly>

<PagesOnly>

すべてのルートに対してサードパーティスクリプトを読み込むためには、`next/script`をインポートし、カスタム`_app`にスクリプトを直接含めます：

```jsx title="pages/_app.js"
import Script from 'next/script'

export default function MyApp({ Component, pageProps }) {
  return (
    <>
      <Component {...pageProps} />
      <Script src="https://example.com/script.js" />
    </>
  )
}
```

</PagesOnly>

このスクリプトはアプリケーション内の*どの*ルートにアクセスしたときにも読み込みおよび実行されます。Next.jsは、ユーザーが複数のページを移動しても、スクリプトが**一度だけ**読み込まれることを保証します。

> **おすすめ**: パフォーマンスへの不要な影響を最小限に抑えるために、特定のページまたはレイアウトにのみサードパーティスクリプトを含めることをお勧めします。

### 戦略 {#strategy}

`next/script`のデフォルトの動作では、任意のページまたはレイアウトでサードパーティスクリプトを読み込むことができますが、`strategy`プロパティを使用してその読み込み動作を微調整できます：

- `beforeInteractive`: どのNext.jsコードよりも前に、ページのハイドレーションが発生する前にスクリプトを読み込みます。
- `afterInteractive`: （**デフォルト**）スクリプトを早期に読み込みますが、ページの一部がハイドレートされた後に読み込みます。
- `lazyOnload`: ブラウザのアイドル状態のときに遅れてスクリプトを読み込みます。
- `worker`: （実験的）スクリプトをWebワーカーで読み込みます。

各戦略とその使用ケースについては、[`next/script`](/docs/app/api-reference/components/script#strategy) APIリファレンスドキュメントを参照してください。

### スクリプトのWeb Workerへのオフロード（実験的） {#offloading-scripts-to-a-web-worker-experimental}

> **警告**: `worker`戦略はまだ安定しておらず、App Routerと一緒に動作しません。慎重に使用してください。

`worker`戦略を使用するスクリプトは、[Partytown](https://partytown.builder.io/)を使用してWebワーカーでオフロードおよび実行されます。これにより、メインスレッドを他のアプリケーションコードに専念させることで、サイトのパフォーマンスを向上させることができます。

この戦略はまだ実験的であり、`next.config.js`で`nextScriptWorkers`フラグを有効にした場合にのみ使用できます：

```js title="next.config.js"
module.exports = {
  experimental: {
    nextScriptWorkers: true,
  },
}
```

その後、`next`（通常は`npm run dev`または`yarn dev`）を実行し、Next.jsはセットアップを完了するために必要なパッケージのインストールを案内します：

```bash title="Terminal"
npm run dev
```

次のような指示が表示されます：`npm install @builder.io/partytown`を実行してPartytownをインストールしてください

セットアップが完了すると、`strategy="worker"`と定義することで、Partytownがアプリケーション内で自動的にインスタンス化され、Webワーカーにスクリプトがオフロードされます。

<Tabs>
<TabItem value="tsx" label="TypeScript">

```tsx title="pages/home.tsx" switcher
import Script from 'next/script'

export default function Home() {
  return (
    <>
      <Script src="https://example.com/script.js" strategy="worker" />
    </>
  )
}
```

</TabItem>
<TabItem value="jsx" label="JavaScript">

```jsx title="pages/home.js" switcher
import Script from 'next/script'

export default function Home() {
  return (
    <>
      <Script src="https://example.com/script.js" strategy="worker" />
    </>
  )
}
```

</TabItem>
</Tabs>

Webワーカーにサードパーティスクリプトを読み込む際には、いくつかのトレードオフを考慮する必要があります。詳細については、Partytownの[トレードオフ](https://partytown.builder.io/trade-offs)ドキュメントを参照してください。

<PagesOnly>

#### カスタムPartytown設定の使用 {#using-custom-partytown-configuration}

`worker`戦略は追加の設定を必要としませんが、Partytownは設定オブジェクトを使用して、`debug`モードの有効化やイベントとトリガーの転送など、一部の設定を変更することをサポートしています。

追加の設定オプションを追加したい場合は、[カスタム`_document.js`](https://nextjs.org/docs/canary/pages/building-your-application/routing/custom-document)で使用する`<Head />`コンポーネント内に含めることができます：

```jsx title="_pages/document.jsx"
import { Html, Head, Main, NextScript } from 'next/document'

export default function Document() {
  return (
    <Html>
      <Head>
        <script
          data-partytown-config
          dangerouslySetInnerHTML={{
            __html: `
              partytown = {
                lib: "/_next/static/~partytown/",
                debug: true
              };
            `,
          }}
        />
      </Head>
      <body>
        <Main />
        <NextScript />
      </body>
    </Html>
  )
}
```

Partytownの設定を変更するには、以下の条件を満たす必要があります：

1. `data-partytown-config`属性を使用して、Next.jsで使用されるデフォルト設定を上書きする必要があります
2. Partytownのライブラリファイルを別のディレクトリに保存することを決定しない限り、Next.jsが必要な静的ファイルを保存する場所をPartytownに知らせるために、設定オブジェクトに`lib: "/_next/static/~partytown/"`プロパティと値を含める必要があります。

> **注意**: [アセットプレフィックス](https://nextjs.org/docs/canary/pages/api-reference/config/next-config-js/assetPrefix)を使用していて、Partytownのデフォルト設定を変更したい場合は、それを`lib`パスの一部として含める必要があります。

追加できる他のプロパティの完全なリストを確認するには、Partytownの[設定オプション](https://partytown.builder.io/configuration)を参照してください。

</PagesOnly>

### インラインスクリプト {#inline-scripts}

インラインスクリプト、つまり外部ファイルから読み込まないスクリプトもScriptコンポーネントでサポートされています。スクリプトは、JavaScriptを波括弧内に配置することで書くことができます：

```jsx
<Script id="show-banner">
  {`document.getElementById('banner').classList.remove('hidden')`}
</Script>
```

または`dangerouslySetInnerHTML`プロパティを使用することもできます：

```jsx
<Script
  id="show-banner"
  dangerouslySetInnerHTML={{
    __html: `document.getElementById('banner').classList.remove('hidden')`,
  }}
/>
```

> **警告**: Next.jsがスクリプトを追跡し最適化するために、インラインスクリプトには`id`プロパティを割り当てる必要があります。

### 追加のコードを実行する {#executing-additional-code}

スクリプトのロード後、特定のイベントが発生したときに追加のコードを実行するために、Scriptコンポーネントでイベントハンドラを使用できます：

- `onLoad`: スクリプトの読み込みが完了した後にコードを実行します
- `onReady`: スクリプトの読み込みが完了し、コンポーネントがマウントされるたびにコードを実行します
- `onError`: スクリプトの読み込みが失敗した場合にコードを実行します

<AppOnly>

これらのハンドラは、[Client Component](/docs/app/building-your-application/rendering/client-components)内で`next/script`をインポートし、コードの最初の行に`"use client"`を定義したときにのみ動作します：

<Tabs>
<TabItem value="tsx" label="TypeScript">

```tsx title="app/page.tsx" switcher
'use client'

import Script from 'next/script'

export default function Page() {
  return (
    <>
      <Script
        src="https://example.com/script.js"
        onLoad={() => {
          console.log('Script has loaded')
        }}
      />
    </>
  )
}
```

</TabItem>
<TabItem value="jsx" label="JavaScript">

```jsx title="app/page.js" switcher
'use client'

import Script from 'next/script'

export default function Page() {
  return (
    <>
      <Script
        src="https://example.com/script.js"
        onLoad={() => {
          console.log('Script has loaded')
        }}
      />
    </>
  )
}
```

</TabItem>
</Tabs>

[`next/script`](/docs/app/api-reference/components/script#onload) APIリファレンスを参照して、各イベントハンドラについて詳しく学び、例を確認してください。

</AppOnly>

<PagesOnly>

これらのハンドラは、[Client Component](/docs/app/building-your-application/rendering/client-components)内で`next/script`をインポートし、コードの最初の行に`"use client"`を定義したときにのみ動作します：

<Tabs>
<TabItem value="tsx" label="TypeScript">

```tsx title="pages/index.tsx" switcher
import Script from 'next/script'

export default function Page() {
  return (
    <>
      <Script
        src="https://example.com/script.js"
        onLoad={() => {
          console.log('Script has loaded')
        }}
      />
    </>
  )
}
```

</TabItem>
<TabItem value="jsx" label="JavaScript">

```jsx title="pages/index.js" switcher
import Script from 'next/script'

export default function Page() {
  return (
    <>
      <Script
        src="https://example.com/script.js"
        onLoad={() => {
          console.log('Script has loaded')
        }}
      />
    </>
  )
}
```

</TabItem>
</Tabs>

[`next/script`](https://nextjs.org/docs/canary/pages/api-reference/components/script#onload) APIリファレンスを参照して、各イベントハンドラについて詳しく学び、例を確認してください。

</PagesOnly>

### 追加の属性 {#additional-attributes}

Scriptコンポーネントで使用されない`<script>`要素に割り当てることができるDOM属性は数多くあります。例えば[`nonce`](https://developer.mozilla.org/docs/Web/HTML/Global_attributes/nonce)や[カスタムデータ属性](https://developer.mozilla.org/docs/Web/HTML/Global_attributes/data-*)です。追加の属性を含めると、それはHTMLに含まれる最適化された最終的な`<script>`要素に自動的に転送されます。

<AppOnly>

<Tabs>
<TabItem value="tsx" label="TypeScript">

```tsx title="app/page.tsx" switcher
import Script from 'next/script'

export default function Page() {
  return (
    <>
      <Script
        src="https://example.com/script.js"
        id="example-script"
        nonce="XUENAJFW"
        data-test="script"
      />
    </>
  )
}
```

</TabItem>
<TabItem value="jsx" label="JavaScript">

```jsx title="app/page.js" switcher
import Script from 'next/script'

export default function Page() {
  return (
    <>
      <Script
        src="https://example.com/script.js"
        id="example-script"
        nonce="XUENAJFW"
        data-test="script"
      />
    </>
  )
}
```

</TabItem>
</Tabs>

</AppOnly>

<PagesOnly>

<Tabs>
<TabItem value="tsx" label="TypeScript">

```tsx title="pages/index.tsx" switcher
import Script from 'next/script'

export default function Page() {
  return (
    <>
      <Script
        src="https://example.com/script.js"
        id="example-script"
        nonce="XUENAJFW"
        data-test="script"
      />
    </>
  )
}
```

</TabItem>
<TabItem value="jsx" label="JavaScript">

```jsx title="pages/index.js" switcher
import Script from 'next/script'

export default function Page() {
  return (
    <>
      <Script
        src="https://example.com/script.js"
        id="example-script"
        nonce="XUENAJFW"
        data-test="script"
      />
    </>
  )
}
```

</TabItem>
</Tabs>

</PagesOnly>
