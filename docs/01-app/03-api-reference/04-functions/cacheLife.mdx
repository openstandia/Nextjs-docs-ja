---
title: 'cacheLife'
description: 'キャッシュされた関数やコンポーネントのキャッシュ有効期限を設定するためのcacheLife関数の使い方を学びましょう'
version: 'canary'
related:
  title: 'Related'
  description: '関連するAPIリファレンスを表示します'
  links:
    - app/api-reference/config/next-config-js/dynamicIO
    - app/api-reference/directives/use-cache
    - app/api-reference/functions/revalidateTag
    - app/api-reference/functions/cacheTag
---

`cacheLife`関数は、関数やコンポーネントのキャッシュ寿命を設定するために使用されます。[`use cache`](/docs/app/api-reference/directives/use-cache)ディレクティブと併用し、関数やコンポーネントのスコープ内で使用します。

## 利用法 {#usage}

`cacheLife`を使用するためには、`next.config.js`ファイルで[`dynamicIO`フラグ](/docs/app/api-reference/config/next-config-js/dynamicIO)を有効化してください：

<Tabs>
<TabItem value="ts" label="TypeScript">

```ts title="next.config.ts" switcher
import type { NextConfig } from 'next'

const nextConfig: NextConfig = {
  experimental: {
    dynamicIO: true,
  },
}

export default nextConfig
```

</TabItem>
<TabItem value="js" label="JavaScript">

```js title="next.config.js" switcher
const nextConfig = {
  experimental: {
    dynamicIO: true,
  },
}

export default nextConfig
```

</TabItem>
</Tabs>

次に、関数やコンポーネントのスコープ内で`cacheLife`関数をインポートして呼び出します：

<Tabs>
<TabItem value="tsx" label="TypeScript">

```tsx title="app/page.tsx" highlight={5} switcher
'use cache'
import { unstable_cacheLife as cacheLife } from 'next/cache'

export default async function Page() {
  cacheLife('hours')
  return <div>Page</div>
}
```

</TabItem>
<TabItem value="jsx" label="JavaScript">

```jsx title="app/page.js" highlight={5} switcher
'use cache'
import { unstable_cacheLife as cacheLife } from 'next/cache'

export default async function Page() {
  cacheLife('hours')
  return <div>Page</div>
}
```

</TabItem>
</Tabs>

## リファレンス {#reference}

### デフォルトのキャッシュプロファイル {#default-cache-profiles}

Next.jsは、さまざまな時間スケールをモデルにした一連の命名されたキャッシュプロファイルを提供します。`use cache`ディレクティブとともに`cacheLife`関数でキャッシュプロファイルを指定しない場合、Next.jsは自動的に「default」キャッシュプロファイルを適用します。

ただし、`use cache`ディレクティブを使用する際には、キャッシュの動作を明確に定義するため、キャッシュプロファイルを常に追加することをお勧めします。

| **プロファイル** | **Stale** | **Revalidate** | **Expire**     | **説明**                                                                 |
| ---------------- | --------- | -------------- | -------------- | ------------------------------------------------------------------------ |
| `default`        | undefined | 15 分          | INFINITE_CACHE | デフォルトプロファイル。頻繁に更新する必要のないコンテンツに適しています |
| `seconds`        | undefined | 1 秒           | 1 分           | ほぼリアルタイムの更新が必要な急速に変化するコンテンツ用                 |
| `minutes`        | 5 分      | 1 分           | 1 時間         | 1 時間以内に頻繁に更新されるコンテンツ用                                 |
| `hours`          | 5 分      | 1 時間         | 1 日           | 毎日更新されるが、多少古くてもよいコンテンツ用                           |
| `days`           | 5 分      | 1 日           | 1 週間         | 毎週更新されるが、1 日古くてもよいコンテンツ用                           |
| `weeks`          | 5 分      | 1 週間         | 1 か月         | 毎月更新されるが、1 週間古くてもよいコンテンツ用                         |
| `max`            | 5 分      | 1 か月         | INFINITE_CACHE | ほとんど更新が必要ない非常に安定したコンテンツ用                         |

キャッシュプロファイルを参照するために使用される文字列値には固有の意味はなく、セマンティックなラベルとして機能します。これにより、コードベース内のキャッシュされたコンテンツをより理解し、管理しやすくなります。

### カスタムキャッシュプロファイル {#custom-cache-profiles}

カスタムキャッシュプロファイルを、`next.config.ts`ファイルの[`cacheLife`](/docs/app/api-reference/config/next-config-js/cacheLife)オプションに追加することで設定できます。

キャッシュプロファイルは、次のプロパティを含むオブジェクトです：

| **プロパティ** | **値**   | **説明**                                                                               | **要件**                                          |
| -------------- | -------- | -------------------------------------------------------------------------------------- | ------------------------------------------------- |
| `stale`        | `number` | クライアントがサーバーをチェックせずにキャッシュを持つ時間の長さ;                      | オプショナル                                      |
| `revalidate`   | `number` | キャッシュがサーバー側で更新される頻度; 再検証中の古い値でも提供される可能性があります | オプショナル                                      |
| `expire`       | `number` | 動的なフェッチに切り替える前に、どれだけ古くなることができるかの最大期間;              | オプショナル - `revalidate`より長くする必要がある |

`stale`プロパティは、[`staleTimes`](/docs/app/api-reference/config/next-config-js/staleTimes)設定とは異なり、特にクライアント側のrouterキャッシングを制御します。`staleTimes`は動的および静的データのすべてのインスタンスに影響を与えるグローバル設定である一方で、`cacheLife`設定は関数やルート単位での"stale"時間を定義できます。

> **Good to know**: `stale`プロパティは`Cache-control: max-age`ヘッダーを設定しません。代わりに、クライアント側のrouterキャッシュを制御します。

## 例 {#examples}

### 再利用可能なキャッシュプロファイルの定義 {#defining-reusable-cache-profiles}

再利用可能なキャッシュプロファイルを`next.config.ts`ファイルで定義して作成できます。あなたのユースケースに合う名前を選び、`stale`、`revalidate`、および`expire`プロパティの値を設定します。必要に応じて、いくつでもカスタムキャッシュプロファイルを作成可能です。それぞれのプロファイルは、その名前を文字列値として`cacheLife`関数に渡すことで参照できます。

<Tabs>
<TabItem value="ts" label="TypeScript">

```ts title="next.config.ts" switcher
import type { NextConfig } from 'next'

const nextConfig: NextConfig = {
  experimental: {
    dynamicIO: true,
    cacheLife: {
      biweekly: {
        stale: 60 * 60 * 24 * 14, // 14 days
        revalidate: 60 * 60 * 24, // 1 day
        expire: 60 * 60 * 24 * 14, // 14 days
      },
    },
  },
}

module.exports = nextConfig
```

</TabItem>
<TabItem value="js" label="JavaScript">

```js title="next.config.js" switcher
const nextConfig = {
  experimental: {
    dynamicIO: true,
    cacheLife: {
      biweekly: {
        stale: 60 * 60 * 24 * 14, // 14 days
        revalidate: 60 * 60 * 24, // 1 day
        expire: 60 * 60 * 24 * 14, // 14 days
      },
    },
  },
}

module.exports = nextConfig
```

</TabItem>
</Tabs>

上記の例では、14日間キャッシュし、毎日更新を確認し、14日後にキャッシュを期限切れにします。その後、アプリケーション全体でこのプロファイルを名前で参照可能です：

```tsx title="app/page.tsx" highlight={5}
'use cache'
import { unstable_cacheLife as cacheLife } from 'next/cache'

export default async function Page() {
  cacheLife('biweekly')
  return <div>Page</div>
}
```

### デフォルトのキャッシュプロファイルを上書きする {#overriding-the-default-cache-profiles}

デフォルトのキャッシュプロファイルは、キャッシュ可能な出力が新鮮か古いかを考えるための有用な手段を提供します。ただし、アプリケーションのキャッシュ戦略により良く一致する別の名前付きプロファイルを使用したい場合もあります。

デフォルト名と同じ名前で新しい構成を作成することで、デフォルトのキャッシュプロファイルを上書きできます。

以下の例は、デフォルトの「days」キャッシュプロファイルを上書きする方法を示します：

```ts title="next.config.ts"
const nextConfig = {
  experimental: {
    dynamicIO: true,
    cacheLife: {
      days: {
        stale: 3600, // 1 hour
        revalidate: 900, // 15 minutes
        expire: 86400, // 1 day
      },
    },
  },
}

module.exports = nextConfig
```

### インラインでキャッシュプロファイルを定義する {#defining-cache-profiles-inline}

特定のユースケースに対して、オブジェクトを`cacheLife`関数に渡し、カスタムキャッシュプロファイルを設定します：

<Tabs>
<TabItem value="tsx" label="TypeScript">

```tsx title="app/page.tsx" highlight={5-9} switcher
'use cache'
import { unstable_cacheLife as cacheLife } from 'next/cache'

export default async function Page() {
  cacheLife({
    stale: 3600, // 1 hour
    revalidate: 900, // 15 minutes
    expire: 86400, // 1 day
  })

  return <div>Page</div>
}
```

</TabItem>
<TabItem value="jsx" label="JavaScript">

```jsx title="app/page.js" highlight={5-9} switcher
'use cache'
import { unstable_cacheLife as cacheLife } from 'next/cache'

export default async function Page() {
  cacheLife({
    stale: 3600, // 1 hour
    revalidate: 900, // 15 minutes
    expire: 86400, // 1 day
  })

  return <div>Page</div>
}
```

</TabItem>
</Tabs>

このインラインキャッシュプロファイルは、作成された関数またはファイルにのみ適用されます。アプリケーション全体で同じプロファイルを再利用したい場合、`next.config.ts`ファイルの`cacheLife`プロパティに[構成を追加](#defining-reusable-cache-profiles)することができます。

### `use cache`と`cacheLife`のネスト使用 {#nested-usage-of-use-cache-and-cachelife}

同じルートやコンポーネントtreeで複数のキャッシュ動作を定義する場合、内部キャッシュが独自の`cacheLife`プロファイルを指定している場合、外部キャッシュはそれらの中で最短のキャッシュ期間を尊重します。これは、外部キャッシュが自分自身の明示的な`cacheLife`プロファイルを持たない場合にのみ適用されます。

例えば、ページに`use cache`ディレクティブを追加し、キャッシュプロファイルを指定しない場合、デフォルトのキャッシュプロファイルが暗黙的に適用されます（`cacheLife(”default”)`）。ページにインポートされたコンポーネントも独自のキャッシュプロファイルを使用して`use cache`ディレクティブを使用している場合、外部と内部のキャッシュプロファイルが比較され、プロファイルで設定された最短期間が適用されます。

```tsx title="app/components/parent.tsx" highlight={5,6}
// 親コンポーネント
import { unstable_cacheLife as cacheLife } from 'next/cache'
import { ChildComponent } from './child'

export async function ParentComponent() {
  'use cache'
  cacheLife('days')

  return (
    <div>
      <ChildComponent />
    </div>
  )
}
```

別のファイルでインポートされた子コンポーネントを定義しました：

```tsx title="app/components/child.tsx" highlight={4,5}
// 子コンポーネント
import { unstable_cacheLife as cacheLife } from 'next/cache'

export async function ChildComponent() {
  'use cache'
  cacheLife('hours')
  return <div>Child Content</div>

  // このコンポーネントのキャッシュはより短い「hours」プロファイルを尊重します
}
```
