---
title: 'cacheLife'
description: 'キャッシュされた関数やコンポーネントのキャッシュ有効期限を設定するcacheLife関数の使い方を学びましょう。'
version: 'canary'
related:
  title: 'Related'
  description: '関連するAPIリファレンスを見る。'
  links:
    - app/api-reference/config/next-config-js/dynamicIO
    - app/api-reference/directives/use-cache
    - app/api-reference/functions/revalidateTag
    - app/api-reference/functions/cacheTag
---

`cacheLife`関数は、関数やコンポーネントのキャッシュの有効期間を設定するために使用されます。これは[`use cache`](/docs/app/api-reference/directives/use-cache)ディレクティブと一緒に、関数またはコンポーネントのスコープ内で使用されるべきです。

## 使用法 {#usage}

`cacheLife`を使用するには、`next.config.js`ファイルで[`dynamicIO`フラグ](/docs/app/api-reference/config/next-config-js/dynamicIO)を有効にします：

<Tabs>
<TabItem value="ts" label="TypeScript">

```ts title="next.config.ts" switcher
import type { NextConfig } from 'next'

const nextConfig: NextConfig = {
  experimental: {
    dynamicIO: true,
  },
}

export default nextConfig
```

</TabItem>
<TabItem value="js" label="JavaScript">

```js title="next.config.js" switcher
const nextConfig = {
  experimental: {
    dynamicIO: true,
  },
}

export default nextConfig
```

</TabItem>
</Tabs>

その後、関数またはコンポーネントのスコープ内で`cacheLife`関数をインポートし呼び出します：

<Tabs>
<TabItem value="tsx" label="TypeScript">

```tsx title="app/page.tsx" highlight={5} switcher
'use cache'
import { unstable_cacheLife as cacheLife } from 'next/cache'

export default async function Page() {
  cacheLife('hours')
  return <div>Page</div>
}
```

</TabItem>
<TabItem value="jsx" label="JavaScript">

```jsx title="app/page.js" highlight={5} switcher
'use cache'
import { unstable_cacheLife as cacheLife } from 'next/cache'

export default async function Page() {
  cacheLife('hours')
  return <div>Page</div>
}
```

</TabItem>
</Tabs>

## リファレンス {#reference}

### デフォルトのキャッシュプロファイル {#default-cache-profiles}

Next.jsはさまざまな時間スケールに基づいた一連の名前付きキャッシュプロファイルを提供しています。`use cache`ディレクティブと共に`cacheLife`関数でキャッシュプロファイルを指定しない場合、Next.jsは自動的に「default」キャッシュプロファイルを適用します。

ただし、`use cache`ディレクティブを使用する際は、キャッシュの動作を明示的に定義するために常にキャッシュプロファイルを追加することをお勧めします。

| **Profile** | **Stale** | **Revalidate** | **Expire**     | **Description**                                                       |
| ----------- | --------- | -------------- | -------------- | --------------------------------------------------------------------- |
| `default`   | undefined | 15 分          | INFINITE_CACHE | 頻繁な更新が不要なコンテンツに適したデフォルトプロファイル            |
| `seconds`   | undefined | 1 秒           | 1 分           | ほぼリアルタイムの更新が必要な急速に変化するコンテンツに適しています  |
| `minutes`   | 5 分      | 1 分           | 1 時間         | 1時間以内に頻繁に更新されるコンテンツに適している                     |
| `hours`     | 5 分      | 1 時間         | 1 日           | 毎日更新されるが若干古くなっても問題ないコンテンツに適しています      |
| `days`      | 5 分      | 1 日           | 1 週間         | 週ごとに更新されるが1日程度古くても問題ないコンテンツに適しています   |
| `weeks`     | 5 分      | 1 週間         | 1 ヶ月         | 月ごとに更新されるが1週間程度古くても問題ないコンテンツに適しています |
| `max`       | 5 分      | 1 ヶ月         | INFINITE_CACHE | 非常に安定しており、めったに更新が必要ないコンテンツに適しています    |

キャッシュプロファイルを参照するために使用される文字列値には固有の意味はありません；それらはセマンティックラベルとして機能します。これにより、コードベース内でキャッシュされたコンテンツをより良く理解し、管理することができます。

### カスタムキャッシュプロファイル {#custom-cache-profiles}

`next.config.ts`ファイルの[`cacheLife`](/docs/app/api-reference/config/next-config-js/cacheLife)オプションにカスタムキャッシュプロファイルを追加することで設定できます。

キャッシュプロファイルは以下のプロパティを持つオブジェクトです：

| **Property** | **Value** | **Description**                                                                                            | **Requirement**                             |
| ------------ | --------- | ---------------------------------------------------------------------------------------------------------- | ------------------------------------------- |
| `stale`      | `number`  | クライアントがサーバーを確認せずに値をキャッシュする期間。                                                 | Optional                                    |
| `revalidate` | `number`  | サーバー上でキャッシュをリフレッシュする頻度；リフレッシュ中は古い値が提供される場合があります。           | Optional                                    |
| `expire`     | `number`  | 動的フェッチに切り替える前に値が古くなるまでに許容される最大期間；`revalidate`より長くなければなりません。 | Optional - Must be longer than `revalidate` |

"stale"プロパティは[`staleTimes`](/docs/app/api-reference/config/next-config-js/staleTimes)設定とは異なり、クライアントサイドのrouter cacheを特に制御します。`staleTimes`は動的データと静的データの両方のすべてのインスタンスに影響を与えるグローバル設定であるのに対し、`cacheLife`の設定は関数ごとまたはルートごとに"stale"時間を定義できます。

> **Good to know**: "stale"プロパティは`Cache-control: max-age`ヘッダーを設定しません。それはクライアントサイドのrouter cacheを制御します。

## 例 {#examples}

### 再利用可能なキャッシュプロファイルの定義 {#defining-reusable-cache-profiles}

`next.config.ts`ファイルに再利用可能なキャッシュプロファイルを定義することで作成できます。用途に適した名前を選び、`stale`、`revalidate`、`expire`プロパティに値を設定します。必要に応じて多くのカスタムキャッシュプロファイルを作成できます。各プロファイルは、`cacheLife`関数に渡される文字列値である名前によって参照できます。

<Tabs>
<TabItem value="ts" label="TypeScript">

```ts title="next.config.ts" switcher
import type { NextConfig } from 'next'

const nextConfig: NextConfig = {
  experimental: {
    dynamicIO: true,
    cacheLife: {
      biweekly: {
        stale: 60 * 60 * 24 * 14, // 14日
        revalidate: 60 * 60 * 24, // 1日
        expire: 60 * 60 * 24 * 14, // 14日
      },
    },
  },
}

module.exports = nextConfig
```

</TabItem>
<TabItem value="js" label="JavaScript">

```js title="next.config.js" switcher
const nextConfig = {
  experimental: {
    dynamicIO: true,
    cacheLife: {
      biweekly: {
        stale: 60 * 60 * 24 * 14, // 14日
        revalidate: 60 * 60 * 24, // 1日
        expire: 60 * 60 * 24 * 14, // 14日
      },
    },
  },
}

module.exports = nextConfig
```

</TabItem>
</Tabs>

この例では、14日間キャッシュされ、1日ごとに更新をチェックし、14日後にキャッシュが期限切れになります。このプロファイルをアプリケーション全体で名前で参照できます：

```tsx title="app/page.tsx" highlight={5}
'use cache'
import { unstable_cacheLife as cacheLife } from 'next/cache'

export default async function Page() {
  cacheLife('biweekly')
  return <div>Page</div>
}
```

### デフォルトのキャッシュプロファイルを上書きする {#overriding-the-default-cache-profiles}

デフォルトのキャッシュプロファイルは、キャッシュ可能な出力のどの部分がどれくらいの距離感で新鮮または古いのかを考える際に便利な方法を提供しますが、アプリケーションのキャッシュ戦略により適合させるために異なる名前付きプロファイルを好む場合があります。

デフォルトの名前付きキャッシュプロファイルを上書きするには、デフォルトと同じ名前で新しい構成を作成します。

以下の例は、デフォルトの「days」キャッシュプロファイルを上書きする方法を示しています：

```ts title="next.config.ts"
const nextConfig = {
  experimental: {
    dynamicIO: true,
    cacheLife: {
      days: {
        stale: 3600, // 1時間
        revalidate: 900, // 15分
        expire: 86400, // 1日
      },
    },
  },
}

module.exports = nextConfig
```

### インラインでキャッシュプロファイルを定義する {#defining-cache-profiles-inline}

特定のユースケースでは、`cacheLife`関数にオブジェクトを渡すことでカスタムキャッシュプロファイルを設定できます：

<Tabs>
<TabItem value="tsx" label="TypeScript">

```tsx title="app/page.tsx" highlight={5-9} switcher
'use cache'
import { unstable_cacheLife as cacheLife } from 'next/cache'

export default async function Page() {
  cacheLife({
    stale: 3600, // 1時間
    revalidate: 900, // 15分
    expire: 86400, // 1日
  })

  return <div>Page</div>
}
```

</TabItem>
<TabItem value="jsx" label="JavaScript">

```jsx title="app/page.js" highlight={5-9} switcher
'use cache'
import { unstable_cacheLife as cacheLife } from 'next/cache'

export default async function Page() {
  cacheLife({
    stale: 3600, // 1時間
    revalidate: 900, // 15分
    expire: 86400, // 1日
  })

  return <div>Page</div>
}
```

</TabItem>
</Tabs>

このインラインキャッシュプロファイルは、それが作成された関数またはファイルにのみ適用されます。アプリケーション全体で同じプロファイルを再利用したい場合は、`cacheLife`プロパティに[設定を追加する](#defining-reusable-cache-profiles)ことができます。

### `use cache`と`cacheLife`のネストされた使用 {#nested-usage-of-use-cache-and-cachelife}

同じルートやコンポーネントtreeで複数のキャッシング動作を定義する際、内部キャッシュがそれ自身の`cacheLife`プロファイルを指定している場合、外部キャッシュはそれらの中で最も短いキャッシュ期間を尊重します。**これは、外部キャッシュが自分自身の明示的な`cacheLife`プロファイルを持っていない場合にのみ適用されます。**

たとえば、ページに`use cache`ディレクティブを追加してキャッシュプロファイルを指定しない場合、デフォルトのキャッシュプロファイルが暗黙的に適用されます（`cacheLife(”default”)`）。ページにインポートされたコンポーネントが、独自のキャッシュプロファイルを持つ`use cache`ディレクティブを使用する場合、外部と内部のキャッシュプロファイルが比較され、プロファイルで設定された最も短い期間が適用されます。

```tsx title="app/components/parent.tsx" highlight={5,6}
// 親コンポーネント
import { unstable_cacheLife as cacheLife } from 'next/cache'
import { ChildComponent } from './child'

export async function ParentComponent() {
  'use cache'
  cacheLife('days')

  return (
    <div>
      <ChildComponent />
    </div>
  )
}
```

別のファイルで、インポートされた子コンポーネントを定義しました：

```tsx title="app/components/child.tsx" highlight={4,5}
// 子コンポーネント
import { unstable_cacheLife as cacheLife } from 'next/cache'

export async function ChildComponent() {
  'use cache'
  cacheLife('hours')
  return <div>Child Content</div>

  // このコンポーネントのキャッシュは、短い「hours」プロファイルを尊重します
}
```
