---
title: 'cacheLife'
description: 'cacheLife関数を使用して、キャッシュされた関数やコンポーネントのキャッシュ有効期限を設定する方法を学びましょう。'
version: 'カナリア'
related:
  title: '関連'
  description: '関連するAPIリファレンスを表示します。'
  links:
    - app/api-reference/config/next-config-js/dynamicIO
    - app/api-reference/directives/use-cache
    - app/api-reference/functions/revalidateTag
    - app/api-reference/functions/cacheTag
---

`cacheLife`関数は、関数やコンポーネントのキャッシュの有効期間を設定するために使用されます。この関数は、[`use cache`](/docs/app/api-reference/directives/use-cache)ディレクティブと共に使用され、関数またはコンポーネントのスコープ内で使用する必要があります。

## 使用法 {#usage}

`cacheLife`を使用するには、`next.config.js`ファイルで[`dynamicIO`フラグ](/docs/app/api-reference/config/next-config-js/dynamicIO)を有効にしてください：

<Tabs>
<TabItem value="ts" label="TypeScript">

```ts title="next.config.ts" switcher
import type { NextConfig } from 'next'

const nextConfig: NextConfig = {
  experimental: {
    dynamicIO: true,
  },
}

export default nextConfig
```

</TabItem>
<TabItem value="js" label="JavaScript">

```js title="next.config.js" switcher
const nextConfig = {
  experimental: {
    dynamicIO: true,
  },
}

export default nextConfig
```

</TabItem>
</Tabs>

その後、関数やコンポーネントのスコープ内で`cacheLife`関数をインポートして呼び出します：

<Tabs>
<TabItem value="tsx" label="TypeScript">

```tsx title="app/page.tsx" highlight={5} switcher
'use cache'
import { unstable_cacheLife as cacheLife } from 'next/cache'

export default async function Page() {
  cacheLife('hours')
  return <div>Page</div>
}
```

</TabItem>
<TabItem value="jsx" label="JavaScript">

```jsx title="app/page.js" highlight={5} switcher
'use cache'
import { unstable_cacheLife as cacheLife } from 'next/cache'

export default async function Page() {
  cacheLife('hours')
  return <div>Page</div>
}
```

</TabItem>
</Tabs>

## リファレンス {#reference}

### デフォルトのキャッシュプロファイル {#default-cache-profiles}

Next.jsはさまざまな時間単位をモデルにした名前付きキャッシュプロファイルのセットを提供しています。`use cache`ディレクティブと一緒に`cacheLife`関数でキャッシュプロファイルを指定しない場合、Next.jsは自動的に「default」キャッシュプロファイルを適用します。

しかし、`use cache`ディレクティブを使用する際には常にキャッシュプロファイルを追加して、キャッシングの挙動を明示的に定義することを推奨します。

| **プロファイル** | **更新不要** | **再検証** | **期限切れ**   | **説明**                                                           |
| ---------------- | ------------ | ---------- | -------------- | ------------------------------------------------------------------ |
| `default`        | undefined    | 15分       | INFINITE_CACHE | 頻繁に更新される必要のないコンテンツに適したデフォルトプロファイル |
| `seconds`        | undefined    | 1秒        | 1分            | ほぼリアルタイムの更新が必要な急速に変化するコンテンツ向け         |
| `minutes`        | 5分          | 1分        | 1時間          | 1時間以内に頻繁に更新されるコンテンツ向け                          |
| `hours`          | 5分          | 1時間      | 1日            | 毎日更新されるがやや古い状態でも問題ないコンテンツ向け             |
| `days`           | 5分          | 1日        | 1週間          | 週次で更新されるが1日程度古くて構わないコンテンツ向け              |
| `weeks`          | 5分          | 1週間      | 1ヶ月          | 月次で更新されるが1週間程度古くて構わないコンテンツ向け            |
| `max`            | 5分          | 1ヶ月      | INFINITE_CACHE | 更新の必要がほとんどない非常に安定したコンテンツ向け               |

キャッシュプロファイルを参照するために使用される文字列には固有の意味はなく、セマンティックラベルとして機能します。これにより、コードベース内でキャッシュされたコンテンツをよりよく理解し管理することができます。

### カスタムキャッシュプロファイル {#custom-cache-profiles}

`next.config.ts`ファイルの[`cacheLife`](#)オプションにキャッシュプロファイルを追加することでカスタムキャッシュプロファイルを構成することができます。

キャッシュプロファイルは次のプロパティを含むオブジェクトです：

| **プロパティ** | **値**   | **説明**                                                                                   | **要件**                                        |
| -------------- | -------- | ------------------------------------------------------------------------------------------ | ----------------------------------------------- |
| `stale`        | `number` | クライアントがサーバーを確認せずに値をキャッシュする期間                                   | オプション                                      |
| `revalidate`   | `number` | キャッシュがサーバーでリフレッシュされる頻度；再検証中は古い値が提供される可能性があります | オプション                                      |
| `expire`       | `number` | 値が古くなったままでいられる最大期間；`revalidate`より長くなければなりません               | オプション - `revalidate`より長い必要があります |

「stale」プロパティは、クライアント側のrouter cachingを具体的に制御する点で[`staleTimes`](#)設定とは異なります。`staleTimes`は動的データと静的データの両方のインスタンスに影響を与えるグローバル設定ですが、`cacheLife`設定は1つの関数またはルート単位で「stale」時間を定義することを可能にします。

> **知っておくと良いこと**：「stale」プロパティは`Cache-control: max-age`ヘッダーを設定するものではありません。代わりに、クライアント側のrouter cacheを制御します。

## 例 {#examples}

### 再利用可能なキャッシュプロファイルの定義 {#defining-reusable-cache-profiles}

`next.config.ts`ファイルでキャッシュプロファイルを定義することで再利用可能なキャッシュプロファイルを作成できます。あなたのユースケースに合った名前を選び、`stale`、`revalidate`、および`expire`プロパティの値を設定します。必要に応じて複数のカスタムキャッシュプロファイルを作成できます。各プロファイルは、その名前を文字列値として`cacheLife`関数に渡すことで参照できます。

<Tabs>
<TabItem value="ts" label="TypeScript">

```ts title="next.config.ts" switcher
import type { NextConfig } from 'next'

const nextConfig: NextConfig = {
  experimental: {
    dynamicIO: true,
    cacheLife: {
      biweekly: {
        stale: 60 * 60 * 24 * 14, // 14 days
        revalidate: 60 * 60 * 24, // 1 day
        expire: 60 * 60 * 24 * 14, // 14 days
      },
    },
  },
}

module.exports = nextConfig
```

</TabItem>
<TabItem value="js" label="JavaScript">

```js title="next.config.js" switcher
const nextConfig = {
  experimental: {
    dynamicIO: true,
    cacheLife: {
      biweekly: {
        stale: 60 * 60 * 24 * 14, // 14 days
        revalidate: 60 * 60 * 24, // 1 day
        expire: 60 * 60 * 24 * 14, // 14 days
      },
    },
  },
}

module.exports = nextConfig
```

</TabItem>
</Tabs>

上記の例は、14日間キャッシュし、毎日更新をチェックし、14日後にキャッシュが期限切れになるように設定しています。このプロファイルは、アプリケーション全体で名前を指定して参照できます：

```tsx title="app/page.tsx" highlight={5}
'use cache'
import { unstable_cacheLife as cacheLife } from 'next/cache'

export default async function Page() {
  cacheLife('biweekly')
  return <div>Page</div>
}
```

### デフォルトのキャッシュプロファイルを上書きする {#overriding-the-default-cache-profiles}

デフォルトのキャッシュプロファイルは、キャッシュ可能な出力の特定の部分がどの程度新鮮または古くなっているかを考えるのに役立ちますが、アプリケーションのキャッシュ戦略とよりよく一致させるために、異なる名前付きプロファイルを好む場合があります。

デフォルトの名前付きキャッシュプロファイルを上書きするには、デフォルトと同じ名前で新しい構成を作成します。

以下の例は、デフォルトの「days」キャッシュプロファイルを上書きする方法を示しています：

```ts title="next.config.ts"
const nextConfig = {
  experimental: {
    dynamicIO: true,
    cacheLife: {
      days: {
        stale: 3600, // 1 hour
        revalidate: 900, // 15 minutes
        expire: 86400, // 1 day
      },
    },
  },
}

module.exports = nextConfig
```

### インラインでキャッシュプロファイルを定義する {#defining-cache-profiles-inline}

特定のユースケースの場合、`cacheLife`関数にオブジェクトを渡すことによりカスタムキャッシュプロファイルを設定できます：

<Tabs>
<TabItem value="tsx" label="TypeScript">

```tsx title="app/page.tsx" highlight={5-9} switcher
'use cache'
import { unstable_cacheLife as cacheLife } from 'next/cache'

export default async function Page() {
  cacheLife({
    stale: 3600, // 1 hour
    revalidate: 900, // 15 minutes
    expire: 86400, // 1 day
  })

  return <div>Page</div>
}
```

</TabItem>
<TabItem value="jsx" label="JavaScript">

```jsx title="app/page.js" highlight={5-9} switcher
'use cache'
import { unstable_cacheLife as cacheLife } from 'next/cache'

export default async function Page() {
  cacheLife({
    stale: 3600, // 1 hour
    revalidate: 900, // 15 minutes
    expire: 86400, // 1 day
  })

  return <div>Page</div>
}
```

</TabItem>
</Tabs>

このインラインキャッシュプロファイルは、それが作成された関数またはファイルにのみ適用されます。同じプロファイルをアプリケーション全体で再利用したい場合は、`next.config.ts`ファイルの`cacheLife`プロパティに[設定を追加](#defining-reusable-cache-profiles)できます。

### `use cache`と`cacheLife`のネスト使用 {#nested-usage-of-use-cache-and-cachelife}

同じルートやコンポーネントツリーで複数のキャッシュ動作を定義する場合、内側のキャッシュが自身の`cacheLife`プロファイルを指定している場合、外側のキャッシュはそれらの中で最も短いキャッシュ期間を尊重します。**これは、外側のキャッシュが自身の明示的な`cacheLife`プロファイルを持っていない場合にのみ適用されます。**

たとえば、ページに`use cache`ディレクティブを追加し、キャッシュプロファイルを指定しない場合、デフォルトのキャッシュプロファイルが暗黙的に適用されます（`cacheLife(”default”)`）。ページにインポートされているコンポーネントも`use cache`ディレクティブを自身のキャッシュプロファイルで使用している場合、外側と内側のキャッシュプロファイルが比較され、プロファイル内で設定された最も短い期間が適用されます。

```tsx title="app/components/parent.tsx" highlight={5,6}
// 親コンポーネント
import { unstable_cacheLife as cacheLife } from 'next/cache'
import { ChildComponent } from './child'

export async function ParentComponent() {
  'use cache'
  cacheLife('days')

  return (
    <div>
      <ChildComponent />
    </div>
  )
}
```

そして別のファイルでインポートされた子コンポーネントを定義しました：

```tsx title="app/components/child.tsx" highlight={4,5}
// 子コンポーネント
import { unstable_cacheLife as cacheLife } from 'next/cache'

export async function ChildComponent() {
  'use cache'
  cacheLife('hours')
  return <div>Child Content</div>

  // このコンポーネントのキャッシュは短い時間の 'hours' プロファイルを尊重します
}
```
