---
title: 'Custom Server'
description: 'カスタムサーバーを使用してNext.jsアプリをプログラム的に起動する。'
---

{/* このドキュメントの内容は、app router と pages router の間で共有されています。Pages Router に特化した内容を追加するには、 `<PagesOnly>Content</PagesOnly>` コンポーネントを使用してください。共有される内容は、コンポーネントで囲まないでください。 */}

Next.jsはデフォルトで `next start` とともに独自のサーバーを提供しています。もしあなたが既存のバックエンドを持っているなら、それをNext.jsとともに使用することも可能です（これがカスタムサーバーではありません）。カスタムNext.jsサーバーを使うと、独自のパターンでサーバーをプログラム的に起動することができます。ほとんどの場合、この方法は必要ありません。しかし、必要に応じて使用可能です。

> **知っておくと良いこと**：
>
> - カスタムサーバーを使用することを決定する前に、Next.jsの統合ルーターがアプリの要件を満たせない場合にのみ使用すべきであることを忘れないでください。カスタムサーバーは、**[Automatic Static Optimization](https://nextjs.org/docs/canary/pages/building-your-application/rendering/automatic-static-optimization)** などの重要なパフォーマンス最適化を削除します。
> - カスタムサーバーは[ Vercel](https://vercel.com/frameworks/nextjs) にデプロイ**できません**。
> - スタンドアロン出力モードを使用する場合、カスタムサーバーファイルをトレースしません。このモードは、代わりに別個の最小限の `server.js` ファイルを出力します。これらは一緒に使用することはできません。

以下のカスタムサーバーの[例](https://github.com/vercel/next.js/tree/canary/examples/custom-server)を見てください：

<Tabs>
<TabItem value="ts" label="TypeScript">

```ts title="server.ts" switcher
import { createServer } from 'http'
import { parse } from 'url'
import next from 'next'

const port = parseInt(process.env.PORT || '3000', 10)
const dev = process.env.NODE_ENV !== 'production'
const app = next({ dev })
const handle = app.getRequestHandler()

app.prepare().then(() => {
  createServer((req, res) => {
    const parsedUrl = parse(req.url!, true)
    handle(req, res, parsedUrl)
  }).listen(port)

  console.log(
    `> Server listening at http://localhost:${port} as ${
      dev ? 'development' : process.env.NODE_ENV
    }`
  )
})
```

</TabItem>
<TabItem value="js" label="JavaScript">

```js title="server.js" switcher
import { createServer } from 'http'
import { parse } from 'url'
import next from 'next'

const port = parseInt(process.env.PORT || '3000', 10)
const dev = process.env.NODE_ENV !== 'production'
const app = next({ dev })
const handle = app.getRequestHandler()

app.prepare().then(() => {
  createServer((req, res) => {
    const parsedUrl = parse(req.url, true)
    handle(req, res, parsedUrl)
  }).listen(port)

  console.log(
    `> Server listening at http://localhost:${port} as ${
      dev ? 'development' : process.env.NODE_ENV
    }`
  )
})
```

</TabItem>
</Tabs>

> `server.js` はNext.jsのコンパイラやバンドルプロセスを通過しません。このファイルが要求する構文およびソースコードが、使用している現在のNode.jsバージョンと互換性があることを確認してください。[例を確認](https://github.com/vercel/next.js/tree/canary/examples/custom-server)してください。

カスタムサーバーを起動するには、`package.json` の `scripts` を以下のように更新する必要があります：

```json title="package.json"
{
  "scripts": {
    "dev": "node server.js",
    "build": "next build",
    "start": "NODE_ENV=production node server.js"
  }
}
```

または、`nodemon` をセットアップすることもできます（[例示](https://github.com/vercel/next.js/tree/canary/examples/custom-server)）。カスタムサーバーは、次のインポートを使用してサーバーとNext.jsアプリケーションを接続します：

```js
import next from 'next'

const app = next({})
```

上記の `next` のインポートは、以下のオプションを持つオブジェクトを受け取る関数です：

| オプション   | タイプ             | 説明                                                                                  |
| ------------ | ------------------ | ------------------------------------------------------------------------------------- |
| `conf`       | `Object`           | `next.config.js` で使用するのと同じオブジェクト。デフォルトは `{}`                    |
| `dev`        | `Boolean`          | (_オプション_) Next.jsを開発モードで起動するかどうか。デフォルトは `false`            |
| `dir`        | `String`           | (_オプション_) Next.jsプロジェクトの位置。デフォルトは `'.'`                          |
| `quiet`      | `Boolean`          | (_オプション_) サーバー情報を含むエラーメッセージを非表示にする。デフォルトは `false` |
| `hostname`   | `String`           | (_オプション_) サーバーが実行されているホスト名                                       |
| `port`       | `Number`           | (_オプション_) サーバーが実行されているポート                                         |
| `httpServer` | `node:http#Server` | (_オプション_) Next.jsが実行されているHTTPサーバー                                    |
| `turbo`      | `Boolean`          | (_オプション_) Turbopackを有効にする                                                  |

返された `app` を使用して、必要に応じてNext.jsがリクエストを処理することができます。

<PagesOnly>

## ファイルシステムルーティングの無効化 {#disabling-file-system-routing}

デフォルトでは、`Next`は `pages` フォルダ内の各ファイルを、ファイル名に一致するパス名の下で提供します。プロジェクトがカスタムサーバーを使用している場合、この動作により、同じコンテンツが複数のパスから提供される可能性があり、SEOやUXに問題を引き起こすことがあります。

この動作を無効にし、`pages` 内のファイルに基づくルーティングを防ぐには、`next.config.js` を開き、`useFileSystemPublicRoutes` 設定を無効にしてください：

```js title="next.config.js"
module.exports = {
  useFileSystemPublicRoutes: false,
}
```

> `useFileSystemPublicRoutes` はSSRからのファイル名ルートを無効にしますが、クライアントサイドのルーティングはそれらのパスにアクセスすることが停止されないことに注意してください。このオプションを使用する場合、ナビゲーションをプログラム的に行いたくないルートへの移動を防ぐべきです。

> また、クライアントサイドルーターを設定して、クライアントサイドリダイレクトをファイル名ルートへのリダイレクトから禁止することを望むかもしれません。そのためには、[`router.beforePopState`](https://nextjs.org/docs/canary/pages/api-reference/functions/use-router#routerbeforepopstate)を参照してください。

</PagesOnly>
