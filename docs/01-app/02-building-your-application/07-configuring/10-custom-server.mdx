---
title: 'Custom Server'
description: 'カスタムサーバーを使用してNext.jsアプリをプログラム的に開始します；'
---

{/* このドキュメントの内容はapp routerとpages routerで共有されています。Pages Routerに特化した内容を追加するには `<PagesOnly>Content</PagesOnly>` コンポーネントを使用できます。共有コンテンツはコンポーネントでラップしないでください。 */}

Next.jsはデフォルトで`next start`とともに独自のサーバーを含んでいます。既存のバックエンドがある場合でも、Next.jsと一緒に使用できます（これはカスタムサーバーではありません）。カスタムNext.jsサーバーは、カスタムパターンのためにサーバーをプログラム的に開始する方法を提供します。ほとんどの場合、このアプローチは必要ありませんが、ejectが必要な場合に使用できます。

> **Good to know**:
>
> - カスタムサーバーを使用する前に、Next.jsの統合されたrouterがアプリの要件を満たせないときのみ使用するべきであることを覚えておいてください。カスタムサーバーを使用すると、**[Automatic Static Optimization](https://nextjs.org/docs/canary/pages/building-your-application/rendering/automatic-static-optimization)** などの重要なパフォーマンス最適化が失われます；
> - カスタムサーバーは、[Vercel](https://vercel.com/frameworks/nextjs) にデプロイ**できません**；
> - スタンドアロン出力モードを使用すると、カスタムサーバーファイルはトレースされません。このモードでは、代わりに別個の最小限の`server.js`ファイルを出力します。これらは一緒に使用できません；

カスタムサーバーの[次の例](https://github.com/vercel/next.js/tree/canary/examples/custom-server)をご覧ください：

<Tabs>
<TabItem value="ts" label="TypeScript">

```ts title="server.ts" switcher
import { createServer } from 'http'
import { parse } from 'url'
import next from 'next'

const port = parseInt(process.env.PORT || '3000', 10)
const dev = process.env.NODE_ENV !== 'production'
const app = next({ dev })
const handle = app.getRequestHandler()

app.prepare().then(() => {
  createServer((req, res) => {
    const parsedUrl = parse(req.url!, true)
    handle(req, res, parsedUrl)
  }).listen(port)

  console.log(
    `> Server listening at http://localhost:${port} as ${
      dev ? 'development' : process.env.NODE_ENV
    }`
  )
})
```

</TabItem>
<TabItem value="js" label="JavaScript">

```js title="server.js" switcher
import { createServer } from 'http'
import { parse } from 'url'
import next from 'next'

const port = parseInt(process.env.PORT || '3000', 10)
const dev = process.env.NODE_ENV !== 'production'
const app = next({ dev })
const handle = app.getRequestHandler()

app.prepare().then(() => {
  createServer((req, res) => {
    const parsedUrl = parse(req.url, true)
    handle(req, res, parsedUrl)
  }).listen(port)

  console.log(
    `> Server listening at http://localhost:${port} as ${
      dev ? 'development' : process.env.NODE_ENV
    }`
  )
})
```

</TabItem>
</Tabs>

> `server.js` は、Next.jsコンパイラまたはバンドルプロセスを通過しません。現在使用しているNode.jsのバージョンに対応していることを、必要な構文およびこのファイルが必要とするソースコードが確認してください。[例を見る](https://github.com/vercel/next.js/tree/canary/examples/custom-server)；

カスタムサーバーを実行するには、次のように`package.json`の`scripts`を更新する必要があります：

```json title="package.json"
{
  "scripts": {
    "dev": "node server.js",
    "build": "next build",
    "start": "NODE_ENV=production node server.js"
  }
}
```

あるいは、`nodemon`を設定することもできます（[例](https://github.com/vercel/next.js/tree/canary/examples/custom-server)）。カスタムサーバーは、次のインポートを使用してサーバーをNext.jsアプリケーションと接続します：

```js
import next from 'next'

const app = next({})
```

上記の`next`インポートは、次のオプションを含むオブジェクトを受け取る関数です：

| オプション   | 型                 | 説明                                                                              |
| ------------ | ------------------ | --------------------------------------------------------------------------------- |
| `conf`       | `Object`           | `next.config.js`で使用するのと同じオブジェクトです；デフォルトは`{}`です          |
| `dev`        | `Boolean`          | （_オプション_） Next.jsを開発モードで起動するかどうか； デフォルトは `false`     |
| `dir`        | `String`           | （_オプション_） Next.jsプロジェクトの場所；デフォルトは`'.'`                     |
| `quiet`      | `Boolean`          | （_オプション_） サーバー情報を含むエラーメッセージを非表示；デフォルトは `false` |
| `hostname`   | `String`           | （_オプション_） サーバーが動作しているホスト名                                   |
| `port`       | `Number`           | （_オプション_） サーバーが動作しているポート                                     |
| `httpServer` | `node:http#Server` | （_オプション_） Next.jsがバックで動作しているHTTPサーバー                        |
| `turbo`      | `Boolean`          | （_オプション_） Turbopackを有効にする                                            |

返される`app`は、要求を必要に応じてNext.jsに処理させるために使用できます；

<PagesOnly>

## ファイルシステムルーティングの無効化 {#disabling-file-system-routing}

デフォルトでは、`Next` は `pages` フォルダー内の各ファイルを、そのファイル名と一致するパス名で提供します。あなたのプロジェクトがカスタムサーバーを使用している場合、この動作は複数のパスから同じコンテンツを提供する結果となり、SEOやUXの問題を引き起こす可能性があります。

この動作を無効にし、`pages`内のファイルに基づくルーティングを防ぐには、`next.config.js`を開き、`useFileSystemPublicRoutes`設定を無効にしてください：

```js title="next.config.js"
module.exports = {
  useFileSystemPublicRoutes: false,
}
```

> `useFileSystemPublicRoutes`はSSRからファイル名ルートを無効にすることに注意してください；クライアントサイドルーティングはそれらのパスにアクセス可能な場合があります。このオプションを使用する際は、プログラムで望まないルートへのナビゲーションを防ぐべきです；

> クライアントサイドrouterを設定して、クライアントサイドのリダイレクトをファイル名ルートに禁止したい場合もあるかもしれません；そのためには[`router.beforePopState`](https://nextjs.org/docs/canary/pages/api-reference/functions/use-router#routerbeforepopstate) を参照してください。

</PagesOnly>
