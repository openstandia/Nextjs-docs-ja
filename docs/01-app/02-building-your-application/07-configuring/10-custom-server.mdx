---
title: 'カスタムサーバー'
description: 'カスタムサーバーを使用して、プログラムでNext.jsアプリケーションを開始します。'
---

{/* このドキュメントの内容はapp routerとpages routerで共有されています。Pages Routerに特化したコンテンツを追加するには`<PagesOnly>Content</PagesOnly>`コンポーネントを使用できます。共有される内容はコンポーネントでラップしないでください。 */}

Next.jsはデフォルトで`next start`を使用して独自のサーバーを含んでいます。既存のバックエンドがある場合でも、Next.jsと一緒に使用することができます（これはカスタムサーバーではありません）。カスタムNext.jsサーバーは、カスタムパターンに基づいてプログラムでサーバーを開始することを可能にします。ほとんどの場合、このアプローチを使用する必要はありません。ただし、必要があれば使用できるようになっています。

> **Good to know**:
>
> - カスタムサーバーを使用する前に、Next.jsの統合されたルーターがアプリの要件を満たせない場合にのみ使用するべきことを覚えておいてください。カスタムサーバーは、**[Automatic Static Optimization](https://nextjs.org/docs/canary/pages/building-your-application/rendering/automatic-static-optimization)**のような重要なパフォーマンス最適化を削除します。
> - カスタムサーバーは、[Vercel](https://vercel.com/frameworks/nextjs)にデプロイすることはできません。
> - スタンドアロン出力モードを使用する場合、カスタムサーバーファイルをトレースしません。このモードでは、最小限の`server.js`ファイルを別々に出力するだけです。これらは一緒に使用することはできません。

カスタムサーバーの[以下の例](https://github.com/vercel/next.js/tree/canary/examples/custom-server)をご覧ください：

<Tabs>
<TabItem value="ts" label="TypeScript">

```ts title="server.ts" switcher
import { createServer } from 'http'
import { parse } from 'url'
import next from 'next'

// コメント: 環境変数からポートを取得します。デフォルトは3000です。
const port = parseInt(process.env.PORT || '3000', 10)
// コメント: 環境変数によって開発モードかどうかを判断します。
const dev = process.env.NODE_ENV !== 'production'
// コメント: Next.jsアプリケーションを作成します。
const app = next({ dev })
// コメント:アプリのリクエストハンドラを取得します。
const handle = app.getRequestHandler()

app.prepare().then(() => {
  // コメント: HTTPサーバーを作成します。
  createServer((req, res) => {
    // コメント: リクエストURLを解析します。
    const parsedUrl = parse(req.url!, true)
    handle(req, res, parsedUrl)
  }).listen(port)

  console.log(
    `> Server listening at http://localhost:${port} as ${
      dev ? 'development' : process.env.NODE_ENV
    }`
  )
})
```

</TabItem>
<TabItem value="js" label="JavaScript">

```js title="server.js" switcher
import { createServer } from 'http'
import { parse } from 'url'
import next from 'next'

// コメント: 環境変数からポートを取得します。デフォルトは3000です。
const port = parseInt(process.env.PORT || '3000', 10)
// コメント: 環境変数によって開発モードかどうかを判断します。
const dev = process.env.NODE_ENV !== 'production'
// コメント: Next.jsアプリケーションを作成します。
const app = next({ dev })
// コメント:アプリのリクエストハンドラを取得します。
const handle = app.getRequestHandler()

app.prepare().then(() => {
  // コメント: HTTPサーバーを作成します。
  createServer((req, res) => {
    // コメント: リクエストURLを解析します。
    const parsedUrl = parse(req.url, true)
    handle(req, res, parsedUrl)
  }).listen(port)

  console.log(
    `> Server listening at http://localhost:${port} as ${
      dev ? 'development' : process.env.NODE_ENV
    }`
  )
})
```

</TabItem>
</Tabs>

> `server.js`はNext.jsのコンパイラまたはバンドルプロセスを通過しません。このファイルが必要とする構文やソースコードが、使用中のNode.jsの現在のバージョンに互換性があることを確認してください。[例を見る](https://github.com/vercel/next.js/tree/canary/examples/custom-server)。

カスタムサーバーを実行するには、`package.json`内の`scripts`を次のように更新する必要があります：

```json title="package.json"
{
  "scripts": {
    "dev": "node server.js",
    "build": "next build",
    "start": "NODE_ENV=production node server.js"
  }
}
```

あるいは、`nodemon`をセットアップすることもできます（[例](https://github.com/vercel/next.js/tree/canary/examples/custom-server)）。カスタムサーバーは次のインポートを使用して、サーバーをNext.jsアプリケーションに接続します：

```js
import next from 'next'

const app = next({})
```

上記の`next`インポートは、以下のオプションを受け取るオブジェクトの引数を持つ関数です：

| Option       | Type               | Description                                                                              |
| ------------ | ------------------ | ---------------------------------------------------------------------------------------- |
| `conf`       | `Object`           | `next.config.js`で使用するオブジェクトと同じです。デフォルト値は`{}`                     |
| `dev`        | `Boolean`          | (_オプション_) Next.jsを開発モードで起動するかどうか。デフォルト値は`false`              |
| `dir`        | `String`           | (_オプション_) Next.jsプロジェクトの場所。デフォルト値は`'.'`                            |
| `quiet`      | `Boolean`          | (_オプション_) サーバー情報を含むエラーメッセージを非表示にします。デフォルト値は`false` |
| `hostname`   | `String`           | (_オプション_) サーバーが稼働しているホスト名                                            |
| `port`       | `Number`           | (_オプション_) サーバーが稼働しているポート番号                                          |
| `httpServer` | `node:http#Server` | (_オプション_) Next.jsが稼働しているHTTPサーバー                                         |
| `turbo`      | `Boolean`          | (_オプション_) Turbopackを有効にします。                                                 |

返された`app`を使用して、Next.jsがリクエストを必要に応じて処理できるようになります。

<PagesOnly>

## ファイルシステムルーティングの無効化 {#disabling-file-system-routing}

デフォルトで `Next` は、`pages`フォルダ内の各ファイルをファイル名と一致するパス名で提供します。プロジェクトがカスタムサーバーを使用している場合、この動作により複数のパスから同じ内容が提供される可能性があり、SEOやUXに問題を引き起こすことがあります。

この動作を無効にし、`pages`内のファイルに基づくルーティングを防ぐには、`next.config.js`を開き、`useFileSystemPublicRoutes`の設定を無効にしてください：

```js title="next.config.js"
module.exports = {
  useFileSystemPublicRoutes: false,
}
```

> `useFileSystemPublicRoutes`は、SSRからファイル名のルートを無効にしますが、クライアントサイドのルーティングがこれらのパスにアクセスする可能性があります。このオプションを使用する場合は、プログラムでナビゲートしてほしくないルートへのアクセスに対する保護を実装するべきです。

> クライアントサイドルーターを設定して、ファイル名ルートへのクライアントサイドリダイレクトを許可しないようにすることをお勧めします。その場合は[`router.beforePopState`](https://nextjs.org/docs/canary/pages/api-reference/functions/use-router#routerbeforepopstate)を参照してください。

</PagesOnly>
