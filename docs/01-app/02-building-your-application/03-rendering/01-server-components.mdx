---
title: 'Server Components'
description: 'アプリケーションの一部をサーバー上でレンダリングするために、React Server Componentsを活用する方法を学びます。'
related:
  description: 'Next.jsがデータと静的レンダリングの結果をどのようにキャッシュするかを学びます。'
  links:
    - app/building-your-application/caching
---

React Server Componentsを使用すると、サーバー上でレンダリングおよびオプションでキャッシュ可能なUIを書くことができます。Next.jsでは、ストリーミングや部分レンダリングを可能にするために、レンダリング作業がルートセグメントごとにさらに分割され、3つの異なるサーバーレンダリング戦略があります：

- [スタティックレンダリング](#static-rendering-default)
- [ダイナミックレンダリング](#dynamic-rendering)
- [ストリーミング](#streaming)

このページでは、Server Componentsがどのように機能するのか、どのような場合に使用するのか、そしてさまざまなサーバーレンダリング戦略について説明します。

## サーバーレンダリングのメリット {#benefits-of-server-rendering}

サーバーでレンダリング作業を行うと、いくつかの利点があります：

- **データフェッチング**：Server Componentsを使用すると、データフェッチングをサーバーに移動し、データソースに近づけることができます。これにより、レンダリングに必要なデータの取得時間が短縮されたり、クライアントが行うリクエスト数が減少したりして、パフォーマンスが向上します。
- **セキュリティ**：Server Componentsにより、クライアントにさらすリスクなしに、トークンやAPIキーなどの機密データやロジックをサーバー上に保持することができます。
- **キャッシング**：サーバーでレンダリングすることで、結果をキャッシュし、その後のリクエストやユーザー間で再利用できます。これにより、各リクエストで行われるレンダリングやデータフェッチングの量を減らし、パフォーマンスを向上させ、コストを削減できます。
- **パフォーマンス**：Server Componentsは、基本的なパフォーマンスを最適化するための追加のツールを提供します。例えば、完全にClient Componentsで構成されたアプリから始めて、UIの非対話的な部分をServer Componentsに移行することで、必要なクライアントサイドのJavaScriptの量を減らせます。これは、インターネット速度が遅いユーザーやデバイスの性能が低いユーザーにとって有益であり、ブラウザがダウンロード、解析、実行するクライアントサイドのJavaScriptが少なくて済みます。
- **初期ページ読み込みと[First Contentful Paint (FCP)](https://web.dev/fcp/)**：サーバーでHTMLを生成し、クライアントがページをレンダリングするために必要なJavaScriptをダウンロード、解析、実行するのを待つことなく、ユーザーにページを即座に表示させることができます。
- **検索エンジン最適化とソーシャルネットワークシェア**：レンダリングされたHTMLは、検索エンジンのボットがページをインデックス化するためや、ソーシャルネットワークのボットがページのソーシャルカードプレビューを生成するために使用できます。
- **ストリーミング**：Server Componentsにより、レンダリング作業をチャンクに分割し、準備ができ次第それをクライアントにストリームすることができます。これにより、ユーザーはページの一部を早く見ることができ、サーバーでページ全体がレンダリングされるのを待たずに済みます。

## Next.jsでのServer Componentsの使用 {#using-server-components-in-next-js}

デフォルトで、Next.jsはServer Componentsを使用します。これにより、追加の設定なしでサーバーレンダリングを自動的に実装できます。また、必要に応じてClient Componentsの使用を選択できます。[Client Components](/docs/app/building-your-application/rendering/client-components)を参照してください。

## Server Componentsはどのようにレンダリングされるのか？ {#how-are-server-components-rendered}

サーバーでは、Next.jsはReactのAPIを使用してレンダリングを調整します。レンダリング作業は、個々のルートセグメントや[Suspense Boundaries](https://react.dev/reference/react/Suspense)によってチャンクに分割されます。

各チャンクは、次の2ステップでレンダリングされます：

1. ReactがServer Componentsを特殊なデータ形式である**React Server Component Payload (RSC Payload)**にレンダリングします。
2. Next.jsがRSC PayloadとClient Component JavaScriptの指示を使用してサーバー上で**HTML**をレンダリングします。

{/* レンダリング図 */}

その後、クライアント上で：

1. HTMLは、ルートの高速な非対話的プレビューを即座に表示するために使用されます。この処理は初期ページ読み込み時にのみ行われます。
2. React Server Components Payloadが使用され、ClientとServer Componentのツリーを調整し、DOMを更新します。
3. JavaScriptの指示が使用され、Client Componentsを[ハイドレート](https://react.dev/reference/react-dom/client/hydrateRoot)し、アプリケーションを対話的にします。

> #### React Server Component Payload (RSC)とは？
>
> RSC Payloadは、レンダリングされたReact Server Componentsのツリーをコンパクトなバイナリ形式で表現したものです。これは、クライアント上でReactによってブラウザのDOMを更新するために使用されます。RSC Payloadには以下が含まれます：
>
> - Server Componentsのレンダリング結果
> - Client Componentsがレンダリングされる場所のプレースホルダーおよびJavaScriptファイルへの参照
> - Server ComponentからClient Componentに渡された任意のprops

## サーバーレンダリング戦略 {#server-rendering-strategies}

サーバーレンダリングには、スタティック、ダイナミック、ストリーミングの3つのサブセットがあります。

### スタティックレンダリング（デフォルト） {#static-rendering-default}

スタティックレンダリングでは、ルートは**ビルド時**または[データのリバリデーション](/docs/app/building-your-application/data-fetching/incremental-static-regeneration)後のバックグラウンドでレンダリングされます。結果はキャッシュされ、[Content Delivery Network (CDN)](https://developer.mozilla.org/docs/Glossary/CDN)にプッシュされることができます。この最適化により、レンダリング作業の結果をユーザーやサーバーのリクエスト間で共有することができます。

スタティックレンダリングは、ルートにユーザーにパーソナライズされていないデータがあり、ビルド時に既知であることが分かる場合に有用です。例えば、静的なブログ投稿や製品ページなどです。

### ダイナミックレンダリング {#dynamic-rendering}

ダイナミックレンダリングでは、ルートは**リクエスト時**にユーザーごとにレンダリングされます。

ダイナミックレンダリングは、ルートにユーザーにパーソナライズされたデータが含まれているか、リクエスト時にのみ判明する情報（cookieやURLの検索パラメーターなど）が含まれる場合に有用です。

> **キャッシュされたデータを持つ動的ルート**
>
> ほとんどのウェブサイトでは、ルートは完全に静的でも完全に動的でもなく、スペクトル上に存在します。例えば、一定の間隔でリバリデーションされるキャッシュされた商品のデータを使用するeコマースページがありながら、キャッシュされていないパーソナライズされた顧客データを持つことができます。
>
> Next.jsでは、キャッシュされたデータとキャッシュされていないデータの両方を持つ動的にレンダリングされたルートを持つことができます。これは、RSC Payloadとデータが別々にキャッシュされるためです。これにより、すべてのデータをリクエスト時にフェッチする際のパフォーマンスへの影響を心配せずに動的レンダリングを選択できます。
>
> [完全ルートキャッシュ](/docs/app/building-your-application/caching#full-route-cache)や[データキャッシュ](/docs/app/building-your-application/caching#data-cache)について詳しく学びましょう。

#### ダイナミックレンダリングへの切り替え {#switching-to-dynamic-rendering}

レンダリング中に、[Dynamic API](#dynamic-apis)または`{ cache: 'no-store' }`オプションを使用した[fetch](/docs/app/api-reference/functions/fetch)が発見されると、Next.jsはルート全体のダイナミックレンダリングに切り替えます。このテーブルは、Dynamic APIとデータキャッシングがルートがスタティックにレンダリングされるかダイナミックにレンダリングされるかにどのように影響するかを要約しています：

| Dynamic APIs | Data       | Route                |
| ------------ | ---------- | -------------------- |
| No           | Cached     | Statically Rendered  |
| Yes          | Cached     | Dynamically Rendered |
| No           | Not Cached | Dynamically Rendered |
| Yes          | Not Cached | Dynamically Rendered |

上記の表では、ルートが完全にスタティックであるためには、すべてのデータがキャッシュされている必要があります。ただし、キャッシュされたデータ取得とキャッシュされていないデータ取得の両方を使用する動的にレンダリングされたルートを持つことができます。

開発者としては、Next.jsが使用する機能やAPIに基づいて各ルートに最適なレンダリング戦略を自動的に選択するため、スタティックレンダリングとダイナミックレンダリングのどちらを選択する必要はありません。代わりに、データを[キャッシュする](/docs/app/building-your-application/data-fetching/fetching)か[特定のデータをリバリデーションする](/docs/app/building-your-application/data-fetching/incremental-static-regeneration)タイミングを選ぶことができ、UIの一部を[ストリーミング](/docs/app/building-your-application/routing/loading-ui-and-streaming)するかを選択できます。

### Dynamic APIs {#dynamic-apis}

Dynamic APIsは、リクエスト時にしか判明しない情報（事前のプリレンダリング中にわかっているわけではない情報）に依存します。これらのAPIを使用することにより、開発者の意図が示され、リクエスト時にルート全体がダイナミックレンダリングに切り替わります。これらのAPIには以下が含まれます：

- [`cookies`](/docs/app/api-reference/functions/cookies)
- [`headers`](/docs/app/api-reference/functions/headers)
- [`connection`](/docs/app/api-reference/functions/connection)
- [`draftMode`](/docs/app/api-reference/functions/draft-mode)
- [`searchParams` prop](/docs/app/api-reference/file-conventions/page#searchparams-optional)
- [`unstable_noStore`](/docs/app/api-reference/functions/unstable_noStore)

### ストリーミング {#streaming}

<Image
  alt="ストリーミング中のルートセグメントの並列化を示す図で、データ取得、レンダリング、および個々のチャンクのハイドレーションを示します。"
  srcLight="/docs/light/sequential-parallel-data-fetching.png"
  srcDark="/docs/dark/sequential-parallel-data-fetching.png"
  width="1600"
  height="525"
/>

ストリーミングを使用すると、サーバーから徐々にUIをレンダリングできます。作業がチャンクに分割され、準備ができ次第クライアントにストリームされます。これにより、すべてのコンテンツがレンダリングされ終わる前に、ユーザーがページの一部を即座に見ることができます。

<Image
  alt="クライアント上の部分的にレンダリングされたページを示す図で、ストリーミングされているチャンクの読み込みUIが表示されています。"
  srcLight="/docs/light/server-rendering-with-streaming.png"
  srcDark="/docs/dark/server-rendering-with-streaming.png"
  width="1600"
  height="785"
/>

ストリーミングは、Next.js App Routerにデフォルトで組み込まれています。これにより、初期ページの読み込みパフォーマンスを向上させるとともに、ルート全体のレンダリングを妨げる遅いデータ取得に依存するUIのパフォーマンスを向上させます。例えば、製品ページのレビューなどです。

`loading.js`とUIコンポーネントを使用してルートセグメントのストリーミングを開始できます。[React Suspense](/docs/app/building-your-application/routing/loading-ui-and-streaming)を参照してください。[Loading UI and Streaming](/docs/app/building-your-application/routing/loading-ui-and-streaming)セクションで詳しく学びましょう。
