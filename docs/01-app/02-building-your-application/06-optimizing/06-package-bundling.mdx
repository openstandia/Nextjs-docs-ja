---
title: 'パッケージバンドルの最適化'
nav_title: 'パッケージバンドル'
description: 'アプリケーションのサーバーおよびクライアントバンドルの最適化方法を学びましょう。'
related:
  description: '本番環境向けにアプリケーションを最適化する方法を学びましょう。'
  links:
    - app/building-your-application/deploying/production-checklist
---

外部パッケージをバンドルすることにより、アプリケーションのパフォーマンスを大幅に向上させることができます。<AppOnly>デフォルトでは、Server ComponentsやRoute Handlers内でインポートされたパッケージはNext.jsによって自動的にバンドルされます。このページでは、パッケージのバンドルを分析し、さらに最適化する方法を案内します。</AppOnly> <PagesOnly>デフォルトでは、アプリケーションにインポートされたパッケージはバンドルされません。これは、外部パッケージが事前にバンドルされていない場合、例えばモノレポや`node_modules`からインポートされる場合、パフォーマンスに影響を与えたり、動作しない可能性があります。このページでは、パッケージバンドルの分析と設定方法を案内します。</PagesOnly>

## JavaScript バンドルの分析 {#analyzing-javascript-bundles}

[`@next/bundle-analyzer`](https://www.npmjs.com/package/@next/bundle-analyzer)は、アプリケーションバンドルのサイズを管理する際に役立つNext.js用のプラグインです。 各パッケージとその依存関係のサイズの視覚的なレポートを生成します。この情報を使用して、大きな依存関係を削除したり、コードを分割したり、[遅延読み込み](/docs/app/building-your-application/optimizing/lazy-loading)することができます。

### インストール {#installation}

以下のコマンドを実行して、このプラグインをインストールしてください。

```bash
npm i @next/bundle-analyzer
# or {#or}
yarn add @next/bundle-analyzer
# or {#or}
pnpm add @next/bundle-analyzer
```

次に、`next.config.js` にバンドルアナライザーの設定を追加します。

```js title="next.config.js"
/** @type {import('next').NextConfig} */
const nextConfig = {}

const withBundleAnalyzer = require('@next/bundle-analyzer')({
  enabled: process.env.ANALYZE === 'true',
})

module.exports = withBundleAnalyzer(nextConfig)
```

### レポートの生成 {#generating-a-report}

バンドルを分析するには、次のコマンドを実行します。

```bash
ANALYZE=true npm run build
# or {#or}
ANALYZE=true yarn build
# or {#or}
ANALYZE=true pnpm build
```

このレポートは、新しいタブを3つ開き、ブラウザで内容を確認できます。アプリケーションのバンドルを定期的に評価することで、時間の経過とともにアプリケーションのパフォーマンスを維持するのに役立ちます。

## パッケージのインポートの最適化 {#optimizing-package-imports}

アイコンライブラリなどの一部のパッケージは、数百のモジュールをエクスポートでき、開発および本番環境でのパフォーマンス問題を引き起こす可能性があります。

これらのパッケージのインポート方法を最適化するには、`next.config.js` に [`optimizePackageImports`](/docs/app/api-reference/config/next-config-js/optimizePackageImports) オプションを追加します。このオプションは、実際に使用するモジュールのみをロードしつつ、多くの名前付きエクスポートでインポート文を書く利便性を提供します。

```js title="next.config.js"
/** @type {import('next').NextConfig} */
const nextConfig = {
  experimental: {
    optimizePackageImports: ['icon-library'],
  },
}

module.exports = nextConfig
```

Next.js はいくつかのライブラリを自動的に最適化しているため、それらを optimizePackageImports のリストに含める必要はありません。 [完全なリスト](https://nextjs.org/docs/app/api-reference/config/next-config-js/optimizePackageImports) を参照してください。

<PagesOnly>

## 特定のパッケージのバンドル {#bundling-specific-packages}

特定のパッケージをバンドルするには、`next.config.js` で[`transpilePackages`](/docs/app/api-reference/config/next-config-js/transpilePackages) オプションを使用します。このオプションは、モノレポや`node_modules`からインポートされた外部パッケージをバンドルするのに便利です。

```js title="next.config.js"
/** @type {import('next').NextConfig} */
const nextConfig = {
  transpilePackages: ['package-name'],
}

module.exports = nextConfig
```

## すべてのパッケージのバンドル {#bundling-all-packages}

すべてのパッケージを自動的にバンドルするには（App Routerのデフォルトの挙動）、`next.config.js` に[`bundlePagesRouterDependencies`](https://nextjs.org/docs/canary/pages/api-reference/config/next-config-js/bundlePagesRouterDependencies) オプションを使用します。

```js title="next.config.js"
/** @type {import('next').NextConfig} */
const nextConfig = {
  bundlePagesRouterDependencies: true,
}

module.exports = nextConfig
```

## 特定のパッケージをバンドルから除外 {#opting-specific-packages-out-of-bundling}

[`bundlePagesRouterDependencies`](https://nextjs.org/docs/canary/pages/api-reference/config/next-config-js/bundlePagesRouterDependencies) オプションを有効にした場合、`next.config.js` の[`serverExternalPackages`](https://nextjs.org/docs/canary/pages/api-reference/config/next-config-js/serverExternalPackages) オプションを使用して、特定のパッケージを自動的なバンドル対象から除外できます。

```js title="next.config.js"
/** @type {import('next').NextConfig} */
const nextConfig = {
  // Pages Router で外部パッケージを自動的にバンドルする：
  bundlePagesRouterDependencies: true,
  // App と Pages Router の両方で、特定のパッケージをバンドルから除外する：
  serverExternalPackages: ['package-name'],
}

module.exports = nextConfig
```

</PagesOnly>

<AppOnly>

## 特定のパッケージをバンドルから除外 {#opting-specific-packages-out-of-bundling}

Server ComponentsやRoute Handlers内でインポートされたパッケージは、Next.jsによって自動的にバンドルされるため、`next.config.js` の[`serverExternalPackages`](/docs/app/api-reference/config/next-config-js/serverExternalPackages)オプションを使用して、特定のパッケージをバンドルから除外できます。

```js title="next.config.js"
/** @type {import('next').NextConfig} */
const nextConfig = {
  serverExternalPackages: ['package-name'],
}

module.exports = nextConfig
```

Next.js には現在、互換性の作業が進行中で、自動的に除外されている人気のあるパッケージのリストが含まれています。 [完全なリスト](/docs/app/api-reference/config/next-config-js/serverExternalPackages) を参照してください。

</AppOnly>
