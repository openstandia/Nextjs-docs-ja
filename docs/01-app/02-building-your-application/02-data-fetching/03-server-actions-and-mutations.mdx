---
title: 'Server Actionsとデータ変更'
nav_title: 'Server Actionsとデータ変更'
description: 'Next.jsを用いたフォーム送信とデータ変更の処理方法を学びましょう。'
related:
  description: 'Next.jsでのServer Actionsの設定方法を学びましょう。'
  links:
    - app/api-reference/config/next-config-js/serverActions
---

[Server Actions](https://react.dev/reference/rsc/server-actions)は、サーバー上で実行される**非同期関数**です。Next.jsアプリケーションでフォーム送信やデータ変更を処理するために、Server ComponentやClient Componentから呼び出すことができます。

> **🎥 視聴:** Server Actionsによる変更について詳しく学ぶ → [YouTube (10分)](https://youtu.be/dDpZfOQBMaU?si=cJZHlUu_jFhCzHUg).

## 規約 {#convention}

Server Actionは、Reactの[`"use server"`](https://react.dev/reference/react/use-server)ディレクティブで定義できます。このディレクティブを`async`関数の先頭に置いてその関数をServer Actionとしてマークすることができます。また、ファイルの先頭にこれを置くことで、そのファイルのすべてのエクスポートをServer Actionとしてマークすることが可能です。

### Server Components {#server-components}

Server Componentsは、関数レベルまたはモジュールレベルでのインラインの`"use server"`ディレクティブを使用できます。Server Actionをインラインで使用するには、関数本体の先頭に`"use server"`を追加します：

<Tabs>
<TabItem value="tsx" label="TypeScript">

```tsx title="app/page.tsx" switcher
export default function Page() {
  // Server Action
  async function create() {
    'use server'
    // データを変更
  }

  return '...'
}
```

</TabItem>
<TabItem value="jsx" label="JavaScript">

```jsx title="app/page.js" switcher
export default function Page() {
  // Server Action
  async function create() {
    'use server'
    // データを変更
  }

  return '...'
}
```

</TabItem>
</Tabs>

### Client Components {#client-components}

Client ComponentでServer Actionを呼び出すためには、新しいファイルを作成し、その先頭に`"use server"`ディレクティブを追加します。そのファイル内のすべてのエクスポートされた関数は、Client ComponentおよびServer Componentで再利用できるServer Actionsとしてマークされます：

<Tabs>
<TabItem value="tsx" label="TypeScript">

```tsx title="app/actions.ts" switcher
'use server'

export async function create() {}
```

</TabItem>
<TabItem value="js" label="JavaScript">

```js title="app/actions.js" switcher
'use server'

export async function create() {}
```

</TabItem>
</Tabs>

<Tabs>
<TabItem value="tsx" label="TypeScript">

```tsx title="app/ui/button.tsx" switcher
'use client'

import { create } from '@/app/actions'

export function Button() {
  return <button onClick={() => create()}>Create</button>
}
```

</TabItem>
<TabItem value="jsx" label="JavaScript">

```jsx title="app/ui/button.js" switcher
'use client'

import { create } from '@/app/actions'

export function Button() {
  return <button onClick={() => create()}>Create</button>
}
```

</TabItem>
</Tabs>

### Actionsをpropsとして渡す {#passing-actions-as-props}

Server ActionをClient Componentにpropsとして渡すこともできます：

```jsx
<ClientComponent updateItemAction={updateItem} />
```

<Tabs>
<TabItem value="tsx" label="TypeScript">

```tsx title="app/client-component.tsx" switcher
'use client'

export default function ClientComponent({
  updateItemAction,
}: {
  updateItemAction: (formData: FormData) => void
}) {
  return <form action={updateItemAction}>{/* ... */}</form>
}
```

</TabItem>
<TabItem value="jsx" label="JavaScript">

```jsx title="app/client-component.js" switcher
'use client'

export default function ClientComponent({ updateItemAction }) {
  return <form action={updateItemAction}>{/* ... */}</form>
}
```

</TabItem>
</Tabs>

通常、Next.jsのTypeScriptプラグインは、`client-component.tsx`内の`updateItemAction`を、クライアント-サーバー境界を超えてシリアライズできない関数としてフラグ示します。ただし、`action` と名付けられたprops、または`Action`で終わるpropsは、Server Actionsを受け取ると想定されます。これは単なるヒューリスティックなもので、TypeScriptプラグインがServer Actionを受け取っているか、普通の関数かを実際には知ることができません。ランタイム時の型チェックにより、誤って関数をClient Componentに渡さないように確認されます。

## 振る舞い {#behavior}

- **Server Actionsは`action`属性を使って[`<form>`要素](#forms)で呼び出すことができます：**
  - Server Componentsはデフォルトでプログレッシブエンハンスメントをサポートしており、JavaScriptがまだ読み込まれていない場合や無効になっている場合でもフォームが送信されます。
  - Client Componentsでは、Server Actionsを呼び出すフォームはJavaScriptがまだ読み込まれていない場合、クライアントのハイドレーションを優先し、送信をキューに入れます。
  - ハイドレーション後、ブラウザはフォーム送信時にリフレッシュしません。
- Server Actionsは`<form>`に限定されず、イベントハンドラ、`useEffect`、サードパーティライブラリ、`<button>`などの他のフォーム要素から呼び出すことができます。
- Server ActionsはNext.jsの[キャッシングおよび再検証](/docs/app/building-your-application/caching)アーキテクチャと統合されています。アクションが呼び出されると、Next.jsは更新されたUIと新しいデータを単一のサーバーラウンドトリップで返すことができます。
- 背後では、アクションは`POST`メソッドを使用し、このHTTPメソッドのみでアクションを呼び出すことができます。
- Server Actionsの引数と戻り値はReactによってシリアライズ可能でなければなりません。詳細についてはReactドキュメントの[シリアライズ可能な引数と値](https://react.dev/reference/react/use-server#serializable-parameters-and-return-values)を参照してください。
- Server Actionsは関数です。つまり、アプリケーションのどこでも再利用できます。
- Server Actionsは使用されるページやレイアウトの[runtime](/docs/app/building-your-application/rendering/edge-and-nodejs-runtimes)を継承します。
- Server Actionsは使用されるページやレイアウトの[Route Segment Config](/docs/app/api-reference/file-conventions/route-segment-config)を継承し、`maxDuration`のようなフィールドを含みます。

## 例 {#examples}

### フォーム {#forms}

ReactはHTMLの[`<form>`](https://developer.mozilla.org/docs/Web/HTML/Element/form)要素を拡張し、`action` propを使用してServer Actionsを呼び出すことができます。

フォームで呼び出されると、アクションは自動的に[`FormData`](https://developer.mozilla.org/docs/Web/API/FormData/FormData)オブジェクトを受け取ります。フィールドを管理するためにReactの`useState`を使用する必要はなく、代わりにネイティブの[`FormData`メソッド](https://developer.mozilla.org/en-US/docs/Web/API/FormData#instance_methods)を使ってデータを抽出できます：

<Tabs>
<TabItem value="tsx" label="TypeScript">

```tsx title="app/invoices/page.tsx" switcher
export default function Page() {
  async function createInvoice(formData: FormData) {
    'use server'

    const rawFormData = {
      customerId: formData.get('customerId'),
      amount: formData.get('amount'),
      status: formData.get('status'),
    }

    // データを変更
    // キャッシュを再検証
  }

  return <form action={createInvoice}>...</form>
}
```

</TabItem>
<TabItem value="jsx" label="JavaScript">

```jsx title="app/invoices/page.js" switcher
export default function Page() {
  async function createInvoice(formData) {
    'use server'

    const rawFormData = {
      customerId: formData.get('customerId'),
      amount: formData.get('amount'),
      status: formData.get('status'),
    }

    // データを変更
    // キャッシュを再検証
  }

  return <form action={createInvoice}>...</form>
}
```

</TabItem>
</Tabs>

> **Good to know:**
>
> - 例: [Loadingとエラーステートを持つフォーム](https://github.com/vercel/next.js/tree/canary/examples/next-forms)
> - 多数のフィールドを持つフォームで作業する際は、JavaScriptの[`Object.fromEntries()`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/fromEntries)と共に[`entries()`](https://developer.mozilla.org/en-US/docs/Web/API/FormData/entries)メソッドを使うことを検討してください。例えば: `const rawFormData = Object.fromEntries(formData)` します。ただし、`formData`には追加の`$ACTION_`プロパティが含まれることに注意してください。
> - 詳しくは、[Reactの`<form>` ドキュメント](https://react.dev/reference/react-dom/components/form#handle-form-submission-with-a-server-action)を参照してください。

続くコードブロックも同様に翻訳を続けることができますが、ここでの例は共通のNext.jsコンテキストにおけるServer Actionsの利用法に焦点を当てています。これらを意識しつつ要点を捉えてご利用ください。
