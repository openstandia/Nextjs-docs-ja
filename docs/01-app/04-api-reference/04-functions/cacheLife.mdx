---
title: 'cacheLife'
description: 'キャッシュされた関数やコンポーネントのキャッシュ有効期限を設定する cacheLife 関数の使用法について学びます。'
version: 'canary'
related:
  title: '関連情報'
  description: '関連する API リファレンスを表示します。'
  links:
    - 'app/api-reference/config/next-config-js/dynamicIO'
    - 'app/api-reference/directives/use-cache'
    - 'app/api-reference/functions/revalidateTag'
    - 'app/api-reference/functions/cacheTag'
---

`cacheLife` 関数は、関数やコンポーネントのキャッシュ有効期間を設定するために使用されます。この関数は、[`use cache`](/docs/app/api-reference/directives/use-cache) ディレクティブと共に使用し、関数やコンポーネントのスコープ内で使用する必要があります。

## 使用法 {#usage}

`cacheLife` を使用するには、`next.config.js` ファイルで [`dynamicIO` フラグ](/docs/app/api-reference/config/next-config-js/dynamicIO) を有効にします：

<Tabs>
<TabItem value="ts" label="TypeScript">

```ts title="next.config.ts" switcher
import type { NextConfig } from 'next'

const nextConfig: NextConfig = {
  experimental: {
    dynamicIO: true,
  },
}

export default nextConfig
```

</TabItem>
<TabItem value="js" label="JavaScript">

```js title="next.config.js" switcher
const nextConfig = {
  experimental: {
    dynamicIO: true,
  },
}

export default nextConfig
```

</TabItem>
</Tabs>

その後、関数やコンポーネントのスコープ内で `cacheLife` 関数をインポートして呼び出します：

<Tabs>
<TabItem value="tsx" label="TypeScript">

```tsx title="app/page.tsx" highlight={5} switcher
'use cache'
import { unstable_cacheLife as cacheLife } from 'next/cache'

export default async function Page() {
  cacheLife('hours')
  return <div>Page</div>
}
```

</TabItem>
<TabItem value="jsx" label="JavaScript">

```jsx title="app/page.js" highlight={5} switcher
'use cache'
import { unstable_cacheLife as cacheLife } from 'next/cache'

export default async function Page() {
  cacheLife('hours')
  return <div>Page</div>
}
```

</TabItem>
</Tabs>

## リファレンス {#reference}

### デフォルトのキャッシュプロファイル {#default-cache-profiles}

Next.js は、さまざまな時間スケールに基づいた名前付きキャッシュプロファイルを提供します。もし `use cache` ディレクティブと一緒に `cacheLife` 関数でキャッシュプロファイルを指定しない場合、Next.js は自動的に「default」キャッシュプロファイルを適用します。

ただし、`use cache` ディレクティブを使用する際は、常にキャッシュプロファイルを追加してキャッシングの動作を明確に定義することをお勧めします。

| **プロファイル** | **Stale** | **Revalidate** | **Expire**     | **説明**                                                                     |
| ---------------- | --------- | -------------- | -------------- | ---------------------------------------------------------------------------- |
| `default`        | undefined | 15 分          | INFINITE_CACHE | 頻繁な更新を必要としないコンテンツに適したデフォルトプロファイル             |
| `seconds`        | undefined | 1 秒           | 1 分           | ほぼリアルタイムでの更新を求める頻繁に変化するコンテンツに適したプロファイル |
| `minutes`        | 5 分      | 1 分           | 1 時間         | 1 時間以内に頻繁に更新されるコンテンツに適したプロファイル                   |
| `hours`          | 5 分      | 1 時間         | 1 日           | 毎日更新されるがわずかに古いままで問題ないコンテンツに適したプロファイル     |
| `days`           | 5 分      | 1 日           | 1 週           | 毎週更新されるが1日古くても問題ないコンテンツに適したプロファイル            |
| `weeks`          | 5 分      | 1 週           | 1 か月         | 毎月更新されるが1週間古くても問題ないコンテンツに適したプロファイル          |
| `max`            | 5 分      | 1 か月         | INFINITE_CACHE | 非常に安定しており、ほとんど更新を必要としないコンテンツに適したプロファイル |

キャッシュプロファイルを参照するために使用される文字列値自体には固有の意味はありません；代わりに、コード内のキャッシュされたコンテンツをより適切に理解し管理するためのセマンティックラベルとして機能します。

### カスタムキャッシュプロファイル {#custom-cache-profiles}

カスタムキャッシュプロファイルは、`next.config.ts` ファイルの [`cacheLife`](/docs/app/api-reference/config/next-config-js/cacheLife) オプションに追加することで設定できます。

キャッシュプロファイルは次のプロパティを含むオブジェクトです：

| **プロパティ** | **値**   | **説明**                                                                                                | **要件**                                               |
| -------------- | -------- | ------------------------------------------------------------------------------------------------------- | ------------------------------------------------------ |
| `stale`        | `number` | クライアントがサーバーを確認せずに値をキャッシュする期間。                                              | オプション                                             |
| `revalidate`   | `number` | キャッシュがサーバー上で更新される頻度；再検証中でも古い値が提供される可能性があります。                | オプション                                             |
| `expire`       | `number` | 動的フェッチに切り替わる前に値が古いままでいられる最大期間；`revalidate` よりも長くする必要があります。 | オプション - `revalidate` より長くする必要があります。 |

"stale" プロパティは、`staleTimes` 設定とは異なり、クライアント側のルーターキャッシュを具体的に制御します。`staleTimes` は動的データと静的データのすべてのインスタンスに影響を与えるグローバル設定である一方で、`cacheLife` 設定は関数やルート単位で「stale」時間を定義することができます。

> **Good to know**: 「stale」プロパティは `Cache-control: max-age` ヘッダーを設定しません。代わりに、クライアント側のルーターキャッシュを制御します。

## 例 {#examples}

### 再利用可能なキャッシュプロファイルの定義 {#defining-reusable-cache-profiles}

再利用可能なキャッシュプロファイルを `next.config.ts` ファイル内で定義することにより作成できます。使用ケースに合った名前を選び、`stale`、`revalidate`、`expire` プロパティの値を設定します。必要に応じて、必要なだけ多くのカスタムキャッシュプロファイルを作成できます。各プロファイルは、`cacheLife` 関数に文字列値としてその名前で参照できます。

<Tabs>
<TabItem value="ts" label="TypeScript">

```ts title="next.config.ts" switcher
import type { NextConfig } from 'next'

const nextConfig: NextConfig = {
  experimental: {
    dynamicIO: true,
    cacheLife: {
      biweekly: {
        stale: 60 * 60 * 24 * 14, // 14 days
        revalidate: 60 * 60 * 24, // 1 day
        expire: 60 * 60 * 24 * 14, // 14 days
      },
    },
  },
}

module.exports = nextConfig
```

</TabItem>
<TabItem value="js" label="JavaScript">

```js title="next.config.js" switcher
const nextConfig = {
  experimental: {
    dynamicIO: true,
    cacheLife: {
      biweekly: {
        stale: 60 * 60 * 24 * 14, // 14 days
        revalidate: 60 * 60 * 24, // 1 day
        expire: 60 * 60 * 24 * 14, // 14 days
      },
    },
  },
}

module.exports = nextConfig
```

</TabItem>
</Tabs>

上記の例では、キャッシュは14日間保持され、毎日更新をチェックし、14日後にキャッシュが期限切れになります。このプロファイルをアプリケーション全体で名前で参照できます：

```tsx title="app/page.tsx" highlight={5}
'use cache'
import { unstable_cacheLife as cacheLife } from 'next/cache'

export default async function Page() {
  cacheLife('biweekly')
  return <div>Page</div>
}
```

### デフォルトのキャッシュプロファイルの上書き {#overriding-the-default-cache-profiles}

デフォルトのキャッシュプロファイルは、キャッシュ可能な出力のどの部分がどのくらい新鮮かまたは古いかを考えるための有益な方法を提供しますが、アプリケーションのキャッシング戦略により適した異なる名前付きプロファイルを好むかもしれません。

デフォルトの名前付きキャッシュプロファイルを上書きするには、デフォルトと同じ名前の新しい構成を作成します。

以下は、デフォルトの「days」キャッシュプロファイルを上書きする方法を示しています：

```ts title="next.config.ts"
const nextConfig = {
  experimental: {
    dynamicIO: true,
    cacheLife: {
      days: {
        stale: 3600, // 1 hour
        revalidate: 900, // 15 minutes
        expire: 86400, // 1 day
      },
    },
  },
}

module.exports = nextConfig
```

### インラインでのキャッシュプロファイルの定義 {#defining-cache-profiles-inline}

特定のユースケースの場合、`cacheLife` 関数にオブジェクトを渡すことでカスタムキャッシュプロファイルを設定できます：

<Tabs>
<TabItem value="tsx" label="TypeScript">

```tsx title="app/page.tsx" highlight={5-9} switcher
'use cache'
import { unstable_cacheLife as cacheLife } from 'next/cache'

export default async function Page() {
  cacheLife({
    stale: 3600, // 1 hour
    revalidate: 900, // 15 minutes
    expire: 86400, // 1 day
  })

  return <div>Page</div>
}
```

</TabItem>
<TabItem value="jsx" label="JavaScript">

```jsx title="app/page.js" highlight={5-9} switcher
'use cache'
import { unstable_cacheLife as cacheLife } from 'next/cache'

export default async function Page() {
  cacheLife({
    stale: 3600, // 1 hour
    revalidate: 900, // 15 minutes
    expire: 86400, // 1 day
  })

  return <div>Page</div>
}
```

</TabItem>
</Tabs>

このインラインキャッシュプロファイルは、作成された関数やファイルにのみ適用されます。アプリケーション全体で同じプロファイルを再利用したい場合は、[`cacheLife` プロパティに設定を追加してください](#defining-reusable-cache-profiles)。

### `use cache` と `cacheLife` のネストされた使用法 {#nested-usage-of-use-cache-and-cachelife}

同じルートやコンポーネントツリーで複数のキャッシング動作を定義する際、内部キャッシュが独自の `cacheLife` プロファイルを指定している場合、外部キャッシュはそれらの中で最も短いキャッシュ期間を尊重します。**これは、外部キャッシュが独自の明示的な `cacheLife` プロファイルを定義していない場合にのみ適用されます。**

例えば、ページに `use cache` ディレクティブを追加した場合、キャッシュプロファイルを指定しないとデフォルトのキャッシュプロファイルが暗黙的に適用されます（`cacheLife("default")`）。このページにインポートされたコンポーネントが独自のキャッシュプロファイルを持つ `use cache` ディレクティブを使用している場合、外部と内部のキャッシュプロファイルが比較され、プロファイルで設定された最短期間が適用されます。

```tsx title="app/components/parent.tsx" highlight={5,6}
// Parent component
import { unstable_cacheLife as cacheLife } from 'next/cache'
import { ChildComponent } from './child'

export async function ParentComponent() {
  'use cache'
  cacheLife('days')

  return (
    <div>
      <ChildComponent />
    </div>
  )
}
```

そして、別のファイルでインポートされた Child コンポーネントを定義します：

```tsx title="app/components/child.tsx" highlight={4,5}
// Child component
import { unstable_cacheLife as cacheLife } from 'next/cache'

export async function ChildComponent() {
  'use cache'
  cacheLife('hours')
  return <div>Child Content</div>

  // このコンポーネントのキャッシュはより短い 'hours' プロファイルを尊重します
}
```
